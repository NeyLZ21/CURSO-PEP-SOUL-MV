<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Acceso ‚Ä¢ HV Inducci√≥n</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- Preconnect para Firebase Auth (m√°s r√°pido) -->
<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://securetoken.googleapis.com">

<style>
:root{--brand:#781C38;--ink:#111827;--muted:#6b7280;--bg:#f8fafc;--card:#fff}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:760px;margin:auto;padding:24px}
h1{margin:0 0 10px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff}
.btn-muted{background:#e5e7eb;color:#111827}
.input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px}
.small{font-size:12px;color:var(--muted)}
.tabs .btn{padding:8px 12px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:#eef2ff;color:#3730a3}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;cursor:pointer}
.input-wrap{position:relative}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="container">
  <h1>Acceso</h1>
  <p class="small">Primero validamos si el correo existe. Si existe, probamos la contrase√±a.</p>

  <div class="card">
    <div class="row tabs" style="margin-bottom:8px">
      <button id="tab-login" class="btn btn-primary" type="button">Iniciar sesi√≥n</button>
      <button id="tab-register" class="btn btn-muted" type="button">Registrarme</button>
    </div>

    <!-- LOGIN -->
    <section id="view-login" class="grid">
      <label>Correo electr√≥nico
        <input id="login-email" type="email" class="input" placeholder="usuario@dominio.com" autocomplete="username email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="login-pass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <button class="eye" type="button" data-eye="#login-pass">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-login" class="btn btn-primary" type="button">Confirmar</button>
        <button id="btn-reset" class="btn btn-muted" type="button">Restablecer contrase√±a</button>
      </div>
      <div id="login-msg" class="small" style="min-height:18px"></div>
    </section>

    <!-- REGISTRO -->
    <section id="view-register" class="grid hidden">
      <label>Correo electr√≥nico
        <input id="reg-email" type="email" class="input" placeholder="usuario@dominio.com" autocomplete="email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="reg-pass" type="password" class="input" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass">üëÅÔ∏è</button>
        </div>
      </label>
      <label>Confirmar contrase√±a
        <div class="input-wrap">
          <input id="reg-pass2" type="password" class="input" placeholder="Repite la contrase√±a" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass2">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-register" class="btn btn-primary" type="button">Crear cuenta</button>
      </div>
      <div id="reg-msg" class="small" style="min-height:18px"></div>

      <div id="verify-box" class="hidden" style="margin-top:10px">
        <div class="badge">Verificaci√≥n requerida</div>
        <p class="small">Te enviamos un email para verificar tu cuenta. Revisa Spam si no lo ves.</p>
        <div class="row">
          <button id="btn-check-verify" class="btn btn-primary" type="button">Ya verifiqu√© mi correo</button>
          <button id="btn-resend-verify" class="btn btn-muted" type="button">Reenviar verificaci√≥n</button>
        </div>
        <div id="verify-msg" class="small" style="min-height:18px"></div>
      </div>
    </section>
  </div>

  <div class="row" style="margin-top:12px">
    <span id="whoami" class="small"></span>
    <button id="btn-logout" class="btn btn-muted hidden" type="button">Cerrar sesi√≥n</button>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
const setMsg = (el, t) => { el.textContent = t || ''; };

/* ========= Tabs & ojitos ========= */
function show(tab){
  $('#view-login').classList.toggle('hidden', tab!=='login');
  $('#view-register').classList.toggle('hidden', tab!=='register');
  $('#tab-login').classList.toggle('btn-primary', tab==='login');
  $('#tab-login').classList.toggle('btn-muted',   tab!=='login');
  $('#tab-register').classList.toggle('btn-primary', tab==='register');
  $('#tab-register').classList.toggle('btn-muted',   tab!=='register');
}
$('#tab-login').onclick=()=>show('login');
$('#tab-register').onclick=()=>show('register');
show('login');

document.querySelectorAll('.eye').forEach(b=>{
  b.addEventListener('click', ()=>{
    const inp=document.querySelector(b.dataset.eye);
    if(!inp) return;
    inp.type = inp.type==='password' ? 'text' : 'password';
  });
});

/* ========= Estado de sesi√≥n (solo UI) ========= */
auth.onAuthStateChanged(user=>{
  if(user){
    $('#whoami').textContent = `Sesi√≥n: ${user.email} ${user.emailVerified ? '(verificado)' : '(sin verificar)'}`;
    $('#btn-logout').classList.remove('hidden');
  }else{
    $('#whoami').textContent = '';
    $('#btn-logout').classList.add('hidden');
  }
});

/* ========= LOGIN (correo ‚Üí contrase√±a, con fallback) ========= */
$('#btn-login').addEventListener('click', async ()=>{
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const pass  = ($('#login-pass').value||'').trim();
  const msgEl = $('#login-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.');
  if(!pass)          return setMsg(msgEl,'Ingresa tu contrase√±a.');

  $('#btn-login').disabled = true; setMsg(msgEl,'Verificando correo‚Ä¶');

  try{
    let methods = null;
    try { methods = await auth.fetchSignInMethodsForEmail(email); }
    catch(e){ methods = null; console.warn('fetchSignInMethods error', e?.code||e); }

    // Si la cuenta existe con password ‚Üí validamos la contrase√±a
    if (methods && methods.includes('password')){
      setMsg(msgEl,'Validando contrase√±a‚Ä¶');
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        setMsg(msgEl,'Sesi√≥n iniciada.');
        return;
      }catch(e){
        if (['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e.code))
          return setMsg(msgEl,'Contrase√±a incorrecta.');
        if (e.code==='auth/too-many-requests')  return setMsg(msgEl,'Demasiados intentos. Intenta m√°s tarde.');
        if (e.code==='auth/network-request-failed') return setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.');
        return setMsg(msgEl,'Error: '+(e.message||''));
      }
    }

    // Existe, pero no con password (Google/Apple)
    if (methods && methods.length && !methods.includes('password')){
      const provs = methods.map(p=>({ 'google.com':'Google','facebook.com':'Facebook','apple.com':'Apple','microsoft.com':'Microsoft' }[p]||p)).join(', ');
      return setMsg(msgEl, `Este correo est√° registrado con: ${provs}. Inicia sesi√≥n con ese m√©todo.`);
    }

    // Fallback: si no qued√≥ claro, probamos el login para distinguir
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      setMsg(msgEl,'Sesi√≥n iniciada.');
    }catch(e2){
      if (e2.code==='auth/user-not-found') return setMsg(msgEl,'Correo no registrado.');
      if (['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e2.code))
        return setMsg(msgEl,'Contrase√±a incorrecta.');
      if (e2.code==='auth/too-many-requests')  return setMsg(msgEl,'Demasiados intentos. Intenta m√°s tarde.');
      if (e2.code==='auth/network-request-failed') return setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.');
      setMsg(msgEl,'Error: '+(e2.message||''));
    }
  } finally {
    $('#btn-login').disabled = false;
  }
});

/* ========= RESET contrase√±a ========= */
$('#btn-reset').addEventListener('click', async ()=>{
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const msgEl = $('#login-msg');
  if(!emailOk(email)) return setMsg(msgEl,'Escribe un correo v√°lido.');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(!methods || methods.length===0) return setMsg(msgEl,'Correo no registrado.');
    await auth.sendPasswordResetEmail(email);
    setMsg(msgEl,'Te enviamos un correo para restablecer la contrase√±a.');
  }catch(e){
    setMsg(msgEl,'No se pudo enviar: ' + (e.message||''));
  }
});

/* ========= REGISTRO ========= */
$('#btn-register').addEventListener('click', async ()=>{
  const email = ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  const msgEl = $('#reg-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.');
  if(pass.length<6)   return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).');
  if(pass!==pass2)    return setMsg(msgEl,'Las contrase√±as no coinciden.');

  $('#btn-register').disabled = true; setMsg(msgEl,'Creando cuenta‚Ä¶');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if (methods && methods.length) return setMsg(msgEl,'Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');

    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    try{
      await cred.user.sendEmailVerification({
        url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
        handleCodeInApp:false
      });
      setMsg(msgEl,'Cuenta creada. Te enviamos el correo de verificaci√≥n.');
    }catch(_){
      setMsg(msgEl,'Cuenta creada. No se pudo enviar el correo autom√°ticamente, intenta ‚ÄúReenviar verificaci√≥n‚Äù.');
    }
    $('#verify-box').classList.remove('hidden');
  }catch(e){
    if (e.code==='auth/email-already-in-use') return setMsg(msgEl,'Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
    if (e.code==='auth/weak-password')        return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).');
    setMsg(msgEl,'No se pudo registrar: ' + (e.message||''));
  } finally {
    $('#btn-register').disabled = false;
  }
});

/* ========= Verificaci√≥n: Ya verifiqu√© / Reenviar ========= */
$('#btn-check-verify').addEventListener('click', async ()=>{
  const boxMsg=$('#verify-msg');
  try{
    if(!auth.currentUser) return setMsg(boxMsg,'Primero inicia sesi√≥n o reg√≠strate.');
    await auth.currentUser.reload();
    if(auth.currentUser.emailVerified){
      setMsg(boxMsg,'‚úÖ Correo verificado.');
    }else{
      setMsg(boxMsg,'Tu correo a√∫n no aparece verificado. Revisa tu bandeja o reenv√≠a el enlace.');
    }
  }catch(e){ setMsg(boxMsg,'Error: '+(e.message||'')); }
});
$('#btn-resend-verify').addEventListener('click', async ()=>{
  const boxMsg=$('#verify-msg');
  try{
    if(!auth.currentUser) return setMsg(boxMsg,'Primero inicia sesi√≥n o reg√≠strate.');
    await auth.currentUser.sendEmailVerification({
      url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
      handleCodeInApp:false
    });
    setMsg(boxMsg,'Te reenviamos el correo (revisa Spam).');
  }catch(e){ setMsg(boxMsg,'No se pudo reenviar: '+(e.message||'')); }
});

/* ========= Logout ========= */
$('#btn-logout').addEventListener('click', async ()=>{
  try{ await auth.signOut(); }catch(_){}
});
</script>
</body>
</html>
