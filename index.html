<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Acceso ‚Ä¢ HV Inducci√≥n</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://securetoken.googleapis.com">

<style>
:root{--brand:#781C38;--ink:#111827;--muted:#6b7280;--bg:#f8fafc;--card:#fff;--bd:#e5e7eb;--ok:#15803d}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:760px;margin:auto;padding:24px}
h1{margin:0 0 8px}
p.small{margin:0 0 14px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff}
.btn-muted{background:#e5e7eb;color:#111827}
.btn:disabled{opacity:.6;cursor:not-allowed}
.input{width:100%;padding:12px;border:1px solid var(--bd);border-radius:12px}
.small{font-size:12px;color:var(--muted)}
.tabs .btn{padding:8px 12px}
.input-wrap{position:relative}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;cursor:pointer}
.hidden{display:none !important}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:600}
.ok{color:var(--ok)} .err{color:#b91c1c}
#version{position:fixed;right:10px;bottom:10px;font-size:12px;color:#6b7280;background:#fff;border:1px dashed #e5e7eb;border-radius:10px;padding:4px 8px}

/* Encabezado de perfil */
#header{margin-top:12px}
#whoami .line1{font-weight:800}
#whoami .line2{margin-top:2px}
#whoami .pill{display:inline-block;border:1px solid var(--bd);border-radius:999px;padding:4px 10px;margin-right:6px;background:#fff}
#btn-edit-profile{margin-left:auto}
</style>
</head>
<body>
<div class="container">
  <h1>Acceso</h1>
  <p class="small">Login con mensaje espec√≠fico: indica si el correo no existe o si la contrase√±a es incorrecta.</p>

  <div class="card">
    <div class="row tabs" style="margin-bottom:8px">
      <button id="tab-login" class="btn btn-primary" type="button">Iniciar sesi√≥n</button>
      <button id="tab-register" class="btn btn-muted" type="button">Registrarme</button>
    </div>

    <!-- LOGIN -->
    <section id="view-login" class="grid">
      <label>Correo electr√≥nico
        <input id="login-email" type="email" class="input" placeholder="usuario@dominio.com"
               autocomplete="username" name="username" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="login-pass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <button class="eye" type="button" data-eye="#login-pass" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-login" class="btn btn-primary" type="button">Confirmar</button>
        <button id="btn-reset" class="btn btn-muted" type="button">Restablecer contrase√±a</button>
      </div>
      <div id="login-msg" class="small" style="min-height:18px"></div>
    </section>

    <!-- REGISTRO -->
    <section id="view-register" class="grid hidden">
      <label>Correo electr√≥nico
        <input id="reg-email" type="email" class="input" placeholder="usuario@dominio.com"
               autocomplete="email" name="email" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="reg-pass" type="password" class="input" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <label>Confirmar contrase√±a
        <div class="input-wrap">
          <input id="reg-pass2" type="password" class="input" placeholder="Repite la contrase√±a" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass2" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-register" class="btn btn-primary" type="button">Crear cuenta</button>
      </div>
      <div id="reg-msg" class="small" style="min-height:18px"></div>

      <div id="verify-box" class="hidden" style="margin-top:10px">
        <p class="small">Te enviamos un email para <strong>verificar tu cuenta</strong> (revisa Spam).</p>
        <div class="row">
          <button id="btn-check-verify" class="btn btn-primary" type="button">Ya verifiqu√©</button>
          <button id="btn-resend-verify" class="btn btn-muted" type="button">Reenviar verificaci√≥n</button>
        </div>
        <div id="verify-msg" class="small" style="min-height:18px"></div>
      </div>
    </section>
  </div>

  <!-- ENCABEZADO DE SESI√ìN + PERFIL -->
  <div id="header" class="row">
    <div id="whoami" class="small" style="flex:1"></div>
    <button id="btn-edit-profile" class="btn btn-muted hidden" type="button">Modificar</button>
    <button id="btn-logout" class="btn btn-muted hidden" type="button">Cerrar sesi√≥n</button>
  </div>

  <!-- FORMULARIO PERFIL (aparece al primer ingreso o al pulsar Modificar) -->
  <div id="profile-card" class="card hidden" style="margin-top:12px">
    <h3 style="margin:0 0 8px">Perfil</h3>
    <div id="profile-view" class="grid hidden">
      <div><strong id="pf-nombre"></strong></div>
      <div class="small"><span id="pf-cedula"></span> ‚Ä¢ <span id="pf-esp"></span></div>
    </div>

    <div id="profile-edit" class="grid">
      <label>Nombre completo
        <input id="in-nombre" type="text" class="input" placeholder="Apellidos Nombres" autocomplete="name" />
      </label>
      <label>C√©dula
        <input id="in-cedula" type="text" class="input" placeholder="10 d√≠gitos" inputmode="numeric" maxlength="10" />
      </label>
      <label>Especialidad
        <input id="in-esp" type="text" class="input" placeholder="Ej. Medicina Interna" list="esp-list" />
        <datalist id="esp-list">
          <option>Medicina Interna</option>
          <option>Pediatr√≠a</option>
          <option>Ginecolog√≠a y Obstetricia</option>
          <option>Cirug√≠a General</option>
          <option>Emergenciolog√≠a</option>
          <option>Traumatolog√≠a</option>
          <option>Anestesiolog√≠a</option>
          <option>Oftalmolog√≠a</option>
          <option>Otorrinolaringolog√≠a</option>
          <option>Urolog√≠a</option>
        </datalist>
      </label>
      <div class="row">
        <button id="btn-save-profile" class="btn btn-primary" type="button">Guardar</button>
        <button id="btn-cancel-profile" class="btn btn-muted" type="button">Cancelar</button>
      </div>
      <div id="profile-msg" class="small" style="min-height:18px"></div>
    </div>
  </div>
</div>

<div id="version">HVQ v0812e</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// =================== MARCA DE CONSTRUCCI√ìN ===================
console.log('BUILD: hvq-login v0812e');

// =================== Firebase ===================
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
auth.languageCode = 'es';
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

// =================== Utils UI ===================
const $ = s => document.querySelector(s);
const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
const setMsg = (el, t, cls) => { el.classList.remove('ok','err'); if(cls) el.classList.add(cls); el.textContent = t||''; };
const trim1 = s => (s||'').replace(/\s+/g,' ').trim();

// Validador de c√©dula ecuatoriana (10 d√≠gitos)
function cedulaEcOk(c){
  c = (c||'').replace(/\D/g,'');
  if(!/^\d{10}$/.test(c)) return false;
  const prov = parseInt(c.slice(0,2),10);
  if(!(prov>=1 && prov<=24) && prov!==30) return false; // 30: extranjero
  const tercer = parseInt(c[2],10);
  if(tercer>=6) return false;
  let suma=0;
  for(let i=0;i<9;i++){
    let n=parseInt(c[i],10);
    if(i%2===0){ n*=2; if(n>9) n-=9; }
    suma+=n;
  }
  const verif=(10-(suma%10))%10;
  return verif===parseInt(c[9],10);
}

// =================== Tabs y ojitos ===================
function show(tab){
  $('#view-login').classList.toggle('hidden', tab!=='login');
  $('#view-register').classList.toggle('hidden', tab!=='register');
  $('#tab-login').classList.toggle('btn-primary', tab==='login');
  $('#tab-login').classList.toggle('btn-muted',   tab!=='login');
  $('#tab-register').classList.toggle('btn-primary', tab==='register');
  $('#tab-register').classList.toggle('btn-muted',   tab!=='register');
}
$('#tab-login').onclick=()=>show('login');
$('#tab-register').onclick=()=>show('register');
show('login');
document.querySelectorAll('.eye').forEach(b=>b.addEventListener('click',()=>{
  const i=document.querySelector(b.dataset.eye); if(i) i.type = i.type==='password' ? 'text':'password';
}));

// =================== Estado de sesi√≥n + Perfil (UI) ===================
async function loadProfile(user){
  try{
    const ref = db.collection('users').doc(user.uid);
    const snap = await ref.get();
    const profile = snap.exists ? snap.data() : null;
    renderHeader(user, profile);
    // Mostrar formulario si perfil no est√° completo
    const incomplete = !profile || !profile.nombre || !profile.cedula || !profile.especialidad;
    toggleProfileEditor(incomplete, profile);
  }catch(e){
    console.warn('Error cargando perfil:', e);
    renderHeader(user, null);
    toggleProfileEditor(true, null);
  }
}

function renderHeader(user, profile){
  const w = $('#whoami');
  const editBtn = $('#btn-edit-profile');
  if(user){
    const verif = user.emailVerified ? '<span class="ok">(verificado)</span>' : '<span class="err">(sin verificar)</span>';
    const nombre = profile?.nombre ? `<span class="pill">${profile.nombre}</span>` : '';
    const cedula = profile?.cedula ? `<span class="pill">C√©dula: ${profile.cedula}</span>` : '';
    const esp    = profile?.especialidad ? `<span class="pill">${profile.especialidad}</span>` : '';
    w.innerHTML =
      `<div class="line1">Sesi√≥n: <span class="badge">${user.email}</span> ${verif}</div>
       <div class="line2">${nombre}${cedula}${esp}</div>`;
    $('#btn-logout').classList.remove('hidden');
    editBtn.classList.remove('hidden');
  }else{
    w.textContent='';
    $('#btn-logout').classList.add('hidden');
    $('#btn-edit-profile').classList.add('hidden');
  }
}

function toggleProfileEditor(editing, profile){
  const card = $('#profile-card');
  const v    = $('#profile-view');
  const e    = $('#profile-edit');

  if(editing){
    card.classList.remove('hidden');
    v.classList.add('hidden');
    e.classList.remove('hidden');
    // Prefill
    $('#in-nombre').value = profile?.nombre || '';
    $('#in-cedula').value = profile?.cedula || '';
    $('#in-esp').value    = profile?.especialidad || '';
    setMsg($('#profile-msg'),'Completa tu perfil para continuar.','');
  }else{
    // Mostrar resumen
    card.classList.remove('hidden');
    v.classList.remove('hidden');
    e.classList.add('hidden');
    $('#pf-nombre').textContent = profile?.nombre || '';
    $('#pf-cedula').textContent = profile?.cedula ? `C√©dula: ${profile.cedula}` : '';
    $('#pf-esp').textContent    = profile?.especialidad || '';
    setMsg($('#profile-msg'),'','');
  }
}

// Bot√≥n Modificar del encabezado
$('#btn-edit-profile').onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    const snap = await db.collection('users').doc(user.uid).get();
    const profile = snap.exists ? snap.data() : null;
    toggleProfileEditor(true, profile);
  }catch(_){
    toggleProfileEditor(true, null);
  }
};

// Guardar perfil
$('#btn-save-profile').onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const msg = $('#profile-msg');

  const nombre = trim1($('#in-nombre').value);
  const cedula = ($('#in-cedula').value||'').replace(/\D/g,'');
  const esp    = trim1($('#in-esp').value);

  if(nombre.length < 5) return setMsg(msg,'Escribe tu nombre completo.','err');
  if(!cedulaEcOk(cedula)) return setMsg(msg,'C√©dula inv√°lida. Verifica los 10 d√≠gitos.','err');
  if(esp.length < 3) return setMsg(msg,'Indica tu especialidad.','err');

  const btn = $('#btn-save-profile');
  btn.disabled = true; setMsg(msg,'Guardando‚Ä¶');
  try{
    await db.collection('users').doc(user.uid).set({
      email: user.email,
      nombre, cedula, especialidad: esp,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    const profile = { nombre, cedula, especialidad: esp };
    renderHeader(user, profile);
    toggleProfileEditor(false, profile);
    setMsg(msg,'Perfil guardado.','ok');
  }catch(e){
    console.warn('Guardar perfil error:', e);
    setMsg(msg,'No se pudo guardar: '+(e.message||''),'err');
  }finally{
    btn.disabled = false;
  }
};

// Cancelar edici√≥n
$('#btn-cancel-profile').onclick = async ()=>{
  const user = auth.currentUser;
  if(!user){ $('#profile-card').classList.add('hidden'); return; }
  try{
    const snap = await db.collection('users').doc(user.uid).get();
    const profile = snap.exists ? snap.data() : null;
    if(!profile || !profile.nombre || !profile.cedula || !profile.especialidad){
      // Si est√° incompleto, mantenemos el editor visible
      setMsg($('#profile-msg'),'Para continuar, completa tu perfil.','err');
      return;
    }
    toggleProfileEditor(false, profile);
  }catch(_){
    setMsg($('#profile-msg'),'Para continuar, completa tu perfil.','err');
  }
};

// =================== onAuthStateChanged ===================
auth.onAuthStateChanged(user=>{
  if(user){
    renderHeader(user, null);
    $('#btn-logout').classList.remove('hidden');
    loadProfile(user);
  }else{
    renderHeader(null, null);
    $('#profile-card').classList.add('hidden');
  }
});

// =================== LOGIN (con enumeraci√≥n expl√≠cita) ===================
async function handleLogin(){
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const pass  = ($('#login-pass').value||'').trim();
  const msgEl = $('#login-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.','err');
  if(!pass)          return setMsg(msgEl,'Ingresa tu contrase√±a.','err');

  const btn = $('#btn-login');
  btn.disabled = true; setMsg(msgEl,'Validando‚Ä¶');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if (!methods || methods.length === 0){
      setMsg(msgEl,'Correo no registrado.','err');
      return;
    }
    if (!methods.includes('password')){
      setMsg(msgEl,'Esta cuenta no usa contrase√±a. Inicia sesi√≥n con: ' + methods.join(', ') + '.','err');
      return;
    }

    await auth.signInWithEmailAndPassword(email, pass);
    setMsg(msgEl,'Sesi√≥n iniciada.','ok');
    // Al iniciar sesi√≥n, onAuthStateChanged llamar√° a loadProfile() y, si falta, pedir√° el perfil.
    // location.href = './modulos/index.html';
  }catch(e){
    if (e.code === 'auth/wrong-password' ||
        e.code === 'auth/invalid-credential' ||
        e.code === 'auth/invalid-login-credentials'){
      setMsg(msgEl,'Contrase√±a incorrecta.','err');
    }
    else if (e.code === 'auth/user-disabled'){
      setMsg(msgEl,'La cuenta est√° deshabilitada. Contacta al administrador.','err');
    }
    else if (e.code === 'auth/network-request-failed'){
      setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.','err');
    }
    else if (e.code === 'auth/too-many-requests'){
      setMsg(msgEl,'Demasiados intentos. Intenta m√°s tarde.','err');
    }
    else{
      setMsg(msgEl,'Error: '+(e.message||''),'err');
    }
  } finally {
    btn.disabled = false;
  }
}
$('#btn-login').addEventListener('click', handleLogin);
document.querySelector('#view-login').addEventListener('keydown', e=>{
  if(e.key==='Enter') { e.preventDefault(); handleLogin(); }
});

// =================== RESET (sin revelar existencia) ===================
$('#btn-reset').addEventListener('click', async ()=>{
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const msgEl = $('#login-msg');
  if(!emailOk(email)) return setMsg(msgEl,'Escribe un correo v√°lido.','err');
  try{
    await auth.sendPasswordResetEmail(email);
    setMsg(msgEl,'Si la cuenta existe, te enviaremos un correo para restablecer la contrase√±a.','ok');
  }catch(e){
    if (e.code==='auth/network-request-failed') setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.','err');
    else setMsg(msgEl,'No se pudo enviar: ' + (e.message||''),'err');
  }
});

// =================== REGISTRO (intenta crear y captura duplicado) ===================
async function handleRegister(){
  const email = ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  const msgEl = $('#reg-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.','err');
  if(pass.length<6)   return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).','err');
  if(pass!==pass2)    return setMsg(msgEl,'Las contrase√±as no coinciden.','err');

  const btn = $('#btn-register');
  btn.disabled = true; setMsg(msgEl,'Creando cuenta‚Ä¶');

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);

    // Enviar verificaci√≥n
    try{
      await cred.user.sendEmailVerification({
        url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
        handleCodeInApp:false
      });
      setMsg(msgEl,'Cuenta creada. Te enviamos el correo de verificaci√≥n.','ok');
    }catch(_){
      setMsg(msgEl,'Cuenta creada. No se pudo enviar autom√°ticamente. Usa ‚ÄúReenviar verificaci√≥n‚Äù.','err');
    }
    $('#verify-box').classList.remove('hidden');

    // Al estar ya autenticado, mostramos el editor de perfil de inmediato (primer ingreso)
    loadProfile(cred.user);
    show('login'); // opcional: volver al login
  }catch(e){
    if (e.code==='auth/email-already-in-use') return setMsg(msgEl,'Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.','err');
    if (e.code==='auth/weak-password')        return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).','err');
    if (e.code==='auth/invalid-email')        return setMsg(msgEl,'El correo no es v√°lido.','err');
    setMsg(msgEl,'No se pudo registrar: ' + (e.message||''),'err');
  } finally {
    btn.disabled = false;
  }
}
$('#btn-register').addEventListener('click', handleRegister);
document.querySelector('#view-register').addEventListener('keydown', e=>{
  if(e.key==='Enter') { e.preventDefault(); handleRegister(); }
});

// =================== Verificaci√≥n & Logout ===================
$('#btn-check-verify').onclick = async ()=>{
  const m=$('#verify-msg');
  try{ await auth.currentUser?.reload(); setMsg(m, auth.currentUser?.emailVerified ? '‚úÖ Verificado.' : 'A√∫n sin verificar.'); }
  catch(e){ setMsg(m,'Error: '+(e.message||''),'err'); }
};
$('#btn-resend-verify').onclick = async ()=>{
  const m=$('#verify-msg');
  try{ await auth.currentUser?.sendEmailVerification({url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',handleCodeInApp:false}); setMsg(m,'Enlace reenviado.','ok'); }
  catch(e){ setMsg(m,'No se pudo reenviar: '+(e.message||''),'err'); }
};
$('#btn-logout').onclick = ()=>auth.signOut().catch(()=>{});
</script>
</body>
</html>
