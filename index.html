<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a PEP-SOUL MV ‚Ä¢ Hospital Vozandes</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.lock{position:absolute;inset:0;display:grid;place-content:center;background:rgba(17,24,39,.65);color:#fff;font-weight:700;font-size:14px;border-radius:16px;backdrop-filter:blur(1px)}
.muted{color:var(--muted)}
.footer{margin-top:24px;color:var(--muted);font-size:13px}

/* Certificado */
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)}
.cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}

/* Inputs con ojito */
.input-wrap{position:relative}
.input-wrap input, .input-wrap select, input, select{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}

/* Avisos */
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}

/* Guardando‚Ä¶ */
.saving::after{content:'';display:inline-block;width:14px;height:14px;margin-left:8px;border:2px solid #9ca3af;border-top-color:transparent;border-radius:999px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Combo de especialidad */
.combo{position:relative}
.combo input{padding-right:36px}
.combo .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.combo .panel{position:absolute;z-index:20;left:0;right:0;max-height:280px;overflow:auto;background:#111827;color:#f9fafb;border-radius:12px;padding:6px 0;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none}
.combo .opt{padding:10px 12px;cursor:pointer}
.combo .opt:hover{background:#1f2937}
.combo.show .panel{display:block}

/* Quiz */
.quiz-wrap{margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px}
.quiz-hint{font-size:13px}

/* P√≥ster/lazy */
.poster{position:absolute;inset:0;background:#000;display:grid;place-items:center;cursor:pointer}
.poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.8)}
.poster button{position:relative;z-index:2;padding:10px 14px;border-radius:999px;background:#ffffffd9;font-weight:800;border:0}
.warnmsg{position:absolute;left:12px;right:12px;bottom:12px;background:#fff3cd;color:#7a5400;border-radius:10px;padding:8px 10px;font-size:13px;display:none}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HVQ</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Tu progreso queda guardado en la nube.</p>
        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" placeholder="usuario@dominio.com" required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb">Restablecer contrase√±a</button>
            </div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" placeholder="usuario@dominio.com" required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
          </div>

          <div id="auth-msg" class="muted" style="min-height:18px"></div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n. Conf√≠rmalo y vuelve a esta pantalla para continuar.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar la evaluaci√≥n</li>
          <li>Correo v√°lido y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Edita tus datos y guarda los cambios.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br><input id="pf-name" type="text" required></label>
      <label>C√©dula o Pasaporte<br><input id="pf-id" type="text" required></label>
      <label style="grid-column:1/-1">Especialidad<br>
        <div class="combo" id="spec-combo">
          <input id="pf-spec" type="text" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <span class="arrow">‚ñæ</span>
          <div class="panel" id="spec-panel"></div>
        </div>
        <small class="muted">Selecciona de la lista. Esto define los m√≥dulos que ver√°s.</small>
      </label>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-edit-profile" class="btn btn-muted">Modificar</button>
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div><strong>Progreso del curso</strong><div class="muted" id="progress-label">0% completado</div></div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ==== listas, m√≥dulos y videos (igual que antes) ==== */
const ESPECIALIDADES=[ "ACUPUNTURA","ALERGOLOGIA","ANESTESIOLOGIA","CARDIOLOGIA","CARDIOLOGIA HEMODINAMIA","CARDIOLOGIA INTERVENCIONISTA","CARDIOLOGIA PEDIATRICA","CIR. GENERAL-COLOPROCTOLOGIA","CIR. MANO/MU√ëE-NERVIO PERI/BRA","CIRUGIA CARDIACA","CIRUGIA DE CABEZA Y CUELLO","CIRUGIA DE COLUMNA","CIRUGIA DE HOMBRO Y CODO","CIRUGIA GENERAL","CIRUGIA ONCOCOLOGICA","CIRUGIA PEDIATRICA","CIRUGIA PLASTICA","CIRUGIA TORACICA","CIRUGIA VASCULAR","COLOPROCTOLOGIA","CUIDADOS PALIATIVOS","DERMATOLOGIA","DIABETOLOGIA","EMERGENCIAS Y DESASTRES","ENDOCRINO PEDIATRA","ENDOCRINOLOGIA","ENFERMEDADES AUTOINMUNES","FISIATRIA","FONOAUDIOLOGIA","GASTROENTEROLOGIA","GASTROENTEROLOGIA PEDIATRICA","GENETICA MEDICA","GERIATRIA","GINECOLOGIA INFANTO JUVENIL","GINECOLOGIA ONCOCOLOGICA","GINECOLOGIA Y OBSTETRICIA","HEMATOLOGIA","HEMATOLOGO ONCOCOLOGO PEDIATRIA","HEPATOLOGIA","INFECTOLOGIA","INFECTOLOGIA PEDIATRICA","INTERVENCIONISMO","MASTOLOGIA","MAXILO FACIAL","MEDICINA CRITICA","MEDICINA CRITICA PEDIATRICA","MEDICINA DEL DEPORTE","MEDICINA FAMILIAR","MEDICINA FAMILIAR EMERGENCIA","MEDICINA GENERAL","MEDICINA INTERNA","MEDICINA MATERNO FETAL","MEDICINA PALIATIVA","MICROBIOLOGIA","NEFROLOGIA","NEFROLOGIA PEDIATRICA","NEONATOLOGIA","NEUMOLOGIA","NEUMOLOGIA PEDIATRICA","NEUROCIRUGIA","NEUROFISIOLOGIA CLINICA","NEUROLOGIA","NEUROLOGIA PEDIATRICA","NEUROPSICOLOGIA","NEURORADIOL INTERVENCIONISTA","NEURORADIOLOGIA","NUTRICION","ODONTOLOGIA","ODONTOPEDIATRIA","OFTALMOLOGIA","OFTALMOLOGIA PEDIATRICA","ONCOLOGIA CLINICA","OTORRINOLARINGOLOGIA","PATOLOGIA","PEDIATRIA","PSICOLOGIA","PSIQUIATRIA","RADIOLOGIA","RADIOLOGIA INTERVENCIONISTA","RADIOTERAPIA","RESIDENTE/INTERNO","REUMATOLOGIA","REUMATOLOGIA PEDIATRICA","SEXOLOGIA","TRATAMIENTO DEL DOLOR","TRAUMATO PEDIATRICA DE COLUMNA","TRAUMATOLOGIA DEL COLUMNA","TRAUMATOLOGIA ONCOLOGICA","TRAUMATOLOGIA PEDIATRICA","TRAUMATOLOGIA Y ORTOPEDIA","UROLOGIA","UROLOGIA PEDIATRICA" ];
const M={ CE:"CONSULTA EXTERNA", H:"HOSPITALIZACI√ìN-HDD", CQ:"CENTRO QUIR√öRGICO", G:"GENERALIDADES", AN:"ANESTESIOLOG√çA", EM:"EMERGENCIAS" };
const BASE_MEDICA=[M.G,M.H,M.CE], BASE_QUIR=[M.G,M.H,M.CE,M.CQ];
const ESPEC_MODS={ /* ‚Ä¶igual‚Ä¶ */ 
  "ACUPUNTURA":BASE_MEDICA,"ALERGOLOGIA":BASE_MEDICA,"ANESTESIOLOGIA":[M.G,M.AN],
  "CARDIOLOGIA":BASE_MEDICA,"CARDIOLOGIA HEMODINAMIA":BASE_MEDICA,"CARDIOLOGIA INTERVENCIONISTA":BASE_MEDICA,"CARDIOLOGIA PEDIATRICA":BASE_MEDICA,
  "CIR. GENERAL-COLOPROCTOLOGIA":BASE_QUIR,"CIR. MANO/MU√ëE-NERVIO PERI/BRA":BASE_QUIR,"CIRUGIA CARDIACA":BASE_QUIR,"CIRUGIA DE CABEZA Y CUELLO":BASE_QUIR,"CIRUGIA DE COLUMNA":BASE_QUIR,"CIRUGIA DE HOMBRO Y CODO":BASE_QUIR,"CIRUGIA GENERAL":BASE_QUIR,"CIRUGIA ONCOCOLOGICA":BASE_QUIR,"CIRUGIA PEDIATRICA":BASE_QUIR,"CIRUGIA PLASTICA":BASE_QUIR,"CIRUGIA TORACICA":BASE_QUIR,"CIRUGIA VASCULAR":BASE_QUIR,"COLOPROCTOLOGIA":BASE_QUIR,
  "CUIDADOS PALIATIVOS":BASE_MEDICA,"DERMATOLOGIA":BASE_MEDICA,"DIABETOLOGIA":BASE_MEDICA,
  "EMERGENCIAS Y DESASTRES":[M.G,M.EM],"ENDOCRINO PEDIATRA":BASE_MEDICA,"ENDOCRINOLOGIA":BASE_MEDICA,
  "ENFERMEDADES AUTOINMUNES":BASE_MEDICA,"FISIATRIA":BASE_MEDICA,"FONOAUDIOLOGIA":BASE_MEDICA,
  "GASTROENTEROLOGIA":BASE_QUIR,"GASTROENTEROLOGIA PEDIATRICA":BASE_QUIR,"GENETICA MEDICA":BASE_MEDICA,"GERIATRIA":BASE_MEDICA,
  "GINECOLOGIA INFANTO JUVENIL":BASE_QUIR,"GINECOLOGIA ONCOLOGICA":BASE_QUIR,"GINECOLOGIA Y OBSTETRICIA":BASE_QUIR,
  "HEMATOLOGIA":BASE_QUIR,"HEMATOLOGO ONCOCOLOGO PEDIATRIA":BASE_QUIR,"HEPATOLOGIA":BASE_MEDICA,
  "INFECTOLOGIA":BASE_MEDICA,"INFECTOLOGIA PEDIATRICA":BASE_MEDICA,"INTERVENCIONISMO":BASE_QUIR,"MASTOLOGIA":BASE_QUIR,"MAXILO FACIAL":BASE_QUIR,
  "MEDICINA CRITICA":BASE_MEDICA,"MEDICINA CRITICA PEDIATRICA":BASE_MEDICA,"MEDICINA DEL DEPORTE":BASE_MEDICA,"MEDICINA FAMILIAR":[M.G,M.CE],"MEDICINA FAMILIAR EMERGENCIA":[M.G,M.EM],
  "MEDICINA GENERAL":BASE_MEDICA,"MEDICINA INTERNA":BASE_MEDICA,"MEDICINA MATERNO FETAL":BASE_MEDICA,"MEDICINA PALIATIVA":BASE_MEDICA,"MICROBIOLOGIA":BASE_MEDICA,
  "NEFROLOGIA":BASE_MEDICA,"NEFROLOGIA PEDIATRICA":BASE_MEDICA,"NEONATOLOGIA":BASE_MEDICA,"NEUMOLOGIA":BASE_MEDICA,"NEUMOLOGIA PEDIATRICA":BASE_MEDICA,
  "NEUROCIRUGIA":BASE_QUIR,"NEUROFISIOLOGIA CLINICA":BASE_MEDICA,"NEUROLOGIA":BASE_QUIR,"NEUROLOGIA PEDIATRICA":BASE_QUIR,"NEUROPSICOLOGIA":BASE_MEDICA,"NEURORADIOL INTERVENCIONISTA":BASE_QUIR,"NEURORADIOLOGIA":BASE_QUIR,
  "NUTRICION":BASE_MEDICA,"ODONTOLOGIA":BASE_QUIR,"ODONTOPEDIATRIA":BASE_QUIR,
  "OFTALMOLOGIA":BASE_QUIR,"OFTALMOLOGIA PEDIATRICA":BASE_QUIR,"ONCOLOGIA CLINICA":BASE_QUIR,
  "OTORRINOLARINGOLOGIA":BASE_QUIR,"PATOLOGIA":BASE_MEDICA,"PEDIATRIA":BASE_MEDICA,"PSICOLOGIA":BASE_MEDICA,"PSIQUIATRIA":BASE_MEDICA,
  "RADIOLOGIA":BASE_QUIR,"RADIOLOGIA INTERVENCIONISTA":BASE_QUIR,"RADIOTERAPIA":BASE_QUIR,"RESIDENTE/INTERNO":BASE_QUIR,
  "REUMATOLOGIA":BASE_MEDICA,"REUMATOLOGIA PEDIATRICA":BASE_MEDICA,"SEXOLOGIA":BASE_MEDICA,
  "TRATAMIENTO DEL DOLOR":BASE_QUIR,"TRAUMATO PEDIATRICA DE COLUMNA":BASE_QUIR,"TRAUMATOLOGIA DEL COLUMNA":BASE_QUIR,
  "TRAUMATOLOGIA ONCOLOGICA":BASE_QUIR,"TRAUMATOLOGIA PEDIATRICA":BASE_QUIR,"TRAUMATOLOGIA Y ORTOPEDIA":BASE_QUIR,
  "UROLOGIA":BASE_QUIR,"UROLOGIA PEDIATRICA":BASE_QUIR
};
const VIDEO_DEFAULTS={ "GENERALIDADES":["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0"], "HOSPITALIZACI√ìN-HDD":["eY52Zsg-KVI","fJ9rUzIMcZQ","L_jWHffIx5E"], "CONSULTA EXTERNA":["kXYiU_JCYtU","hTWKbfoikeg","QH2-TGUlwu4"], "CENTRO QUIR√öRGICO":["3JZ_D3ELwOQ","04854XqcfCY","ktvTqknDobU"], "ANESTESIOLOG√çA":["60ItHLz5WEA","CevxZvSJLk8","ktvTqknDobU"], "EMERGENCIAS":["2vjPBrBU-TM","hTWKbfoikeg","lWA2pjMjpBs"] };
const DEFAULT_VIDEOS=["dQw4w9WgXcQ"];

/* ==== Firebase ==== */
const firebaseConfig={apiKey:"AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",authDomain:"induccion-pep-hvq.firebaseapp.com",projectId:"induccion-pep-hvq",storageBucket:"induccion-pep-hvq.firebasestorage.app",messagingSenderId:"651724182766",appId:"1:651724182766:web:4eec9be43e9e8e60dc0fff",measurementId:"G-Z62L1CCYP1"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
try{ firebase.firestore().enablePersistence({synchronizeTabs:true}).catch(()=>{});}catch(_){}
const db=firebase.firestore();

/* ==== estado / helpers ==== */
const $=s=>document.querySelector(s);
$('#year').textContent=new Date().getFullYear();
let CURRENT_UID=null;
const keyFor=(uid)=>`soulmv_${uid||'anon'}`;
const loadState=(uid)=>{try{return JSON.parse(localStorage.getItem(keyFor(uid))||'{}');}catch{return {}}};
const saveStateLocal=(uid,st)=>localStorage.setItem(keyFor(uid),JSON.stringify(st));
let state=loadState(null);
let unsubProfile=null;

/* ==== YouTube (sin cambios relevantes) ==== */
// ‚Ä¶ (id√©ntico a tu versi√≥n anterior) ‚Ä¶

/* ==== Auth ==== */
// ‚Ä¶ (id√©ntico a tu versi√≥n anterior para login/registro/reset) ‚Ä¶

/* ================= Vistas / Perfil ================= */
let readOnly=false; // control expl√≠cito

function setProfileReadonly(ro){
  readOnly=ro;
  ['pf-name','pf-id','pf-spec'].forEach(id=>{
    const el=document.getElementById(id);
    el.readOnly=ro;
    el.style.background=ro?'#eef2ff':'#fff';
  });
}
document.getElementById('btn-edit-profile').addEventListener('click',()=>{
  setProfileReadonly(false);
  $('#pf-help').textContent='Edita tus datos y guarda los cambios.';
});

function showCourse(){
  $('#step-welcome').style.display='none';
  $('#btn-logout').style.display='inline-flex';
  $('#profile').style.display='block';
  // arrancamos editable
  setProfileReadonly(false);

  $('#pf-name').value=state.profile?.name||auth.currentUser?.displayName||'';
  $('#pf-id').value=state.profile?.iddoc||'';
  $('#pf-spec').value=state.profile?.spec||'';

  renderAllBySpecialty(getSpec());
  updateGlobalProgress();
  startProfileRealtime();
  loadProfile().then(()=>{
    renderAllBySpecialty(getSpec());
    updateGlobalProgress();
  });
}
function getSpec(){ return (state.profile?.spec||'').trim(); }

/* realtime (no pisa si est√°s editando) */
function startProfileRealtime(){
  if(unsubProfile){ try{unsubProfile();}catch(_){ } }
  const uid=auth.currentUser?.uid; if(!uid) return;
  const ref=db.collection('users').doc(uid).collection('profile').doc('main');
  unsubProfile=ref.onSnapshot(s=>{
    if(!s.exists) return;
    const cloud=s.data()||{};
    state.profile={...(state.profile||{}),...cloud}; saveStateLocal(CURRENT_UID,state);
    if(readOnly){ // solo si est√°s en lectura
      $('#pf-name').value=state.profile?.name||'';
      $('#pf-id').value=state.profile?.iddoc||'';
      $('#pf-spec').value=state.profile?.spec||'';
    }
  });
}
async function loadProfile(){
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){ state.profile=s.data(); saveStateLocal(CURRENT_UID,state); }
  }catch{}
}

/* ===== Habilitar Guardar ante cambios ===== */
function enableSave(){ $('#btn-save-profile').disabled=false; $('#pf-msg').textContent=''; }
['pf-name','pf-id','pf-spec'].forEach(id=>{
  const el=document.getElementById(id);
  ['input','change','keydown','paste'].forEach(e=>el.addEventListener(e,enableSave));
});

/* ===== Guardar Perfil (siempre re-habilita el bot√≥n) ===== */
document.getElementById('btn-save-profile').addEventListener('click', saveProfile);

async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec=($('#pf-spec').value||'').trim();
  const btn=$('#btn-save-profile'); const pfMsg=$('#pf-msg');

  if(!name||!iddoc||!spec){ pfMsg.textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return; }
  if(!ESPECIALIDADES.includes(spec)){ pfMsg.textContent='Selecciona una especialidad v√°lida de la lista.'; return; }

  // guarda local inmediato
  state.profile={name,iddoc,spec}; saveStateLocal(CURRENT_UID,state);
  renderAllBySpecialty(spec); updateGlobalProgress();

  // UI de guardado
  btn.disabled=true; pfMsg.classList.add('saving'); pfMsg.textContent='Guardando‚Ä¶';

  // intento de nube con timeout suave
  const uid=auth.currentUser?.uid;
  const write = async ()=>{
    if(!uid) throw new Error('Sin UID');
    const ref=db.collection('users').doc(uid).collection('profile').doc('main');
    const payload={...state.profile,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    await ref.set(payload,{merge:true});
  };
  const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),10000));

  try{
    await Promise.race([write(), timeout]);
    pfMsg.classList.remove('saving'); pfMsg.textContent='‚úÖ Perfil guardado en la nube.';
  }catch(e){
    // no bloquees al usuario; queda local y puede reintentar
    pfMsg.classList.remove('saving');
    pfMsg.textContent='Guardado local. No se pudo sincronizar; reintenta m√°s tarde.';
  }finally{
    btn.disabled=false; // ‚úÖ siempre re-habilitado
  }
}

/* ====== Combo Especialidad (sin readOnly forzado) ====== */
(function specCombo(){
  const wrap=$('#spec-combo'), input=$('#pf-spec'), panel=$('#spec-panel');
  let filtered=[...ESPECIALIDADES], open=false, hover=-1;
  const render=(list)=>{ panel.innerHTML=''; list.forEach((name,i)=>{ const d=document.createElement('div'); d.className='opt'; d.textContent=name; d.dataset.i=i;
    d.addEventListener('mousedown',e=>{ e.preventDefault(); input.value=name; hide(); enableSave(); });
    d.addEventListener('mousemove',()=>{ hover=i; }); panel.appendChild(d); }); };
  const show=()=>{ if(readOnly) return; wrap.classList.add('show'); open=true; };
  const hide=()=>{ wrap.classList.remove('show'); open=false; hover=-1; };
  wrap.addEventListener('mousedown',()=>{ if(!open){ filtered=[...ESPECIALIDADES]; render(filtered); show(); } });
  input.addEventListener('focus',()=>{ if(!open){ filtered=[...ESPECIALIDADES]; render(filtered); show(); } });
  input.addEventListener('input',()=>{ const q=input.value.toLowerCase(); filtered=ESPECIALIDADES.filter(e=>e.toLowerCase().includes(q)); render(filtered); show(); });
  input.addEventListener('keydown',e=>{
    if(!open && (e.key==='ArrowDown'||e.key==='Enter')){ show(); e.preventDefault(); return; }
    if(!open) return;
    if(e.key==='ArrowDown'){ hover=Math.min((hover<0?0:hover+1),filtered.length-1); e.preventDefault(); panel.querySelector(`.opt[data-i="${hover}"]`)?.scrollIntoView({block:'nearest'}); }
    else if(e.key==='ArrowUp'){ hover=Math.max((hover<=0?0:hover-1),0); e.preventDefault(); panel.querySelector(`.opt[data-i="${hover}"]`)?.scrollIntoView({block:'nearest'}); }
    else if(e.key==='Enter'){ if(filtered.length){ input.value=filtered[Math.max(hover,0)]; hide(); enableSave(); e.preventDefault(); } }
    else if(e.key==='Escape'){ hide(); }
  });
  document.addEventListener('mousedown',(e)=>{ if(!wrap.contains(e.target)) hide(); });
  render(filtered);
})();

/* ===== m√≥dulos/quiz/progreso & sync (igual que antes) ===== */
// ‚Ä¶ (tu misma l√≥gica de render de m√≥dulos, quizzes y sync) ‚Ä¶

/* ==== onAuthStateChanged ==== */
auth.onAuthStateChanged(async user=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent=''; $('#btn-logout').style.display='none'; $('#verify-box').style.display='none';
    document.getElementById('step-welcome').style.display='block';
    document.getElementById('profile').style.display='none';
    return;
  }
  CURRENT_UID=user.uid; state=loadState(CURRENT_UID)||{}; $('#auth-user').textContent=user.email||'';
  await user.reload().catch(()=>{});
  if(!user.emailVerified){ document.getElementById('verify-box').style.display='block'; return; }
  document.getElementById('verify-box').style.display='none';
  showCourse();
});
document.getElementById('btn-logout').addEventListener('click', async ()=>{ await auth.signOut(); });
document.getElementById('year').textContent=new Date().getFullYear();
</script>
</body>
</html>
