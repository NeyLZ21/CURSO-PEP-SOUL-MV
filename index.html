<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)} .footer{margin-top:24px;color:var(--muted);font-size:13px}
small.note{color:var(--muted);font-size:12px}
/* Certificado */
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)} .cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}
/* Inputs con ojito */
.input-wrap{position:relative} .input-wrap input{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}
/* Avisos */
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
/* Spinner ‚ÄúGuardando‚Ä¶‚Äù */
.saving::after{content:''; display:inline-block; width:14px; height:14px; margin-left:8px; border:2px solid #9ca3af; border-top-color:transparent; border-radius:999px; animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Subvideos grid */
.videos-grid{display:grid;gap:12px}
@media (min-width:780px){.videos-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.video-item{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.video-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
.done-pill{background:#dcfce7;color:#065f46;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:700}
.pending-pill{background:#fee2e2;color:#991b1b;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:700}
.quiz-wrap{margin-top:12px;border-top:1px dashed #e5e7eb;padding-top:12px}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Te pediremos verificar el correo <strong>solo al registrarte</strong>. Tu progreso quedar√° guardado en la nube.</p>

        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" placeholder="usuario@dominio.com" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb" required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb">Restablecer contrase√±a</button>
            </div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" placeholder="usuario@dominio.com" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb" required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
          </div>

          <div id="auth-msg" class="muted" style="min-height:18px"></div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n. Conf√≠rmalo y vuelve a esta pantalla para continuar.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar los m√≥dulos requeridos por tu especialidad</li>
          <li>Correo v√°lido (cualquier dominio)</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>Especialidad<br>
        <input id="pf-spec" type="text" list="spec-list" placeholder="Escribe para buscar..." required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
        <datalist id="spec-list"></datalist>
        <small class="note">Selecciona de la lista. Esto define los m√≥dulos que ver√°s.</small>
      </label>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-edit-profile" class="btn btn-muted" style="display:none">Modificar</button>
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso global -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos por especialidad -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Certificado -->
  <section id="eval" class="card no-print" style="display:none;margin-top:16px">
    <h2 style="margin-top:0">Certificado</h2>
    <p class="muted">Se habilita cuando completes y apruebes <strong>todos</strong> los m√≥dulos requeridos por tu especialidad.</p>
    <div>
      <button id="btn-cert" class="btn btn-success" disabled>Emitir certificado</button>
    </div>
  </section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong> seg√∫n su especialidad.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ======= Definici√≥n de Especialidades ‚Üí M√≥dulos =======
   Ampl√≠a esta lista con tu Excel. Si una especialidad no aparece,
   no cargar√° m√≥dulos. */
const SPECIALTY_MODULES = {
  "ACUPUNTURA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ALERGOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ANESTESIOLOGIA": ["GENERALIDADES","ANESTESIOLOG√çA"],
  "CARDIOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "CARDIOLOGIA HEMODINAMIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  // üëá Agrega aqu√≠ el resto de filas de tu Excel
};

/* ======= Videos por m√≥dulo (5 IDs de prueba por m√≥dulo)
   Si un m√≥dulo no est√° en este banco, usar√° los gen√©ricos. */
const GENERIC_VIDEOS = ["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0","J---aiyznGQ","3GwjfUFyY6M"];
const MODULE_VIDEO_BANK = {
  "GENERALIDADES": ["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0","J---aiyznGQ","3GwjfUFyY6M"],
  "HOSPITALIZACI√ìN-HDD": ["9bZkp7q19f0","l482T0yNkeo","dQw4w9WgXcQ","J---aiyznGQ","3GwjfUFyY6M"],
  "CONSULTA EXTERNA": ["J---aiyznGQ","3GwjfUFyY6M","dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0"],
  "ANESTESIOLOG√çA": ["l482T0yNkeo","3GwjfUFyY6M","J---aiyznGQ","9bZkp7q19f0","dQw4w9WgXcQ"]
};

/* ======= Banco de preguntas por m√≥dulo (3 por demo) ======= */
const MODULE_QUIZ_BANK = {
  "GENERALIDADES":[
    {id:"g1",text:"¬øD√≥nde se verifica el perfil del m√©dico?",options:[{key:'A',label:'En Ajustes'},{key:'B',label:'En Mi perfil'},{key:'C',label:'En Auditor√≠a'}],correct:'B'},
    {id:"g2",text:"Para emitir certificado, debes:",options:[{key:'A',label:'Aprobar todos los m√≥dulos requeridos'},{key:'B',label:'Ver 1 video'},{key:'C',label:'Contactar TI'}],correct:'A'},
    {id:"g3",text:"¬øC√≥mo se guarda el progreso?",options:[{key:'A',label:'Solo local'},{key:'B',label:'Solo nube'},{key:'C',label:'Local y nube'}],correct:'C'}
  ],
  "HOSPITALIZACI√ìN-HDD":[
    {id:"h1",text:"Para cerrar nota cl√≠nica en HDD:",options:[{key:'A',label:'Guardar borrador'},{key:'B',label:'Finalizar documento'},{key:'C',label:'Imprimir sin cerrar'}],correct:'B'},
    {id:"h2",text:"Las √≥rdenes m√©dicas se registran en:",options:[{key:'A',label:'M√≥dulo de Prescripci√≥n'},{key:'B',label:'Im√°genes'},{key:'C',label:'Citas'}],correct:'A'},
    {id:"h3",text:"Auditor√≠a de honorarios valida contra:",options:[{key:'A',label:'Epicrisis provisional'},{key:'B',label:'Tarifario MSP y prescripciones cerradas'},{key:'C',label:'Anexos'}],correct:'B'}
  ],
  "CONSULTA EXTERNA":[
    {id:"c1",text:"Para agendar paciente usas:",options:[{key:'A',label:'Citas'},{key:'B',label:'Prescripci√≥n'},{key:'C',label:'HDD'}],correct:'A'},
    {id:"c2",text:"Para prescribir:",options:[{key:'A',label:'Imagen'},{key:'B',label:'Prescripci√≥n'},{key:'C',label:'Auditor√≠a'}],correct:'B'},
    {id:"c3",text:"Para firmar una nota:",options:[{key:'A',label:'Cerrar/Finalizar'},{key:'B',label:'Guardar borrador'},{key:'C',label:'Exportar a PDF'}],correct:'A'}
  ],
  "ANESTESIOLOG√çA":[
    {id:"a1",text:"¬øQu√© m√≥dulo revisas antes de quir√≥fano?",options:[{key:'A',label:'Generalidades'},{key:'B',label:'Anestesiolog√≠a'},{key:'C',label:'HDD'}],correct:'B'},
    {id:"a2",text:"El consentimiento informado debe:",options:[{key:'A',label:'Quedar firmado'},{key:'B',label:'Quedar en borrador'},{key:'C',label:'No es necesario'}],correct:'A'},
    {id:"a3",text:"Control de v√≠a a√©rea se documenta en:",options:[{key:'A',label:'Nota de anestesia'},{key:'B',label:'Citas'},{key:'C',label:'Imagen'}],correct:'A'}
  ]
};

/* ======= Firebase ======= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ======= Estado + helpers ======= */
const $ = s => document.querySelector(s);
$('#year').textContent = new Date().getFullYear();
const MSGS = {
  'auth/email-already-in-use':'Ese correo ya tiene una cuenta. Usa Iniciar sesi√≥n.',
  'auth/invalid-email':'El formato del correo no es v√°lido.',
  'auth/missing-email':'Ingresa tu correo.',
  'auth/missing-password':'Ingresa tu contrase√±a.',
  'auth/weak-password':'La contrase√±a es muy corta (m√≠nimo 6).',
  'auth/user-not-found':'Correo no registrado.',
  'auth/wrong-password':'Contrase√±a incorrecta.',
  'auth/invalid-credential':'Contrase√±a incorrecta.',
  'auth/invalid-login-credentials':'Contrase√±a incorrecta.',
  'auth/too-many-requests':'Demasiados intentos. Intenta m√°s tarde.',
  'auth/network-request-failed':'Error de red. Revisa tu conexi√≥n.'
};
const msg = (t)=>{ const el=$('#auth-msg'); if(el) el.textContent=t; };
const emailOk = (e)=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());

let CURRENT_UID = null;
function keyFor(uid){ return `soulmv_${uid||'anon'}`; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let state = {}; // por usuario

/* Realtime perfil */
let unsubProfile = null;
let savingProfile = false;

/* ======= Poblaci√≥n de la datalist de especialidad ======= */
const specListEl = document.getElementById('spec-list');
(function fillSpecs(){
  const specs = Object.keys(SPECIALTY_MODULES).sort();
  specListEl.innerHTML = specs.map(s=>`<option value="${s}"></option>`).join('');
})();

/* ======= Tabs + ojitos ======= */
function setTab(which){
  const onLogin = which==='login';
  $('#form-login').style.display = onLogin ? 'block' : 'none';
  $('#form-register').style.display = onLogin ? 'none'  : 'block';
  $('#tab-login').classList.toggle('btn-primary', onLogin);
  $('#tab-login').classList.toggle('btn-muted',   !onLogin);
  $('#tab-register').classList.toggle('btn-primary', !onLogin);
  $('#tab-register').classList.toggle('btn-muted',   onLogin);
}
$('#tab-login').addEventListener('click', ()=>setTab('login'));
$('#tab-register').addEventListener('click', ()=>setTab('reg'));
setTab('login');
document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const inp = document.querySelector(btn.dataset.eye);
    if(!inp) return; inp.type = inp.type==='password' ? 'text' : 'password';
  });
});

/* ======= Auth listener ======= */
auth.onAuthStateChanged((user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    document.getElementById('verify-box').style.display='none';
    setTab('login'); showLogin();
    if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
    return;
  }
  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';
  document.getElementById('verify-box').style.display='none';
  showCourse();                 // UI r√°pida
  syncFromCloud(user).catch(()=>{});
});

/* ======= Registro ======= */
document.getElementById('btn-register-2').addEventListener('click', async ()=>{
  const email= (document.getElementById('reg-email').value||'').trim().toLowerCase();
  const pass  = (document.getElementById('reg-pass').value||'').trim();
  const pass2 = (document.getElementById('reg-pass2').value||'').trim();
  if(!email || !pass || !pass2) return msg('Completa todos los campos.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  if(pass!==pass2) return msg('Las contrase√±as no coinciden.');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(methods && methods.length){
      setTab('login');
      document.getElementById('login-email').value = email;
      return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
    }

    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    if (auth.currentUser?.uid !== user.uid) await auth.updateCurrentUser(user);

    // Base en Firestore (no bloquea)
    db.collection('users').doc(user.uid).collection('courses').doc('soulmv').set({}, { merge:true }).catch(()=>{});

    // Verificaci√≥n
    const actionCodeSettings = { url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1', handleCodeInApp:false };
    let sent=false;
    for(let i=0;i<3 && !sent;i++){
      try { await auth.currentUser.sendEmailVerification(actionCodeSettings); sent=true; }
      catch(_){ try{ await auth.currentUser.reload(); }catch(_){} await new Promise(r=>setTimeout(r, 600*(i+1))); }
    }
    msg(sent? 'Cuenta creada. Te enviamos el correo de verificaci√≥n (revisa Spam).' : 'Cuenta creada. No se pudo enviar autom√°ticamente, usa ‚ÄúReenviar verificaci√≥n‚Äù.');

    document.getElementById('verify-box').style.display='block';
    setTab('login');
    document.getElementById('login-email').value = email;

  }catch(e){ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.'); }
});

/* ======= Login robusto ======= */
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const email=(document.getElementById('login-email').value||'').trim().toLowerCase();
  const pass =(document.getElementById('login-pass').value||'').trim();
  if(!email || !pass) return msg('Ingresa correo y contrase√±a.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  const btn=document.getElementById('btn-login'); btn.disabled=true;

  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const u = cred.user || auth.currentUser;
    msg('Sesi√≥n iniciada.');
    document.getElementById('verify-box').style.display='none';
    showCourse();
    syncFromCloud(u).catch(()=>{});
  }catch(e){
    let methods=[]; try{ methods = await auth.fetchSignInMethodsForEmail(email); }catch(_){}
    if(!methods || methods.length===0){
      msg('Correo no registrado.');
      setTab('reg'); document.getElementById('reg-email').value = email;
    }else if(
      e.code==='auth/wrong-password' ||
      e.code==='auth/invalid-credential' ||
      e.code==='auth/invalid-login-credentials'
    ){ msg('Contrase√±a incorrecta.'); }
    else if(e.code==='auth/too-many-requests'){ msg('Demasiados intentos. Intenta m√°s tarde.'); }
    else if(e.code==='auth/invalid-email'){ msg('El formato del correo no es v√°lido.'); }
    else{ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.'); }
  }finally{ btn.disabled=false; }
});

/* ======= Reset contrase√±a ======= */
document.getElementById('btn-reset').addEventListener('click', async ()=>{
  const email=(document.getElementById('login-email').value||'').trim().toLowerCase();
  if(!email) return msg('Escribe tu correo para enviarte el enlace.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  try{
    const methods=await auth.fetchSignInMethodsForEmail(email);
    if(!methods || methods.length===0) return msg('Correo no registrado.');
    await auth.sendPasswordResetEmail(email);
    msg('Te enviamos un correo para restablecer la contrase√±a.');
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});

/* ======= Logout ======= */
document.getElementById('btn-logout').addEventListener('click', async ()=>{
  await auth.signOut(); msg('Sesi√≥n cerrada.');
});

/* ======= Vistas ======= */
function showCourse(){
  if(!auth.currentUser) return;
  document.getElementById('step-welcome').style.display='none';
  document.getElementById('btn-logout').style.display='inline-flex';
  document.getElementById('profile').style.display='block';

  if (profileComplete()) {
    toggleCourse(true);
    setProfileReadonly(true);
    document.getElementById('pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  } else {
    toggleCourse(false);
    setProfileReadonly(false);
    document.getElementById('pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }

  renderModules(); updateProgress();
  startProfileRealtime();

  loadProfile().then(()=>{
    const complete = profileComplete();
    toggleCourse(complete);
    setProfileReadonly(complete);
    if(complete){ document.getElementById('pf-help').textContent='Puedes actualizar tus datos cuando quieras.'; }
  }).catch(()=>{});
}

function showLogin(){
  document.getElementById('step-welcome').style.display='block';
  document.getElementById('profile').style.display='none';
  document.getElementById('progress').style.display='none';
  document.getElementById('modules').style.display='none';
  document.getElementById('eval').style.display='none';
}
function profileComplete(){
  const p = state.profile || {};
  return !!(p.name && p.iddoc && p.spec);
}
function toggleCourse(enabled){
  if(enabled){
    document.getElementById('progress').style.display='block';
    document.getElementById('modules').style.display='grid';
    document.getElementById('eval').style.display='block';
  }else{
    document.getElementById('progress').style.display='none';
    document.getElementById('modules').style.display='none';
    document.getElementById('eval').style.display='none';
  }
}

/* ======= Perfil: realtime / editar / guardar ======= */
function setProfileReadonly(ro){
  ['pf-name','pf-id','pf-spec'].forEach(id=>{
    const el=document.getElementById(id);
    el.readOnly=ro; el.style.background=ro?'#eef2ff':'#fff';
  });
  document.getElementById('btn-edit-profile').style.display = ro ? 'inline-flex' : 'none';
  document.getElementById('btn-save-profile').style.display = ro ? 'none' : 'inline-flex';
}
document.getElementById('btn-edit-profile').addEventListener('click', ()=>{
  setProfileReadonly(false);
  document.getElementById('pf-help').textContent='Edita tus datos y guarda los cambios.';
});

function startProfileRealtime(){
  if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
  const uid = auth.currentUser?.uid; if(!uid) return;
  const ref = db.collection('users').doc(uid).collection('profile').doc('main');
  unsubProfile = ref.onSnapshot((snap)=>{
    if(!snap.exists) return;
    state.profile = snap.data() || {};
    saveState(CURRENT_UID, state);

    const name = state.profile?.name || auth.currentUser?.displayName || '';
    const iddoc= state.profile?.iddoc || '';
    const spec = state.profile?.spec  || '';

    if (document.getElementById('pf-name').readOnly){
      document.getElementById('pf-name').value = name;
      document.getElementById('pf-id').value   = iddoc;
      document.getElementById('pf-spec').value = spec;
    }

    // Si ven√≠amos guardando, cerrar spinner
    if (savingProfile){
      savingProfile = false;
      const pfMsg = document.getElementById('pf-msg');
      pfMsg.classList.remove('saving');
      pfMsg.textContent = '‚úÖ Perfil guardado.';
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 3000);
      setProfileReadonly(true);
      toggleCourse(profileComplete());
      // regenerar m√≥dulos si cambi√≥ especialidad
      renderModules(); updateProgress();
    }
  });
}

async function loadProfile(){
  document.getElementById('pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
  document.getElementById('pf-id').value   = state.profile?.iddoc || '';
  document.getElementById('pf-spec').value = state.profile?.spec  || '';
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){
      state.profile=s.data(); saveState(CURRENT_UID,state);
      document.getElementById('pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
      document.getElementById('pf-id').value   = state.profile?.iddoc || '';
      document.getElementById('pf-spec').value = state.profile?.spec  || '';
    }
  }catch(e){ console.warn('Perfil no disponible',e); }
}

async function saveProfile(){
  const name=(document.getElementById('pf-name').value||'').trim();
  const iddoc=(document.getElementById('pf-id').value||'').trim();
  const spec =(document.getElementById('pf-spec').value||'').trim();
  const pfMsg=document.getElementById('pf-msg');
  const btn=document.getElementById('btn-save-profile');

  if(!name || !iddoc || !spec) { pfMsg.textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return; }
  if(!(spec in SPECIALTY_MODULES)){ pfMsg.textContent='Selecciona una especialidad de la lista.'; return; }

  // UI optimista
  state.profile={name,iddoc,spec}; saveState(CURRENT_UID,state);
  pfMsg.classList.add('saving'); pfMsg.textContent='Guardando‚Ä¶';
  btn.disabled=true; savingProfile = true; toggleCourse(true); setProfileReadonly(true);
  try{ if(name){ await auth.currentUser.updateProfile({displayName:name}); } }catch(_){}

  try{
    const uid=auth.currentUser?.uid; if(!uid) throw new Error('Sin UID');
    const ref = db.collection('users').doc(uid).collection('profile').doc('main');
    const payload = {...state.profile, updatedAt: firebase.firestore.FieldValue.serverTimestamp()};
    const write = ref.set(payload,{merge:true});

    write.then(()=>{
      if (!savingProfile) return;
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='‚úÖ Perfil guardado.';
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 3000);
      setProfileReadonly(true);
      toggleCourse(profileComplete());
      // regenerar por si cambi√≥ especialidad
      renderModules(); updateProgress();
    }).catch(()=>{
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.';
      setProfileReadonly(false);
    });

    await Promise.race([ write, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),7000)) ]);

  }catch(e){
    if(e && e.message!=='timeout'){
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.';
      setProfileReadonly(false);
    }
  }finally{
    btn.disabled=false;
  }
}
document.getElementById('btn-save-profile').addEventListener('click', saveProfile);

/* ======= Render din√°mico de m√≥dulos por especialidad ======= */
const players = {}; // clave: playerId -> YT.Player
function modulesForCurrentSpec(){
  const spec = state.profile?.spec || '';
  return SPECIALTY_MODULES[spec] || [];
}
function moduleVideos(modName){
  return MODULE_VIDEO_BANK[modName] || GENERIC_VIDEOS;
}

function ensureProgressShape(){
  state.progress = state.progress || {}; // progress por m√≥dulo
  const mods = modulesForCurrentSpec();
  mods.forEach(m=>{
    state.progress[m] = state.progress[m] || { videos:{}, quiz:{passed:false,scorePct:0} };
    const vids = moduleVideos(m);
    vids.forEach((vid,idx)=>{
      const key = `v${idx}`;
      if(typeof state.progress[m].videos[key] === 'undefined'){
        state.progress[m].videos[key] = false;
      }
    });
  });
  saveState(CURRENT_UID,state);
}

function renderModules(){
  const wrap=document.getElementById('modules'); wrap.innerHTML='';
  const mods = modulesForCurrentSpec();
  if(!mods.length){
    wrap.style.display='none';
    return;
  }
  wrap.style.display='grid';
  ensureProgressShape();

  mods.forEach((modName, modIdx)=>{
    const vids = moduleVideos(modName);
    const modState = state.progress[modName];
    const allVideosDone = vids.every((_,i)=>!!modState.videos[`v${i}`]);
    const quizPassed = !!modState.quiz?.passed;

    const card=document.createElement('article'); card.className='card module';
    card.innerHTML = `
      <div class="num">${modIdx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${modName}</h3>
          <span class="badge">${vids.length} videos</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Debes completar los videos y aprobar la evaluaci√≥n del m√≥dulo.</p>
        <div class="videos-grid" id="vg-${cssSafe(modName)}"></div>

        <div class="quiz-wrap">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div>
              <strong>Evaluaci√≥n del m√≥dulo</strong><br>
              <small class="muted" id="qstate-${cssSafe(modName)}">${quizPassed? '‚úÖ Aprobado' : 'Pendiente'}</small>
            </div>
            <button class="btn ${quizPassed?'btn-success':'btn-primary'}" id="btn-quiz-${cssSafe(modName)}">${quizPassed?'Repetir evaluaci√≥n':'Iniciar evaluaci√≥n'}</button>
          </div>
          <div id="quiz-${cssSafe(modName)}" style="display:none;margin-top:12px"></div>
          <div id="quiz-result-${cssSafe(modName)}" class="muted" style="display:none;margin-top:10px"></div>
        </div>
      </div>
    `;
    wrap.appendChild(card);

    // Render de videos
    const vg = document.getElementById(`vg-${cssSafe(modName)}`);
    vids.forEach((ytId, i)=>{
      const vDone = !!modState.videos[`v${i}`];
      const playerDivId = `player-${cssSafe(modName)}-${i}`;
      const item = document.createElement('div'); item.className='video-item';
      item.innerHTML = `
        <div class="video-head">
          <div><strong>Video ${i+1}</strong> <small class="muted">(${ytId})</small></div>
          <span class="${vDone?'done-pill':'pending-pill'}">${vDone?'Completado':'Pendiente'}</span>
        </div>
        <div class="yt-wrap" style="margin-top:8px"><div id="${playerDivId}"></div></div>
      `;
      vg.appendChild(item);

      // Crear reproductor (si API ya lista, onYouTubeIframeAPIReady lo gestionar√° igual)
      createYTPlayer(playerDivId, ytId, modName, i);
    });

    // Bot√≥n de quiz
    document.getElementById(`btn-quiz-${cssSafe(modName)}`).addEventListener('click', ()=>{
      const panel = document.getElementById(`quiz-${cssSafe(modName)}`);
      const isOpen = panel.style.display==='block';
      panel.style.display = isOpen ? 'none' : 'block';
      if(!isOpen) renderModuleQuiz(modName);
    });
  });

  updateProgress();
}

function cssSafe(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-'); }

/* ======= YouTube players ======= */
function createYTPlayer(containerId, ytId, modName, vIdx){
  // Si ya existe, no recrear
  if(players[containerId]) return;
  players[containerId] = new YT.Player(containerId,{
    height:'360', width:'640', videoId: ytId,
    playerVars:{rel:0,modestbranding:1,controls:1},
    events:{
      onStateChange:(ev)=>{
        if(ev.data===YT.PlayerState.ENDED){
          // marcar video done
          state.progress = state.progress || {};
          state.progress[modName] = state.progress[modName] || {videos:{},quiz:{passed:false,scorePct:0}};
          state.progress[modName].videos[`v${vIdx}`] = true;
          saveState(CURRENT_UID,state);
          // actualizar UI pill
          const head = ev.target.getIframe().closest('.video-item').querySelector('span');
          head.className = 'done-pill';
          head.textContent = 'Completado';
          // sync
          setTimeout(syncToCloud,300);
          updateProgress();
        }
      }
    }
  });
}
window.onYouTubeIframeAPIReady = function(){
  // Cuando cargue la API, crear players para los contenedores existentes
  Object.keys(players).forEach(k=>{ /* no-op, ya creados */ });
};

/* ======= Quiz por m√≥dulo ======= */
function renderModuleQuiz(modName){
  const wrap=document.getElementById(`quiz-${cssSafe(modName)}`); wrap.innerHTML='';
  const bank = MODULE_QUIZ_BANK[modName] || [
    {id:"d1",text:`Pregunta demo 1 de ${modName}`,options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'A'},
    {id:"d2",text:`Pregunta demo 2 de ${modName}`,options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'B'},
    {id:"d3",text:`Pregunta demo 3 de ${modName}`,options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'C'}
  ];
  bank.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.margin='8px 0';
    const opts=q.options.map(o=>`
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${modName}_${q.id}" value="${o.key}">
        <span>${o.key}) ${o.label}</span>
      </label>`).join('');
    card.innerHTML=`<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>`;
    wrap.appendChild(card);
  });
  const submit=document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Enviar evaluaci√≥n';
  submit.addEventListener('click', ()=>gradeModuleQuiz(modName, bank));
  wrap.appendChild(submit);
}

function gradeModuleQuiz(modName, bank){
  let correct=0; bank.forEach(q=>{
    const c=document.querySelector(`input[name="${modName}_${q.id}"]:checked`);
    if(c && c.value===q.correct) correct++;
  });
  const scorePct=Math.round((correct/bank.length)*100);
  state.progress[modName].quiz = {passed:scorePct>=80, scorePct};
  saveState(CURRENT_UID,state);

  const r=document.getElementById(`quiz-result-${cssSafe(modName)}`); r.style.display='block';
  r.textContent=`Resultado: ${correct}/${bank.length} (${scorePct}%). ${state.progress[modName].quiz.passed?'‚úÖ Aprobado':'‚ùå No aprobado'}.`;
  document.getElementById(`qstate-${cssSafe(modName)}`).textContent = state.progress[modName].quiz.passed? '‚úÖ Aprobado' : 'Pendiente';
  const btn=document.getElementById(`btn-quiz-${cssSafe(modName)}`);
  btn.className = `btn ${state.progress[modName].quiz.passed?'btn-success':'btn-primary'}`;
  btn.textContent = state.progress[modName].quiz.passed?'Repetir evaluaci√≥n':'Iniciar evaluaci√≥n';

  setTimeout(syncToCloud,300);
  updateProgress();
}

/* ======= Progreso global y certificado ======= */
function allRequiredDone(){
  const mods = modulesForCurrentSpec();
  if(!mods.length) return false;
  return mods.every(m=>{
    const vids = moduleVideos(m);
    const ms = state.progress?.[m];
    if(!ms) return false;
    const videosOk = vids.every((_,i)=> !!ms.videos[`v${i}`]);
    const quizOk = !!ms.quiz?.passed;
    return videosOk && quizOk;
  });
}
function updateProgress(){
  const mods = modulesForCurrentSpec();
  const totalVideos = mods.reduce((acc,m)=> acc + moduleVideos(m).length, 0);
  let doneVideos = 0, doneQuizzes = 0;
  mods.forEach(m=>{
    const vids = moduleVideos(m);
    const ms = state.progress?.[m] || {};
    vids.forEach((_,i)=>{ if(ms.videos?.[`v${i}`]) doneVideos++; });
    if(ms.quiz?.passed) doneQuizzes++;
  });
  const totalTasks = totalVideos + mods.length; // videos + 1 quiz por m√≥dulo
  const doneTasks  = doneVideos + doneQuizzes;
  const pct = totalTasks? Math.round((doneTasks/totalTasks)*100) : 0;

  document.getElementById('bar').style.width=pct+'%';
  document.getElementById('progress-label').textContent=`${pct}% completado ‚Äî Videos ${doneVideos}/${totalVideos} ‚Ä¢ Evaluaciones ${doneQuizzes}/${mods.length}`;

  document.getElementById('btn-cert').disabled = !allRequiredDone();
}

document.getElementById('btn-cert')?.addEventListener('click', ()=>{
  if(!allRequiredDone()) return;
  const preferName = state.profile?.name || auth.currentUser?.displayName || '';
  document.getElementById('cert-nombre').textContent = preferName;
  const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
  document.getElementById('cert-fecha').textContent=`Fecha: ${fecha}`;
  document.getElementById('certificado').classList.add('show'); setTimeout(()=>window.print(),400);
});

/* ======= Cloud sync ======= */
async function userDoc(){
  const uid=auth.currentUser?.uid; if(!uid) return null;
  return db.collection('users').doc(uid).collection('courses').doc('soulmv');
}
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      // progreso nuevo por m√≥dulos
      if(cloud.progress){ state.progress = cloud.progress; }
      // quiz global antiguo (si existiera, lo ignoramos)
      saveState(CURRENT_UID,state);
    }
    const psnap=await db.collection('users').doc(user.uid).collection('profile').doc('main').get();
    if(psnap.exists){ state.profile=psnap.data(); saveState(CURRENT_UID,state); }
    renderModules(); updateProgress();
  }catch(e){ console.warn('No se pudo leer progreso/perfil',e); }
}
async function syncToCloud(){
  try{
    const ref=await userDoc(); if(!ref) return;
    const payload={ progress: state.progress || {} };
    await ref.set(payload,{merge:true});
    const uid=auth.currentUser?.uid; if(uid && state.profile){
      await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true});
    }
  }catch(e){ console.warn('No se pudo guardar en la nube',e); }
}
</script>
</body>
</html>
