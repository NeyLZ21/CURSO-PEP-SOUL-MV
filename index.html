<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://securetoken.googleapis.com">

<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)} .footer{margin-top:24px;color:var(--muted);font-size:13px}
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:#781C38} .cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}
.input-wrap{position:relative} .input-wrap input{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.small{font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted small"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none" type="button">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Validamos el correo y, si existe, probamos la contrase√±a.</p>

        <div class="grid" id="auth-forms" autocomplete="off">
          <input type="text" style="display:none" aria-hidden="true" autocomplete="off">
          <input type="password" style="display:none" aria-hidden="true" autocomplete="new-password">

          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary" type="button">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted" type="button">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" name="login-email" type="email" placeholder="usuario@dominio.com"
                     style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb"
                     required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" name="current-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login" type="button">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb" type="button">Restablecer contrase√±a</button>
            </div>
            <div id="auth-msg" class="muted" style="min-height:18px;margin-top:6px"></div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" name="new-email" type="email" placeholder="usuario@dominio.com"
                     style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb"
                     required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" name="new-password" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" name="new-password2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2" type="button">Crear cuenta</button>
            </div>
          </div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary" type="button">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted" type="button">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar el cuestionario</li>
          <li>Correo v√°lido (cualquier dominio) y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>Especialidad<br>
        <input id="pf-spec" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-save-profile" class="btn btn-primary" type="button">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Evaluaci√≥n + Certificado -->
  <section id="eval" class="card no-print" style="display:none;margin-top:16px">
    <h2 style="margin-top:0">Evaluaci√≥n final</h2>
    <p class="muted">Se habilita cuando completes todos los m√≥dulos.</p>

    <div id="quiz-intro" class="grid cols-2">
      <div>
        <button id="btn-start-quiz" class="btn btn-primary" disabled type="button">Comenzar evaluaci√≥n</button>
        <p class="muted small">Debes aprobar con 80% para habilitar el certificado.</p>
      </div>
      <div>
        <button id="btn-cert" class="btn btn-success" disabled type="button">Mostrar certificado</button>
        <p class="muted small">Disponible cuando completes los m√≥dulos y apruebes la evaluaci√≥n.</p>
      </div>
    </div>

    <div id="quiz" style="display:none;margin-top:16px"></div>
    <div id="quiz-result" class="muted" style="display:none;margin-top:10px"></div>
  </section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ======= Firebase ======= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
if (db && db.enablePersistence) { db.enablePersistence({ synchronizeTabs: true }).catch(()=>{}); }

/* ======= Utils ======= */
const $ = s => document.querySelector(s);
const msg = (t)=>{ const el=$('#auth-msg'); if(el) el.textContent=t||''; };
const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
$('#year').textContent = new Date().getFullYear();

function providerLabel(p){
  switch(p){
    case 'password': return 'correo y contrase√±a';
    case 'google.com': return 'Google';
    case 'facebook.com': return 'Facebook';
    case 'apple.com': return 'Apple';
    case 'microsoft.com': return 'Microsoft';
    default: return p;
  }
}

/* ======= Estado local ======= */
function keyFor(uid){ return `soulmv_${uid||'anon'}`; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let CURRENT_UID=null, state={};

/* ======= Datos del curso ======= */
const MODULOS=[
  { id:'mod1', titulo:'Navegaci√≥n b√°sica en Soul MV', yt:'dQw4w9WgXcQ', duracion:'10:05' },
  { id:'mod2', titulo:'Prescripci√≥n y √≥rdenes m√©dicas', yt:'l482T0yNkeo',  duracion:'08:40' },
  { id:'mod3', titulo:'Auditor√≠a m√©dica ‚Äì honorarios',  yt:'9bZkp7q19f0',  duracion:'12:10' }
];
const PASS_PCT=80;
const QUESTIONS=[
  { id:'q1', text:'¬øQu√© m√≥dulo usas para registrar una prescripci√≥n?', options:[{key:'A',label:'M√≥dulo de Prescripci√≥n'},{key:'B',label:'M√≥dulo de Citas'},{key:'C',label:'M√≥dulo de Imagen'}], correct:'A'},
  { id:'q2', text:'La auditor√≠a de honorarios se valida contra:', options:[{key:'A',label:'Notas de enfermer√≠a'},{key:'B',label:'Tarifario MSP y prescripciones cerradas'},{key:'C',label:'Epicrisis provisional'}], correct:'B'},
  { id:'q3', text:'Para finalizar una nota cl√≠nica debes:', options:[{key:'A',label:'Guardar borrador'},{key:'B',label:'Cerrar/Finalizar el documento (FECHADO)'},{key:'C',label:'Imprimir sin cerrar'}], correct:'B'}
];

/* ======= Tabs & ojito ======= */
function setTab(which){
  const onLogin = which==='login';
  $('#form-login').style.display = onLogin ? 'block' : 'none';
  $('#form-register').style.display = onLogin ? 'none'  : 'block';
  $('#tab-login').classList.toggle('btn-primary', onLogin);
  $('#tab-login').classList.toggle('btn-muted',   !onLogin);
  $('#tab-register').classList.toggle('btn-primary', !onLogin);
  $('#tab-register').classList.toggle('btn-muted',   onLogin);
}
document.getElementById('tab-login').addEventListener('click', ()=>setTab('login'));
document.getElementById('tab-register').addEventListener('click', ()=>setTab('reg'));
setTab('login');
document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const inp = document.querySelector(btn.dataset.eye);
    if(!inp) return; inp.type = inp.type==='password' ? 'text' : 'password';
  });
});

/* ======= REGISTRO ======= */
document.getElementById('btn-register-2').addEventListener('click', async ()=>{
  const email = ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  if(!email || !pass || !pass2) return msg('Completa todos los campos.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  if(pass!==pass2) return msg('Las contrase√±as no coinciden.');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if (methods && methods.length){
      return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n o Restablecer contrase√±a.');
    }
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    try{
      await cred.user.sendEmailVerification({ url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1', handleCodeInApp:false });
    }catch(_){}
    msg('Cuenta creada. Te enviamos el correo de verificaci√≥n (revisa Spam).');
  }catch(e){
    msg(({'auth/email-already-in-use':'Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.'}[e.code]) || ('No se pudo registrar: '+(e.message||'')));
  }
});

/* ======= LOGIN: correo ‚Üí contrase√±a (con fallback) ======= */
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const pass  = ($('#login-pass').value||'').trim();
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  if(!pass) return msg('Ingresa tu contrase√±a.');

  const btn = document.getElementById('btn-login');
  btn.disabled = true;

  try{
    msg('Verificando correo‚Ä¶');
    let methods=null;
    try{
      methods = await auth.fetchSignInMethodsForEmail(email);
      console.log('methods:', methods);
    }catch(e){ console.warn('fetchSignInMethods error:', e?.code||e); }

    // Si la API confirma que existe y usa contrase√±a:
    if (methods && methods.includes('password')){
      msg('Validando contrase√±a‚Ä¶');
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        msg('Sesi√≥n iniciada. Entrando‚Ä¶');
        if(cred.user?.emailVerified){ showCourse(); } else { document.getElementById('verify-box').style.display='block'; }
        return;
      }catch(e){
        if (['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e.code)) return msg('Contrase√±a incorrecta.');
        if (e.code==='auth/too-many-requests') return msg('Demasiados intentos. Intenta m√°s tarde.');
        if (e.code==='auth/network-request-failed') return msg('Error de red. Revisa tu conexi√≥n.');
        return msg('Ocurri√≥ un error: '+(e.message||''));
      }
    }

    // Si existe pero NO con contrase√±a (Google/Apple, etc.)
    if (methods && methods.length && !methods.includes('password')){
      const provs = methods.map(providerLabel).join(', ');
      msg(`Este correo est√° registrado con: ${provs}. Inicia sesi√≥n con ese m√©todo.`);
      return;
    }

    // Fallback: si no hay m√©todos (o fallo) intentamos signIn para decidir
    try{
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      msg('Sesi√≥n iniciada. Entrando‚Ä¶');
      if(cred.user?.emailVerified){ showCourse(); } else { document.getElementById('verify-box').style.display='block'; }
    }catch(e2){
      if (e2.code==='auth/user-not-found') return msg('Correo no registrado.');
      if (['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e2.code)) return msg('Contrase√±a incorrecta.');
      if (e2.code==='auth/too-many-requests') return msg('Demasiados intentos. Intenta m√°s tarde.');
      if (e2.code==='auth/network-request-failed') return msg('Error de red. Revisa tu conexi√≥n.');
      msg('Ocurri√≥ un error: '+(e2.message||''));
    }
  } finally {
    btn.disabled = false;
  }
});

/* ======= Reset contrase√±a ======= */
document.getElementById('btn-reset').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  if(!email) return msg('Escribe tu correo para enviarte el enlace.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(!methods || methods.length===0) return msg('Correo no registrado.');
    await auth.sendPasswordResetEmail(email);
    msg('Te enviamos un correo para restablecer la contrase√±a.');
  }catch(e){ msg('No se pudo enviar: ' + (e.message||'')); }
});

/* ======= Auth state / Vistas (resto igual) ======= */
auth.onAuthStateChanged((user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    showLogin(); return;
  }
  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';
  if(!user.emailVerified){
    $('#verify-box').style.display='block';
    $('#btn-logout').style.display='none';
    showLogin(); return;
  }
  showCourse();
});

function showCourse(){
  if(!auth.currentUser || !auth.currentUser.emailVerified) return;
  document.getElementById('step-welcome').style.display='none';
  document.getElementById('profile').style.display='block';
  document.getElementById('btn-logout').style.display='inline-flex';
  CURRENT_UID = auth.currentUser.uid;
  state = loadState(CURRENT_UID);
  document.getElementById('pf-name').value = state.profile?.name || auth.currentUser.displayName || '';
  document.getElementById('pf-id').value   = state.profile?.iddoc || '';
  document.getElementById('pf-spec').value = state.profile?.spec  || '';
  toggleCourse(true);
}
function showLogin(){
  document.getElementById('step-welcome').style.display='block';
  document.getElementById('profile').style.display='none';
  document.getElementById('progress').style.display='none';
  document.getElementById('modules').style.display='none';
  document.getElementById('eval').style.display='none';
}
function profileComplete(){ const p = state.profile || {}; return !!(p.name && p.iddoc && p.spec); }
function toggleCourse(enabled){
  if(enabled){
    document.getElementById('progress').style.display='block';
    document.getElementById('modules').style.display='grid';
    document.getElementById('eval').style.display='block';
    renderModules(); updateProgress();
    document.getElementById('pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  }else{
    document.getElementById('progress').style.display='none';
    document.getElementById('modules').style.display='none';
    document.getElementById('eval').style.display='none';
    document.getElementById('pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }
}

/* ======= M√≥dulos / Quiz (igual que ya ten√≠as, omitido para brevedad) ======= */
// ‚Ä¶ (si quieres, puedo devolverte tambi√©n esa parte id√©ntica)

</script>
</body>
</html>
