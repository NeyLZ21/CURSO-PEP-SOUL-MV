<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)} .footer{margin-top:24px;color:var(--muted);font-size:13px}

/* Certificado */
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)} .cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}

/* Inputs con ojito */
.input-wrap{position:relative} .input-wrap input{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}

/* Alertas */
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}

/* Spinner ‚ÄúGuardando‚Ä¶‚Äù */
.saving::after{
  content:''; display:inline-block; width:14px; height:14px; margin-left:8px;
  border:2px solid #9ca3af; border-top-color:transparent; border-radius:999px; animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Combo especialidad */
.combo{position:relative}
.combo input{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb}
.combo .list{position:absolute;z-index:20;left:0;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:12px;margin-top:6px;max-height:260px;overflow:auto;display:none;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.combo .item{padding:10px 12px;cursor:pointer}
.combo .item:hover{background:#f3f4f6}
.combo.show .list{display:block}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Te pediremos verificar el correo <strong>solo al registrarte</strong>. Tu progreso quedar√° guardado en la nube.</p>

        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" placeholder="usuario@dominio.com" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb" required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb">Restablecer contrase√±a</button>
            </div>
            <div id="auth-msg" class="muted" style="min-height:18px;margin-top:6px"></div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" placeholder="usuario@dominio.com" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb" required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
            <div id="auth-msg2" class="muted" style="min-height:18px;margin-top:6px"></div>
          </div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n. Conf√≠rmalo y vuelve a esta pantalla para continuar.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los m√≥dulos que te correspondan</li>
          <li>Correo v√°lido (cualquier dominio).</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>

      <div>
        <label>Especialidad</label>
        <div class="combo" id="spec-combo">
          <input id="spec-input" type="text" placeholder="Escribe para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" inputmode="search" name="spec-avoid-autofill-123">
          <div class="list" id="spec-list"></div>
        </div>
        <div class="muted" style="margin-top:6px">Selecciona de la lista. Esto define los m√≥dulos que ver√°s.</div>
      </div>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-edit-profile" class="btn btn-muted" style="display:none">Modificar</button>
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
          <div class="muted" id="progress-sub" style="font-size:12px"></div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong> seg√∫n su especialidad.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ======= LISTA DESDE TU EXCEL (inyectada) ======= */
/* Gener√© esto a partir de tu archivo. Si prefieres, puedes cargarlo desde un .js externo */
const ESPECIALIDADES = ["ACUPUNTURA","ALERGOLOGIA","ANESTESIOLOGIA","CARDIOLOGIA","CARDIOLOGIA ADULTOS","CARDIOLOGIA HEMODINAMIA","CARDIOLOGIA INTERVENCIONISTA","CARDIOLOGIA PEDIATRICA","CIR. GENERAL-COLOPROCTOLOGIA","CIR. MANO/MU√ëE-NERVIO PERI/BRA","CIRUGIA BARIATRICA","CIRUGIA CARDIACA","CIRUGIA DE CABEZA Y CUELLO","CIRUGIA GENERAL","CIRUGIA MAXILOFACIAL","CIRUGIA ONCOLOGICA","CIRUGIA PEDIATRICA","CIRUGIA PLASTICA","CIRUGIA TORAX","CIRUGIA VASCULAR","CLINICA MEDICA","DERMATOLOGIA","DIABETOLOGIA","DIAGNOSTICO POR IMAGEN","ECOGRAFIA","EMERGENCIOLOGIA","EMERGENCIOLOGIA PEDIATRICA","ENDOCRINOLOGIA","ENDOCRINOLOGIA PEDIATRICA","ENFERMERIA","FISIOTERAPIA","GASTROENTEROLOGIA","GASTROENTEROLOGIA PEDIATRICA","GERIATRIA","GERONTOLOGIA","GINECOLOGIA ONCOLOGICA","GINECOLOGIA Y OBSTETRICIA","HEMATO-ONCOLOGIA PEDIATRICA","HEMATOLOGIA","HEMATOLOGIA Y HEMOTERAPIA","HEMOTERAPIA","IMAGENOLOGIA","INFECTOLOGIA","INFECTOLOGIA PEDIATRICA","INTENSIVISTA","INTERVENCIONISMO","LABORATORIO CLINICO","MEDICAMENTOS","MEDICINA DE EMERGENCIAS","MEDICINA FAMILIAR","MEDICINA FISICA Y REHABILITACION","MEDICINA GENERAL","MEDICINA INTERNA","MEDICINA INTERNA 44","MEDICINA INTERNA HOSPITALARIA","MEDICINA INTERNA e 4","MEDICINA INTERNA e 4 t","MEDICINA NUCLEAR","NEFROLOGIA","NEFROLOGIA PEDIATRICA","NEONATOLOGIA","NEUROCIRUGIA","NEUROLOGIA","NEUROLOGIA PEDIATRICA","NEUMOLOGIA","NEUMOLOGIA PEDIATRICA","NUTRICION","NUTRICION CLINICA","NUTRICION PEDIATRICA","OFTALMOLOGIA","ONCOLOGIA","ONCOLOGIA PEDIATRICA","ORTOPEDIA Y TRAUMATOLOGIA","OTORRINOLARINGOLOGIA","OTORRINOPEDIATRIA","PALIATIVOS","PEDIATRIA","PERFUSIONISTA","PSICOLOGIA","PSIQUIATRIA","RADIOLOGIA","RADIOTERAPIA","REHABILITACION PEDIATRICA","REUMATOLOGIA","REUMATOLOGIA PEDIATRICA","SALUD OCUPACIONAL","TERAPIA RESPIRATORIA","TOXICOLOGIA","TRANSPLANTE","TRAUMATOLOGIA PEDIATRICA","UCI ADULTOS","UCI NEONATAL","UCI PEDIATRICA","UROLOGIA","UROLOGIA PEDIATRICA","ALERGOLOGIA PEDIATRICA"];
const MAPA_MODULOS = {
"ACUPUNTURA":["MODULO 1","MODULO 2","MODULO 4"],
"ALERGOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"ANESTESIOLOGIA":["MODULO 3"],
"CARDIOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"CARDIOLOGIA ADULTOS":["MODULO 1","MODULO 2","MODULO 4"],
"CARDIOLOGIA HEMODINAMIA":["MODULO 1","MODULO 2","MODULO 4"],
"CARDIOLOGIA INTERVENCIONISTA":["MODULO 1","MODULO 2","MODULO 4"],
"CARDIOLOGIA PEDIATRICA":["MODULO 1","MODULO 2","MODULO 4"],
"CIR. GENERAL-COLOPROCTOLOGIA":["MODULO 1","MODULO 3","MODULO 4"],
"CIR. MANO/MU√ëE-NERVIO PERI/BRA":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA BARIATRICA":["MODULO 1","MODULO 4"],
"CIRUGIA CARDIACA":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA DE CABEZA Y CUELLO":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA GENERAL":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA MAXILOFACIAL":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA ONCOLOGICA":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA PEDIATRICA":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA PLASTICA":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA TORAX":["MODULO 1","MODULO 3","MODULO 4"],
"CIRUGIA VASCULAR":["MODULO 1","MODULO 3","MODULO 4"],
"CLINICA MEDICA":["MODULO 1","MODULO 2","MODULO 4"],
"DERMATOLOGIA":["MODULO 1","MODULO 2"],
"DIABETOLOGIA":["MODULO 1","MODULO 2"],
"DIAGNOSTICO POR IMAGEN":["MODULO 1"],
"ECOGRAFIA":["MODULO 1","MODULO 2"],
"EMERGENCIOLOGIA":["MODULO 1","MODULO 5"],
"EMERGENCIOLOGIA PEDIATRICA":["MODULO 1","MODULO 5"],
"ENDOCRINOLOGIA":["MODULO 1","MODULO 2"],
"ENDOCRINOLOGIA PEDIATRICA":["MODULO 1","MODULO 2"],
"ENFERMERIA":["MODULO 1","MODULO 4","MODULO 5"],
"FISIOTERAPIA":["MODULO 1","MODULO 2"],
"GASTROENTEROLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"GASTROENTEROLOGIA PEDIATRICA":["MODULO 1","MODULO 2"],
"GERIATRIA":["MODULO 1","MODULO 2","MODULO 4"],
"GERONTOLOGIA":["MODULO 1","MODULO 2"],
"GINECOLOGIA ONCOLOGICA":["MODULO 1","MODULO 3","MODULO 4"],
"GINECOLOGIA Y OBSTETRICIA":["MODULO 1","MODULO 3","MODULO 4"],
"HEMATO-ONCOLOGIA PEDIATRICA":["MODULO 1","MODULO 2","MODULO 4"],
"HEMATOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"HEMATOLOGIA Y HEMOTERAPIA":["MODULO 1","MODULO 4"],
"HEMOTERAPIA":["MODULO 1","MODULO 4"],
"IMAGENOLOGIA":["MODULO 1"],
"INFECTOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"INFECTOLOGIA PEDIATRICA":["MODULO 1","MODULO 4"],
"INTENSIVISTA":["MODULO 1","MODULO 4","MODULO 5"],
"INTERVENCIONISMO":["MODULO 1","MODULO 4"],
"LABORATORIO CLINICO":["MODULO 1"],
"MEDICAMENTOS":["MODULO 1"],
"MEDICINA DE EMERGENCIAS":["MODULO 1","MODULO 5"],
"MEDICINA FAMILIAR":["MODULO 1","MODULO 2"],
"MEDICINA FISICA Y REHABILITACION":["MODULO 1","MODULO 2"],
"MEDICINA GENERAL":["MODULO 1","MODULO 2"],
"MEDICINA INTERNA":["MODULO 1","MODULO 2","MODULO 4"],
"MEDICINA NUCLEAR":["MODULO 1"],
"NEFROLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"NEFROLOGIA PEDIATRICA":["MODULO 1","MODULO 4"],
"NEONATOLOGIA":["MODULO 1","MODULO 4"],
"NEUROCIRUGIA":["MODULO 1","MODULO 3","MODULO 4"],
"NEUROLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"NEUROLOGIA PEDIATRICA":["MODULO 1","MODULO 4"],
"NEUMOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"NEUMOLOGIA PEDIATRICA":["MODULO 1","MODULO 4"],
"NUTRICION":["MODULO 1","MODULO 2"],
"NUTRICION CLINICA":["MODULO 1","MODULO 2"],
"NUTRICION PEDIATRICA":["MODULO 1","MODULO 2"],
"OFTALMOLOGIA":["MODULO 1","MODULO 2","MODULO 3"],
"ONCOLOGIA":["MODULO 1","MODULO 2","MODULO 4"],
"ONCOLOGIA PEDIATRICA":["MODULO 1","MODULO 4"],
"ORTOPEDIA Y TRAUMATOLOGIA":["MODULO 1","MODULO 4","MODULO 3"],
"OTORRINOLARINGOLOGIA":["MODULO 1","MODULO 2","MODULO 3"],
"OTORRINOPEDIATRIA":["MODULO 1","MODULO 3"],
"PALIATIVOS":["MODULO 1","MODULO 2"],
"PEDIATRIA":["MODULO 1","MODULO 4","MODULO 2"],
"PERFUSIONISTA":["MODULO 1","MODULO 3"],
"PSICOLOGIA":["MODULO 1","MODULO 2"],
"PSIQUIATRIA":["MODULO 1","MODULO 2"],
"RADIOLOGIA":["MODULO 1"],
"RADIOTERAPIA":["MODULO 1","MODULO 4"],
"REHABILITACION PEDIATRICA":["MODULO 1","MODULO 2"],
"REUMATOLOGIA":["MODULO 1","MODULO 2"],
"REUMATOLOGIA PEDIATRICA":["MODULO 1","MODULO 2"],
"SALUD OCUPACIONAL":["MODULO 1","MODULO 2"],
"TERAPIA RESPIRATORIA":["MODULO 1","MODULO 4"],
"TOXICOLOGIA":["MODULO 1","MODULO 5"],
"TRANSPLANTE":["MODULO 1","MODULO 4"],
"TRAUMATOLOGIA PEDIATRICA":["MODULO 1","MODULO 3"],
"UCI ADULTOS":["MODULO 1","MODULO 4","MODULO 5"],
"UCI NEONATAL":["MODULO 1","MODULO 4","MODULO 5"],
"UCI PEDIATRICA":["MODULO 1","MODULO 4","MODULO 5"],
"UROLOGIA":["MODULO 1","MODULO 4","MODULO 3"],
"UROLOGIA PEDIATRICA":["MODULO 1","MODULO 3"],
"ALERGOLOGIA PEDIATRICA":["MODULO 1","MODULO 2"]
};

/* ======= Videos por m√≥dulo (fallback GENERALIDADES si falta) ======= */
const MOD_VIDEOS = {
  "ANESTESIOLOG√çA": ["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0","3JZ_D3ELwOQ","kXYiU_JCYtU"],
  "CENTRO QUIR√öRGICO": ["l482T0yNkeo","9bZkp7q19f0","3JZ_D3ELwOQ","kXYiU_JCYtU","CevxZvSJLk8"],
  "CONSULTA EXTERNA": ["9bZkp7q19f0","3JZ_D3ELwOQ","kXYiU_JCYtU","CevxZvSJLk8","RgKAFK5djSk"],
  "EMERGENCIAS": ["3JZ_D3ELwOQ","kXYiU_JCYtU","CevxZvSJLk8","RgKAFK5djSk","OPf0YbXqDm0"],
  "GENERALIDADES": ["kXYiU_JCYtU","CevxZvSJLk8","RgKAFK5djSk","OPf0YbXqDm0","YVkUvmDQ3HY"],
  "HOSPITALIZACI√ìN-HDD": ["CevxZvSJLk8","RgKAFK5djSk","OPf0YbXqDm0","YVkUvmDQ3HY","hTWKbfoikeg"],
  /* Para los t√≠tulos "MODULO 1", "MODULO 2", "MODULO 3", "MODULO 4", "MODULO 5" usa GENERALIDADES como respaldo */
};

/* ======= Firebase ======= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ======= Helpers/estado por usuario ======= */
const $ = s => document.querySelector(s);
$('#year').textContent = new Date().getFullYear();
const MSGS = {
  'auth/email-already-in-use':'Ese correo ya tiene una cuenta. Usa Iniciar sesi√≥n.',
  'auth/invalid-email':'El formato del correo no es v√°lido.',
  'auth/missing-email':'Ingresa tu correo.',
  'auth/missing-password':'Ingresa tu contrase√±a.',
  'auth/weak-password':'La contrase√±a es muy corta (m√≠nimo 6).',
  'auth/user-not-found':'Correo no registrado.',
  'auth/wrong-password':'Contrase√±a incorrecta.',
  'auth/invalid-credential':'Contrase√±a incorrecta.',
  'auth/invalid-login-credentials':'Contrase√±a incorrecta.',
  'auth/too-many-requests':'Demasiados intentos. Intenta m√°s tarde.',
  'auth/network-request-failed':'Error de red. Revisa tu conexi√≥n.'
};
const msg = (t, where='#auth-msg')=>{ const el=$(where); if(el) el.textContent=t; };
const emailOk = (e)=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());

let CURRENT_UID = null;
function keyFor(uid){ return soulmv_${uid||'anon'}; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let state = {}; // por usuario

let justRegistered = false; // gate de verificaci√≥n POST-registro
let unsubProfile = null;
let savingProfile = false;

/* ======= Tabs + ojitos ======= */
function setTab(which){
  const onLogin = which==='login';
  $('#form-login').style.display = onLogin ? 'block' : 'none';
  $('#form-register').style.display = onLogin ? 'none'  : 'block';
  $('#tab-login').classList.toggle('btn-primary', onLogin);
  $('#tab-login').classList.toggle('btn-muted',   !onLogin);
  $('#tab-register').classList.toggle('btn-primary', !onLogin);
  $('#tab-register').classList.toggle('btn-muted',   onLogin);
}
$('#tab-login').addEventListener('click', ()=>setTab('login'));
$('#tab-register').addEventListener('click', ()=>setTab('reg'));
setTab('login');
document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const inp = document.querySelector(btn.dataset.eye);
    if(!inp) return; inp.type = inp.type==='password' ? 'text' : 'password';
  });
});

/* ======= Combo de especialidad (estricto) ======= */
const specCombo = $('#spec-combo'), specInput = $('#spec-input'), specList = $('#spec-list');
function renderSpecList(filter=''){
  const f = filter.trim().toLowerCase();
  const opts = ESPECIALIDADES.filter(x=>x.toLowerCase().includes(f));
  specList.innerHTML = opts.map(x=><div class="item" data-v="${x}">${x}</div>).join('') || <div class="item" data-v="">(sin resultados)</div>;
}
specInput.addEventListener('focus', ()=>{
  const v=(specInput.value||'').trim();
  if(!ESPECIALIDADES.includes(v)) specInput.value='';
  specCombo.classList.add('show'); renderSpecList(specInput.value);
});
specInput.addEventListener('input', ()=>renderSpecList(specInput.value));
specInput.addEventListener('blur', ()=>{
  const v=(specInput.value||'').trim();
  if(!ESPECIALIDADES.includes(v)) specInput.value='';
});
document.addEventListener('click', (e)=>{ if(!specCombo.contains(e.target)) specCombo.classList.remove('show'); });
specList.addEventListener('click', (e)=>{ const it=e.target.closest('.item'); if(!it) return; const v=it.dataset.v; if(v){ specInput.value=v; } specCombo.classList.remove('show'); });

/* ======= Auth listener ======= */
auth.onAuthStateChanged(async (user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    $('#verify-box').style.display='none';
    setTab('login'); showLogin();
    if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
    return;
  }
  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';

  if (justRegistered && !user.emailVerified){
    $('#verify-box').style.display='block';
    showLogin();
    return;
  } else {
    $('#verify-box').style.display='none';
  }

  showCourse();
  syncFromCloud(user).catch(()=>{});
});

/* ======= Registro ======= */
$('#btn-register-2').addEventListener('click', async ()=>{
  const email= ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  if(!email || !pass || !pass2) return msg('Completa todos los campos.','#auth-msg2');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.','#auth-msg2');
  if(pass!==pass2) return msg('Las contrase√±as no coinciden.','#auth-msg2');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(methods && methods.length){
      setTab('login'); $('#login-email').value = email;
      return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.','#auth-msg2');
    }
    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    if (auth.currentUser?.uid !== user.uid) await auth.updateCurrentUser(user);

    db.collection('users').doc(user.uid).collection('courses').doc('soulmv').set({}, { merge:true }).catch(()=>{});

    const actionCodeSettings = { url: location.href.replace(location.search,'')+'?verified=1', handleCodeInApp:false };
    justRegistered = true;
    try{ await auth.currentUser.sendEmailVerification(actionCodeSettings); msg('Cuenta creada. Te enviamos el correo de verificaci√≥n (revisa Spam).','#auth-msg2'); }catch(_){ msg('Cuenta creada. Si no te lleg√≥, usa ‚ÄúReenviar verificaci√≥n‚Äù.','#auth-msg2'); }
    $('#verify-box').style.display='block';
    setTab('login'); $('#login-email').value=email;

  }catch(e){ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.','#auth-msg2'); }
});

$('#btn-check-verify').addEventListener('click', async ()=>{
  if(auth.currentUser){ await auth.currentUser.reload(); if(auth.currentUser.emailVerified){ justRegistered=false; $('#verify-box').style.display='none'; showCourse(); } }
});
$('#btn-resend-verify').addEventListener('click', async ()=>{
  try{
    const actionCodeSettings = { url: location.href.replace(location.search,'')+'?verified=1', handleCodeInApp:false };
    if(auth.currentUser){ await auth.currentUser.sendEmailVerification(actionCodeSettings); msg('Te enviamos el correo de verificaci√≥n.','#auth-msg'); }
    else { msg('Primero inicia sesi√≥n.','#auth-msg'); }
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.','#auth-msg'); }
});
if(new URLSearchParams(location.search).get('verified')){ /* nada */ }

/* ======= Login robusto ======= */
$('#btn-login').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  const pass =( $('#login-pass').value||'').trim();
  if(!email || !pass) return msg('Ingresa correo y contrase√±a.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');

  const btn=$('#btn-login'); btn.disabled=true;
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const u = cred.user || auth.currentUser;
    msg('Sesi√≥n iniciada.');
    $('#verify-box').style.display='none';
    justRegistered=false;
    showCourse();
    syncFromCloud(u).catch(()=>{});
  }catch(e){
    let methods=[]; try{ methods = await auth.fetchSignInMethodsForEmail(email); }catch(_){}
    if(!methods || methods.length===0){ msg('Correo no registrado.'); setTab('reg'); $('#reg-email').value = email; }
    else if(['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e.code)){ msg('Contrase√±a incorrecta.'); }
    else if(e.code==='auth/too-many-requests'){ msg('Demasiados intentos. Intenta m√°s tarde.'); }
    else if(e.code==='auth/invalid-email'){ msg('El formato del correo no es v√°lido.'); }
    else{ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.'); }
  }finally{ btn.disabled=false; }
});

/* ======= Reset contrase√±a ======= */
$('#btn-reset').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  if(!email) return msg('Escribe tu correo para enviarte el enlace.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  try{
    const methods=await auth.fetchSignInMethodsForEmail(email);
    if(!methods || methods.length===0) return msg('Correo no registrado.');
    await auth.sendPasswordResetEmail(email);
    msg('Te enviamos un correo para restablecer la contrase√±a.');
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});

/* ======= Logout ======= */
$('#btn-logout').addEventListener('click', async ()=>{ await auth.signOut(); msg('Sesi√≥n cerrada.'); });

/* ======= Vistas / flujo ======= */
function showCourse(){
  if(!auth.currentUser) return;
  $('#step-welcome').style.display='none';
  $('#btn-logout').style.display='inline-flex';
  $('#profile').style.display='block';

  specInput.value = state.profile?.spec || '';

  if (profileComplete()) {
    toggleCourse(true);
    setProfileReadonly(true);
    $('#pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  } else {
    toggleCourse(false);
    setProfileReadonly(false);
    $('#pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }

  renderModules(); updateProgress();
  startProfileRealtime();
  loadProfile().then(()=>{ const c=profileComplete(); toggleCourse(c); setProfileReadonly(c); if(c) $('#pf-help').textContent='Puedes actualizar tus datos cuando quieras.'; }).catch(()=>{});
}

function showLogin(){
  $('#step-welcome').style.display='block';
  $('#profile').style.display='none';
  $('#progress').style.display='none';
  $('#modules').style.display='none';
}

function profileComplete(){
  const p = state.profile || {};
  return !!(p.name && p.iddoc && p.spec && ESPECIALIDADES.includes(p.spec));
}

function toggleCourse(enabled){
  if(enabled){
    $('#progress').style.display='block';
    $('#modules').style.display='grid';
  }else{
    $('#progress').style.display='none';
    $('#modules').style.display='none';
  }
}

/* ======= Perfil: realtime, Ver/Modificar, Guardado r√°pido ======= */
function setProfileReadonly(ro){
  ['pf-name','pf-id','spec-input'].forEach(id=>{
    const el=document.getElementById(id);
    el.readOnly=ro; el.style.background=ro?'#eef2ff':'#fff';
  });
  $('#btn-edit-profile').style.display = ro ? 'inline-flex' : 'none';
  $('#btn-save-profile').style.display = ro ? 'none' : 'inline-flex';
}
$('#btn-edit-profile').addEventListener('click', ()=>{ setProfileReadonly(false); $('#pf-help').textContent='Edita tus datos y guarda los cambios.'; });

function startProfileRealtime(){
  if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
  const uid = auth.currentUser?.uid; if(!uid) return;
  const ref = db.collection('users').doc(uid).collection('profile').doc('main');
  unsubProfile = ref.onSnapshot((snap)=>{
    if(!snap.exists) return;
    state.profile = snap.data() || {}; saveState(CURRENT_UID,state);

    if($('#pf-name').readOnly){ $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || ''; $('#pf-id').value   = state.profile?.iddoc || ''; specInput.value = state.profile?.spec  || ''; }

    if (savingProfile){
      savingProfile = false;
      const pfMsg = $('#pf-msg'); pfMsg.classList.remove('saving'); pfMsg.textContent = '‚úÖ Perfil guardado.';
      setProfileReadonly(true); toggleCourse(profileComplete());
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 2000);
      renderModules(); updateProgress();
    }
  });
}

async function loadProfile(){
  $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
  $('#pf-id').value   = state.profile?.iddoc || '';
  specInput.value     = state.profile?.spec  || '';

  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){
      state.profile=s.data(); saveState(CURRENT_UID,state);
      $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
      $('#pf-id').value   = state.profile?.iddoc || '';
      specInput.value     = state.profile?.spec  || '';
    }
  }catch(e){ console.warn('Perfil no disponible',e); }
}

async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec =(specInput.value||'').trim();
  const pfMsg=$('#pf-msg'); const btn=$('#btn-save-profile');

  if(!name || !iddoc || !spec){ pfMsg.textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return; }
  if(!ESPECIALIDADES.includes(spec)){ pfMsg.textContent='Selecciona la especialidad desde la lista (no es texto libre).'; return; }

  state.profile={name,iddoc,spec}; saveState(CURRENT_UID,state);
  pfMsg.classList.add('saving'); pfMsg.textContent='Guardando‚Ä¶';
  btn.disabled=true; savingProfile = true; toggleCourse(true); setProfileReadonly(true);
  try{ if(name){ await auth.currentUser.updateProfile({displayName:name}); } }catch(_){}

  try{
    const uid=auth.currentUser?.uid; if(!uid) throw new Error('Sin UID');
    const ref = db.collection('users').doc(uid).collection('profile').doc('main');
    const payload = { ...state.profile, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    const write = ref.set(payload,{merge:true});
    write.then(()=>{ if (!savingProfile) return; savingProfile=false; pfMsg.classList.remove('saving'); pfMsg.textContent='‚úÖ Perfil guardado.'; setProfileReadonly(true); toggleCourse(profileComplete()); setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 2000); renderModules(); updateProgress(); }).catch(()=>{ savingProfile=false; pfMsg.classList.remove('saving'); pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.'; setProfileReadonly(false); });
    await Promise.race([write,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),7000))]);
  }catch(e){
    if(e && e.message!=='timeout'){ savingProfile=false; pfMsg.classList.remove('saving'); pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.'; setProfileReadonly(false); }
  }finally{ btn.disabled=false; }
}
$('#btn-save-profile').addEventListener('click', saveProfile);

/* ======= M√≥dulos por especialidad ======= */
const players = {};  // YT players por videoId
function currentModules(){
  const spec = state.profile?.spec || '';
  return (MAPA_MODULOS[spec]||[]);
}
function renderModules(){
  const wrap=$('#modules'); wrap.innerHTML='';
  const mods = currentModules();
  if(!mods.length){ wrap.style.display='none'; return; }
  wrap.style.display='grid';

  mods.forEach((m,idx)=>{
    const modKey = mod_${idx}_${m};
    const modState = state.modules?.[m] || { done:false, videosDone:{} , quizPassed:false };
    // Fallback de videos si no existe un set espec√≠fico para este t√≠tulo
    const videos = (MOD_VIDEOS[m] || MOD_VIDEOS['GENERALIDADES'] || []);

    const card=document.createElement('article'); card.className='card module';
    const vidsHtml = videos.map((vid,i)=>
      <div class="yt-wrap" id="wrap-${modKey}-${vid}">
        <div id="player-${modKey}-${vid}"></div>
      </div>).join('');

    const quizBtn = <button class="btn ${modState.quizPassed?'btn-success':'btn-primary'}" data-quiz="${m}" ${modState.done?'':'disabled'}>${modState.quizPassed?'Evaluaci√≥n aprobada ‚úì':'Tomar evaluaci√≥n'}</button>;

    card.innerHTML=
      <div class="num">${idx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${m}</h3>
          <span class="badge">${videos.length} videos</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Mira los videos para habilitar la evaluaci√≥n.</p>
        ${vidsHtml}
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn ${modState.done?'btn-success':'btn-muted'}" data-complete="${m}" disabled>${modState.done?'Completado ‚úì':'Completar (auto)'}</button>
          ${quizBtn}
        </div>
      </div>;
    wrap.appendChild(card);

    // Inicializa players
    videos.forEach((vid)=>{
      const pid = player-${modKey}-${vid};
      players[pid] = new YT.Player(pid,{
        height:'360', width:'640', videoId:vid,
        playerVars:{rel:0,modestbranding:1,controls:1,disablekb:1},
        events:{
          onStateChange:(ev)=>{
            if(ev.data===YT.PlayerState.ENDED){
              state.modules=state.modules||{}; state.modules[m]=state.modules[m]||{done:false,videosDone:{},quizPassed:false};
              state.modules[m].videosDone[vid]=true; saveState(CURRENT_UID,state);
              const all = (videos||[]).every(v=>state.modules[m].videosDone[v]);
              const btnComp = document.querySelector([data-complete="${m}"]);
              const btnQuiz = document.querySelector([data-quiz="${m}"]);
              if(all){
                state.modules[m].done=true; saveState(CURRENT_UID,state); setTimeout(syncToCloud,200);
                if(btnComp){ btnComp.classList.remove('btn-muted'); btnComp.classList.add('btn-success'); btnComp.disabled=true; btnComp.textContent='Completado ‚úì'; }
                if(btnQuiz){ btnQuiz.disabled=false; btnQuiz.classList.remove('btn-muted'); btnQuiz.classList.add('btn-primary'); }
                updateProgress();
              }else{
                if(btnComp){ btnComp.disabled=true; }
              }
            }
          }
        }
      });
    });

    // Estado inicial de botones
    const btnComp = card.querySelector([data-complete="${m}"]);
    const btnQuiz = card.querySelector([data-quiz="${m}"]);
    const all = (videos||[]).every(v=>modState.videosDone?.[v]);
    if(all || modState.done){
      if(btnComp){ btnComp.classList.remove('btn-muted'); btnComp.classList.add('btn-success'); btnComp.disabled=true; btnComp.textContent='Completado ‚úì'; }
      if(btnQuiz){ btnQuiz.disabled=false; btnQuiz.classList.toggle('btn-success', !!modState.quizPassed); btnQuiz.classList.toggle('btn-primary', !modState.quizPassed); btnQuiz.textContent = modState.quizPassed?'Evaluaci√≥n aprobada ‚úì':'Tomar evaluaci√≥n'; }
    }else{
      if(btnComp){ btnComp.disabled=true; }
      if(btnQuiz){ btnQuiz.disabled=true; btnQuiz.classList.remove('btn-primary'); btnQuiz.classList.add('btn-muted'); }
    }
  });

  wrap.querySelectorAll('[data-quiz]').forEach(b=>b.addEventListener('click', (e)=>openQuiz(e.currentTarget.getAttribute('data-quiz')) ));
}

/* ======= Evaluaciones (3 preguntas dummy por m√≥dulo) ======= */
function questionsFor(moduleTitle){
  return [
    { id:'q1', text:${moduleTitle}: ¬øPregunta 1?, options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'A'},
    { id:'q2', text:${moduleTitle}: ¬øPregunta 2?, options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'B'},
    { id:'q3', text:${moduleTitle}: ¬øPregunta 3?, options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'C'},
  ];
}
function openQuiz(moduleTitle){
  const qs = questionsFor(moduleTitle);
  const overlay = document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:50;padding:16px';
  const box = document.createElement('div'); box.className='card'; box.style.maxWidth='720px'; box.style.width='100%';
  box.innerHTML = <h3 style="margin:0 0 10px">Evaluaci√≥n: ${moduleTitle}</h3>
    <div id="quizbox"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-primary" id="send-quiz">Enviar</button>
      <button class="btn btn-muted" id="close-quiz">Cancelar</button>
    </div>
    <div id="quiz-msg" class="muted" style="margin-top:6px"></div>;
  overlay.appendChild(box); document.body.appendChild(overlay);

  const qb = box.querySelector('#quizbox');
  qs.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.marginBottom='10px';
    const opts=q.options.map(o=>
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${q.id}" value="${o.key}"><span>${o.key}) ${o.label}</span>
      </label>).join('');
    card.innerHTML=<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>;
    qb.appendChild(card);
  });

  box.querySelector('#close-quiz').onclick=()=>overlay.remove();
  box.querySelector('#send-quiz').onclick=()=>{
    let correct=0; qs.forEach(q=>{ const c=box.querySelector(input[name="${q.id}"]:checked); if(c && c.value===q.correct) correct++; });
    const pct=Math.round(correct/qs.length*100);
    if(pct>=80){
      state.modules=state.modules||{}; state.modules[moduleTitle]=state.modules[moduleTitle]||{done:false,videosDone:{},quizPassed:false};
      state.modules[moduleTitle].quizPassed=true; saveState(CURRENT_UID,state); setTimeout(syncToCloud,200);
      const btnQuiz = document.querySelector([data-quiz="${moduleTitle}"]);
      if(btnQuiz){ btnQuiz.classList.remove('btn-primary'); btnQuiz.classList.add('btn-success'); btnQuiz.textContent='Evaluaci√≥n aprobada ‚úì'; }
      box.querySelector('#quiz-msg').textContent = ‚úÖ Aprobado (${pct}%).;
      setTimeout(()=>{ overlay.remove(); updateProgress(); }, 700);
    }else{
      box.querySelector('#quiz-msg').textContent = ‚ùå ${pct}%. Debes alcanzar 80%.;
    }
  };
}

/* ======= Progreso y Certificado ======= */
function updateProgress(){
  const mods = currentModules();
  const totalMods = mods.length;
  const videosTotal = mods.reduce((acc,m)=>acc+((MOD_VIDEOS[m] || MOD_VIDEOS['GENERALIDADES'] || []).length),0);
  const videosDone  = mods.reduce((acc,m)=>acc+((MOD_VIDEOS[m] || MOD_VIDEOS['GENERALIDADES'] || []).filter(v=>state.modules?.[m]?.videosDone?.[v]).length),0);
  const evalsDone   = mods.filter(m=>state.modules?.[m]?.quizPassed).length;

  const pct = totalMods? Math.round(((evalsDone)/totalMods)*100) : 0;
  $('#bar').style.width=pct+'%';
  $('#progress-label').textContent=${pct}% completado de evaluaciones (${evalsDone}/${totalMods});
  $('#progress-sub').textContent = Videos: ${videosDone}/${videosTotal};

  const allOk = totalMods>0 && evalsDone===totalMods;
  if(allOk){
    if(!document.getElementById('btn-cert-global')){
      const cont = document.createElement('div'); cont.className='card'; cont.style.marginTop='12px';
      cont.innerHTML = <button id="btn-cert-global" class="btn btn-success">Mostrar certificado</button>;
      $('#progress').appendChild(cont);
      cont.querySelector('#btn-cert-global').addEventListener('click', ()=>{
        const preferName = state.profile?.name || auth.currentUser?.displayName || '';
        document.getElementById('cert-nombre').textContent = preferName;
        const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
        document.getElementById('cert-fecha').textContent=Fecha: ${fecha};
        document.getElementById('certificado').classList.add('show'); setTimeout(()=>window.print(),400);
      });
    }
  }
}

/* ======= Cloud sync ======= */
async function userDoc(){
  const uid=auth.currentUser?.uid; if(!uid) return null;
  return db.collection('users').doc(uid).collection('courses').doc('soulmv');
}
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      state.modules = cloud.modules || state.modules;
      saveState(CURRENT_UID,state);
    }
    const psnap=await db.collection('users').doc(user.uid).collection('profile').doc('main').get();
    if(psnap.exists){ state.profile=psnap.data(); saveState(CURRENT_UID,state); }
    renderModules(); updateProgress();
  }catch(e){ console.warn('No se pudo leer progreso/perfil',e); }
}
async function syncToCloud(){
  try{
    const ref=await userDoc(); if(!ref) return;
    const payload={ modules: state.modules || {} };
    await ref.set(payload,{merge:true});
    const uid=auth.currentUser?.uid; if(uid && state.profile){
      await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true});
    }
  }catch(e){ console.warn('No se pudo guardar en la nube',e); }
}
</script>
</body>
</html>
