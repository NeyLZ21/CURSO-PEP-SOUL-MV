<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)} .footer{margin-top:24px;color:var(--muted);font-size:13px}
/* Certificado */
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)} .cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}
/* Inputs con ojito */
.input-wrap{position:relative} .input-wrap input, .input-wrap select, input, select {width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}
/* Avisos */
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
/* Spinner ‚ÄúGuardando‚Ä¶‚Äù */
.saving::after{
  content:''; display:inline-block; width:14px; height:14px; margin-left:8px;
  border:2px solid #9ca3af; border-top-color:transparent; border-radius:999px; animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Combo de especialidad */
.combo{position:relative}
.combo input{padding-right:36px}
.combo .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.combo .panel{position:absolute;z-index:20;left:0;right:0;max-height:280px;overflow:auto;background:#111827;color:#f9fafb;border-radius:12px;padding:6px 0;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none}
.combo .opt{padding:10px 12px;cursor:pointer}
.combo .opt:hover{background:#1f2937}
.combo.show .panel{display:block}

/* Bloques de quiz dentro de cada m√≥dulo */
.quiz-wrap{margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px}
.quiz-hint{font-size:13px}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Te pediremos verificar el correo <strong>solo al registrarte</strong> (hasta confirmarlo no podr√°s entrar al curso). Tu progreso queda guardado en la nube.</p>

        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" placeholder="usuario@dominio.com" required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb">Restablecer contrase√±a</button>
            </div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" placeholder="usuario@dominio.com" required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
          </div>

          <div id="auth-msg" class="muted" style="min-height:18px"></div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n. Conf√≠rmalo y vuelve a esta pantalla para continuar.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos de cada m√≥dulo para habilitar su evaluaci√≥n</li>
          <li>Correo v√°lido (cualquier dominio) y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" required>
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" required>
      </label>
      <label style="grid-column:1/-1">Especialidad<br>
        <div class="combo" id="spec-combo">
          <input id="pf-spec" type="text" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <span class="arrow">‚ñæ</span>
          <div class="panel" id="spec-panel"></div>
        </div>
        <small class="muted">Selecciona de la lista. Esto define los m√≥dulos que ver√°s.</small>
      </label>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-edit-profile" class="btn btn-muted" style="display:none">Modificar</button>
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos (cada tarjeta incluye su evaluaci√≥n al final) -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ========= 1) LISTA EXACTA DEL EXCEL =========
   ESPECIALIDADES (array) y ESPEC_MODS (m√≥dulos por especialidad)
   üëâ Los videos por tipo de m√≥dulo se configuran en VIDEO_DEFAULTS.
*/

// === ESPECIALIDADES (del Excel) ===
const ESPECIALIDADES = [
  "ACUPUNTURA",
  "ALERGOLOGIA",
  "ANESTESIOLOGIA",
  "CARDIOLOGIA",
  "CARDIOLOGIA HEMODINAMIA",
  "CARDIOLOGIA INTERVENCIONISTA",
  "CARDIOLOGIA PEDIATRICA",
  "CIR. GENERAL-COLOPROCTOLOGIA",
  "CIR. MANO/MU√ëE-NERVIO PERI/BRA",
  "CIRUGIA CARDIACA",
  "CIRUGIA DE CABEZA Y CUELLO",
  "CIRUGIA DE COLUMNA",
  "CIRUGIA DE HOMBRO Y CODO",
  "CIRUGIA GENERAL",
  "CIRUGIA ONCOLOGICA",
  "CIRUGIA PEDIATRICA",
  "CIRUGIA PLASTICA",
  "CIRUGIA TORACICA",
  "CIRUGIA VASCULAR",
  "COLOPROCTOLOGIA",
  "DERMATOLOGIA",
  "DIABETOLOGIA",
  "DIETOLOGIA",
  "ENDOCRINO PEDIATRA",
  "ENDOCRINOLOGIA",
  "FISIATRIA",
  "GASTROENTEROLOGIA",
  "GASTROENTEROLOGIA PEDIATR",
  "GINECOLOGIA",
  "GINECOLOGIA  MATERNO FETAL",
  "GINECOLOGIA  OBS.- GINEC.",
  "GINECOLOGIA  ONCOLOGIA",
  "GINECOLOGIA  REPRODUCCION",
  "GINECOLOGIA  INFANTO JUVENIL",
  "HEMATOLOGIA",
  "HEMATOONCOLOGIA",
  "INFECTOLOGIA",
  "INTERCONSULTO",
  "MEDICINA FAM./M√âDICO GEN",
  "MEDICINA INTERNA",
  "MEDICINA INTERNA INTENSIVO",
  "MEDICINA MATERNO FETAL",
  "NEFROLOGIA",
  "NEFROLOGIA PEDIATRICA",
  "NEONATOLOGIA",
  "NEUMOLOGIA",
  "NEUROCIRUGIA",
  "NEUROLOGIA",
  "NEUROLOGIA PEDIATRICA",
  "NEUROFISIOLOGIA CLINICA",
  "NUTRICIONISTA",
  "OFTALMOLOGIA",
  "ONCOLOGIA CLINICA",
  "ORTOPEDIA Y TRAUMATOLOGIA",
  "OTORRINOLARINGOLOGIA",
  "PEDIATRIA",
  "PEDIATRIA  NEFROLOGIA",
  "PEDIATRIA  NUTRICION",
  "PEDIATRIA  ONCOLOGIA",
  "PEDIATRIA  PSICOLOGIA",
  "PEDIATRIA  UROLOGIA",
  "PEDIATRIA  GASTROENTEROLOGIA",
  "PEDIATRIA  NEUMOLOGIA",
  "PEDIATRIA  CARDIOLOGIA",
  "PEDIATRIA  INFECTOLOGIA",
  "PEDIATRIA  ENDOCRINOLOGIA",
  "PEDIATRIA  HEMATOLOGIA",
  "PEDIATRIA  PSIQUIATRIA",
  "PEDIATRIA  FISIATRIA",
  "PEDIATRIA  DERMATOLOGIA",
  "PSICOLOGIA CLINICA",
  "PSIQUIATRIA",
  "REHABILITACION",
  "REUMATOLOGIA",
  "RESIDENTE/INTERNO",
  "SERVICIOS DE APOYO",
  "TERAPIA FISICA",
  "TERAPIA RESPIRATORIA",
  "UROLOGIA",
  "ODONTOLOGIA",
  "ODONTOPEDIATRIA",
  "ENDODONCIA",
  "ODONT. ORTODONCIA",
  "ODONT. PROTESIS",
  "ODONT. CIRUGIA MAXILOFACIAL",
  "ODONT. REHABILITACION ORAL",
  "ODONT. PERIODONCIA",
  "ODONT. IMPLANTOLOGIA",
  "ODONT. ESTETICA"
].sort();

// === M√ìDULOS POR ESPECIALIDAD (del Excel) ===
const ESPEC_MODS = {
  "ACUPUNTURA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ALERGOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ANESTESIOLOGIA": ["GENERALIDADES","ANESTESIOLOG√çA"],
  "CARDIOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "CARDIOLOGIA HEMODINAMIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "CARDIOLOGIA INTERVENCIONISTA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "CARDIOLOGIA PEDIATRICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "CIR. GENERAL-COLOPROCTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIR. MANO/MU√ëE-NERVIO PERI/BRA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA CARDIACA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA DE CABEZA Y CUELLO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA DE COLUMNA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA DE HOMBRO Y CODO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA GENERAL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA ONCOLOGICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA PEDIATRICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA PLASTICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA TORACICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "CIRUGIA VASCULAR": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "COLOPROCTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "DERMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "DIABETOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "DIETOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ENDOCRINO PEDIATRA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ENDOCRINOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "FISIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "GASTROENTEROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "GASTROENTEROLOGIA PEDIATR": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "GINECOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "GINECOLOGIA  MATERNO FETAL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "GINECOLOGIA  OBS.- GINEC.": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "GINECOLOGIA  ONCOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "GINECOLOGIA  REPRODUCCION": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "GINECOLOGIA  INFANTO JUVENIL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "HEMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "HEMATOONCOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "INFECTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "INTERCONSULTO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "MEDICINA FAM./M√âDICO GEN": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "MEDICINA INTERNA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "MEDICINA INTERNA INTENSIVO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "MEDICINA MATERNO FETAL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "NEFROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEFROLOGIA PEDIATRICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEONATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEUMOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEUROCIRUGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "NEUROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEUROLOGIA PEDIATRICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NEUROFISIOLOGIA CLINICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "NUTRICIONISTA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "OFTALMOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ONCOLOGIA CLINICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "ORTOPEDIA Y TRAUMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "OTORRINOLARINGOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "PEDIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  NEFROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  NUTRICION": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  ONCOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  PSICOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  UROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "PEDIATRIA  GASTROENTEROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  NEUMOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  CARDIOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  INFECTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  ENDOCRINOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  HEMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  PSIQIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  FISIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PEDIATRIA  DERMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PSICOLOGIA CLINICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "PSIQUIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "REHABILITACION": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "REUMATOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "RESIDENTE/INTERNO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "SERVICIOS DE APOYO": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "TERAPIA FISICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "TERAPIA RESPIRATORIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA"],
  "UROLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONTOPEDIATRIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ENDODONCIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. ORTODONCIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. PROTESIS": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. CIRUGIA MAXILOFACIAL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. REHABILITACION ORAL": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. PERIODONCIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. IMPLANTOLOGIA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"],
  "ODONT. ESTETICA": ["GENERALIDADES","HOSPITALIZACI√ìN-HDD","CONSULTA EXTERNA","CENTRO QUIR√öRGICO"]
};

// === Videos por tipo de m√≥dulo (EDITA AQU√ç con tus IDs reales) ===
// Coloca arrays con 1‚Äì5 IDs de YouTube (solo el ID, no la URL).
const VIDEO_DEFAULTS = {
  "GENERALIDADES": ["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0"],
  "HOSPITALIZACI√ìN-HDD": ["eY52Zsg-KVI","fJ9rUzIMcZQ","L_jWHffIx5E"],
  "CONSULTA EXTERNA": ["kXYiU_JCYtU","hTWKbfoikeg","QH2-TGUlwu4"],
  "CENTRO QUIR√öRGICO": ["3JZ_D3ELwOQ","04854XqcfCY","ktvTqknDobU"],
  "ANESTESIOLOG√çA": ["60ItHLz5WEA","CevxZvSJLk8","ktvTqknDobU"]
};
// Fallback si aparece un m√≥dulo no listado:
const DEFAULT_VIDEOS = ["dQw4w9WgXcQ"];

/* Estructurador de m√≥dulos */
function mkModule(id,titulo,ytIds){
  const vids = (ytIds && ytIds.length ? ytIds : DEFAULT_VIDEOS).slice(0,5).map((v,i)=>({yt:v,dur:'08:00',n:i+1}));
  // Quiz de muestra (puedes personalizar preguntas por m√≥dulo si gustas)
  const quiz = [
    { id:`${id}-q1`, text:'Pregunta 1 del m√≥dulo', options:[
      {key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'A'
    },
    { id:`${id}-q2`, text:'Pregunta 2 del m√≥dulo', options:[
      {key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'B'
    },
    { id:`${id}-q3`, text:'Pregunta 3 del m√≥dulo', options:[
      {key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}], correct:'B'
    }
  ];
  return { id, titulo, videos:vids, quiz };
}

/* ========= 2) Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ========= 3) Estado local / helpers ========= */
const $ = s => document.querySelector(s);
$('#year').textContent = new Date().getFullYear();
const MSGS = {
  'auth/email-already-in-use':'Ese correo ya tiene una cuenta. Usa Iniciar sesi√≥n.',
  'auth/invalid-email':'El formato del correo no es v√°lido.',
  'auth/missing-email':'Ingresa tu correo.',
  'auth/missing-password':'Ingresa tu contrase√±a.',
  'auth/weak-password':'La contrase√±a es muy corta (m√≠nimo 6).',
  'auth/user-not-found':'Correo no registrado.',
  'auth/wrong-password':'Contrase√±a incorrecta.',
  'auth/invalid-credential':'Contrase√±a incorrecta.',
  'auth/invalid-login-credentials':'Contrase√±a incorrecta.',
  'auth/too-many-requests':'Demasiados intentos. Intenta m√°s tarde.',
  'auth/network-request-failed':'Error de red. Revisa tu conexi√≥n.'
};
const msg = (t)=>{ const el=$('#auth-msg'); if(el) el.textContent=t; };
const emailOk = (e)=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
let CURRENT_UID = null;
function keyFor(uid){ return `soulmv_${uid||'anon'}`; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let state = {}; // por usuario

// flags
let unsubProfile = null;
let savingProfile = false;

// YouTube players
const players = {}; // key: elemId => YT.Player

/* ========= 4) UI: Tabs + ojitos ========= */
function setTab(which){
  const onLogin = which==='login';
  $('#form-login').style.display = onLogin ? 'block' : 'none';
  $('#form-register').style.display = onLogin ? 'none'  : 'block';
  $('#tab-login').classList.toggle('btn-primary', onLogin);
  $('#tab-login').classList.toggle('btn-muted',   !onLogin);
  $('#tab-register').classList.toggle('btn-primary', !onLogin);
  $('#tab-register').classList.toggle('btn-muted',   onLogin);
}
$('#tab-login').addEventListener('click', ()=>setTab('login'));
$('#tab-register').addEventListener('click', ()=>setTab('reg'));
setTab('login');
document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const inp = document.querySelector(btn.dataset.eye);
    if(!inp) return; inp.type = inp.type==='password' ? 'text' : 'password';
  });
});

/* ========= 5) Combo Especialidad (buscable y restringido) ========= */
(function setupSpecCombo(){
  const wrap = $('#spec-combo');
  const input = $('#pf-spec');
  const panel = $('#spec-panel');
  let filtered = ESPECIALIDADES.slice(); // ya viene ordenado .sort()
  let open=false;

  function render(list){
    panel.innerHTML='';
    list.forEach(name=>{
      const div=document.createElement('div');
      div.className='opt';
      div.textContent=name;
      div.addEventListener('click',()=>{
        input.value=name; hide();
      });
      panel.appendChild(div);
    });
  }
  function show(){ wrap.classList.add('show'); open=true; }
  function hide(){ wrap.classList.remove('show'); open=false; }
  render(filtered);

  input.addEventListener('focus', ()=>{ render(filtered); show(); });
  input.addEventListener('input', ()=>{
    const q=input.value.trim().toLowerCase();
    filtered = ESPECIALIDADES.filter(e=>e.toLowerCase().includes(q));
    render(filtered);
    show();
  });
  document.addEventListener('click',(e)=>{ if(!wrap.contains(e.target)) hide(); });
  wrap.addEventListener('click',()=>{ if(!open) show(); });

  // Validaci√≥n: solo permitir valores de la lista
  input.addEventListener('blur', ()=>{
    const v=input.value.trim();
    if(!v) return;
    if(!ESPECIALIDADES.includes(v)){
      input.value='';
    }
  });
})();

/* ========= 6) Auth listener (con gating de verificaci√≥n) ========= */
auth.onAuthStateChanged(async (user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    $('#verify-box').style.display='none';
    setTab('login'); showLogin();
    if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
    return;
  }

  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';

  // Si no est√° verificado, bloqueo curso
  await user.reload().catch(()=>{});
  if(!user.emailVerified){
    showLogin();
    $('#verify-box').style.display='block';
    return;
  } else {
    $('#verify-box').style.display='none';
  }

  showCourse();                  // UI r√°pida (con localStorage)
  syncFromCloud(user).catch(()=>{});
});

/* ========= 7) Registro ========= */
document.getElementById('btn-register-2').addEventListener('click', async ()=>{
  const email= ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  if(!email || !pass || !pass2) return msg('Completa todos los campos.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  if(pass!==pass2) return msg('Las contrase√±as no coinciden.');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(methods && methods.length){
      setTab('login');
      $('#login-email').value = email;
      return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
    }

    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    if (auth.currentUser?.uid !== user.uid) await auth.updateCurrentUser(user);

    // Base en Firestore (no bloquea)
    db.collection('users').doc(user.uid).collection('courses').doc('soulmv').set({}, { merge:true }).catch(()=>{});

    // Enviar verificaci√≥n (con 3 reintentos cortos)
    const actionCodeSettings = { url: location.href.split('?')[0]+'?verified=1', handleCodeInApp:false };
    let sent=false;
    for(let i=0;i<3 && !sent;i++){
      try { await auth.currentUser.sendEmailVerification(actionCodeSettings); sent=true; }
      catch(_){ try{ await auth.currentUser.reload(); }catch(_){} await new Promise(r=>setTimeout(r, 600*(i+1))); }
    }
    msg(sent ? 'Cuenta creada. Te enviamos el correo de verificaci√≥n (revisa Spam).'
             : 'Cuenta creada. No se pudo enviar autom√°ticamente, usa ‚ÄúReenviar verificaci√≥n‚Äù.');

    $('#verify-box').style.display='block';
    setTab('login');
    $('#login-email').value = email;

  }catch(e){ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.'); }
});

document.getElementById('btn-check-verify').addEventListener('click', async ()=>{
  if(auth.currentUser){
    await auth.currentUser.reload();
    if(auth.currentUser.emailVerified){
      $('#verify-box').style.display='none'; showCourse();
    }
  }
});
document.getElementById('btn-resend-verify').addEventListener('click', async ()=>{
  try{
    const actionCodeSettings = { url: location.href.split('?')[0]+'?verified=1', handleCodeInApp:false };
    if(auth.currentUser){
      await auth.currentUser.sendEmailVerification(actionCodeSettings);
      msg('Te enviamos el correo de verificaci√≥n (revisa Spam).');
    }else{ msg('Primero inicia sesi√≥n.'); }
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});

/* ========= 8) Login robusto ========= */
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  const pass =($('#login-pass').value||'').trim();
  if(!email || !pass) return msg('Ingresa correo y contrase√±a.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  const btn=$('#btn-login'); btn.disabled=true;

  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const u = cred.user || auth.currentUser;
    await u.reload().catch(()=>{});
    if(!u.emailVerified){
      msg('Debes verificar tu correo antes de continuar.');
      $('#verify-box').style.display='block';
      return;
    }
    msg('Sesi√≥n iniciada.');
    $('#verify-box').style.display='none';
    showCourse();
    syncFromCloud(u).catch(()=>{});
  }catch(e){
    let methods=[]; try{ methods = await auth.fetchSignInMethodsForEmail(email); }catch(_){}
    if(!methods || methods.length===0){
      msg('Correo no registrado.');
      setTab('reg'); $('#reg-email').value = email;
    }else if(
      e.code==='auth/wrong-password' ||
      e.code==='auth/invalid-credential' ||
      e.code==='auth/invalid-login-credentials'
    ){ msg('Contrase√±a incorrecta.'); }
    else if(e.code==='auth/too-many-requests'){ msg('Demasiados intentos. Intenta m√°s tarde.'); }
    else if(e.code==='auth/invalid-email'){ msg('El formato del correo no es v√°lido.'); }
    else{ msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.'); }
  }finally{ btn.disabled=false; }
});

/* ========= 9) Reset contrase√±a / Logout ========= */
document.getElementById('btn-reset').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  if(!email) return msg('Escribe tu correo para enviarte el enlace.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  try{
    const methods=await auth.fetchSignInMethodsForEmail(email);
    if(!methods || methods.length===0) return msg('Correo no registrado.');
    await auth.sendPasswordResetEmail(email);
    msg('Te enviamos un correo para restablecer la contrase√±a.');
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});
document.getElementById('btn-logout').addEventListener('click', async ()=>{
  await auth.signOut(); msg('Sesi√≥n cerrada.');
});

/* ========= 10) Vistas / flujo ========= */
function showCourse(){
  if(!auth.currentUser) return;
  if(!auth.currentUser.emailVerified){ showLogin(); $('#verify-box').style.display='block'; return; }

  $('#step-welcome').style.display='none';
  $('#btn-logout').style.display='inline-flex';
  $('#profile').style.display='block';

  if (profileComplete()) {
    setProfileReadonly(true);
    $('#pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  } else {
    setProfileReadonly(false);
    $('#pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }

  // Render inmediato con local
  renderAllBySpecialty(getSpecialty());
  updateGlobalProgress();
  startProfileRealtime();

  // Sincroniza nube ‚Üí revalida
  loadProfile().then(()=>{
    renderAllBySpecialty(getSpecialty());
    updateGlobalProgress();
    if(profileComplete()){ setProfileReadonly(true); $('#pf-help').textContent='Puedes actualizar tus datos cuando quieras.'; }
  }).catch(()=>{});
}

function showLogin(){
  $('#step-welcome').style.display='block';
  $('#profile').style.display='none';
  $('#progress').style.display='none';
  $('#modules').style.display='none';
}
function profileComplete(){
  const p = state.profile || {};
  return !!(p.name && p.iddoc && p.spec && ESPECIALIDADES.includes(p.spec));
}
function setProfileReadonly(ro){
  ['pf-name','pf-id','pf-spec'].forEach(id=>{
    const el=document.getElementById(id);
    el.readOnly = (id==='pf-spec') ? false : ro; // siempre permitir abrir el combo, validamos al guardar
    el.style.background=ro?'#eef2ff':'#fff';
  });
  $('#btn-edit-profile').style.display = ro ? 'inline-flex' : 'none';
  $('#btn-save-profile').style.display = ro ? 'none' : 'inline-flex';
}
document.getElementById('btn-edit-profile').addEventListener('click', ()=>{
  setProfileReadonly(false);
  $('#pf-help').textContent='Edita tus datos y guarda los cambios.';
});

/* ========= 11) Perfil: realtime + guardado r√°pido ========= */
function getSpecialty(){ return (state.profile?.spec || '').trim(); }

function startProfileRealtime(){
  if (unsubProfile) { try{unsubProfile();}catch(_){} unsubProfile=null; }
  const uid = auth.currentUser?.uid; if(!uid) return;

  const ref = db.collection('users').doc(uid).collection('profile').doc('main');
  unsubProfile = ref.onSnapshot((snap)=>{
    if(!snap.exists) return;
    const cloud = snap.data() || {};
    state.profile = { ...state.profile, ...cloud };
    saveState(CURRENT_UID, state);

    if (document.getElementById('pf-name').readOnly){
      $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
      $('#pf-id').value   = state.profile?.iddoc || '';
      $('#pf-spec').value = state.profile?.spec  || '';
    }

    if (savingProfile){
      savingProfile = false;
      const pfMsg = $('#pf-msg');
      pfMsg.classList.remove('saving');
      pfMsg.textContent = '‚úÖ Perfil guardado.';
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 3000);
      setProfileReadonly(true);
    }
  });
}

async function loadProfile(){
  // R√°pido: local
  $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
  $('#pf-id').value   = state.profile?.iddoc || '';
  $('#pf-spec').value = state.profile?.spec  || '';

  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){
      state.profile=s.data(); saveState(CURRENT_UID,state);
      $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
      $('#pf-id').value   = state.profile?.iddoc || '';
      $('#pf-spec').value = state.profile?.spec  || '';
    }
  }catch(e){ console.warn('Perfil no disponible',e); }
}

async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec =($('#pf-spec').value||'').trim();
  const pfMsg=$('#pf-msg');
  const btn=$('#btn-save-profile');

  if(!name || !iddoc || !spec){
    pfMsg.textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return;
  }
  if(!ESPECIALIDADES.includes(spec)){
    pfMsg.textContent='Selecciona una especialidad v√°lida de la lista.'; return;
  }

  // UI optimista
  state.profile={name,iddoc,spec}; saveState(CURRENT_UID,state);
  pfMsg.classList.add('saving'); pfMsg.textContent='Guardando‚Ä¶';
  btn.disabled=true;
  savingProfile = true;
  try{ if(name){ await auth.currentUser.updateProfile({displayName:name}); } }catch(_){}

  try{
    const uid=auth.currentUser?.uid; if(!uid) throw new Error('Sin UID');
    const ref = db.collection('users').doc(uid).collection('profile').doc('main');
    const payload = { ...state.profile, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    const write = ref.set(payload,{merge:true});

    write.then(()=>{
      if (!savingProfile) return;
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='‚úÖ Perfil guardado.';
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; }, 3000);
      setProfileReadonly(true);
      // re-render por especialidad
      renderAllBySpecialty(spec);
      updateGlobalProgress();
    }).catch(()=>{
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.';
      setProfileReadonly(false);
    });

    await Promise.race([write, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),6000))]);

  }catch(e){
    if(e && e.message!=='timeout'){
      savingProfile = false;
      pfMsg.classList.remove('saving');
      pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.';
      setProfileReadonly(false);
    }
  }finally{
    btn.disabled=false;
  }
}
document.getElementById('btn-save-profile').addEventListener('click', saveProfile);

/* ========= 12) Render din√°mico por especialidad (quiz dentro de cada m√≥dulo) ========= */
let ytApiReady=false;
window.onYouTubeIframeAPIReady = function(){ ytApiReady=true; ensureYTPlayersForCurrent(); };

function pickModulesFor(spec){
  const wanted = ESPEC_MODS[spec] || [];
  const list = (wanted.length? wanted : ["GENERALIDADES"]).map((titulo,idx)=>{
    const ids = VIDEO_DEFAULTS[titulo] || DEFAULT_VIDEOS;
    return mkModule(`${titulo.toLowerCase().replace(/\s+/g,'-')}-${idx+1}`, titulo, ids);
  });
  return JSON.parse(JSON.stringify(list));
}

function renderAllBySpecialty(spec){
  const modulesDef = pickModulesFor(spec || 'MEDICINA INTERNA');
  // persistir config actual
  state.course = { spec: spec || 'MEDICINA INTERNA', modules: modulesDef };
  saveState(CURRENT_UID, state);

  // Progreso + tarjetas de m√≥dulos con videos y su quiz al final
  $('#progress').style.display='block';
  $('#modules').style.display='grid';

  renderModules(modulesDef);
  updateGlobalProgress();
  ensureYTPlayersForCurrent();
}

function renderModules(modulesDef){
  const wrap=$('#modules'); wrap.innerHTML='';
  modulesDef.forEach((m,idx)=>{
    const doneVideos = (state.videosDone?.[m.id]||{}); // {yt:true}

    const videosHtml = m.videos.map(v=>`
      <div class="yt-wrap" style="margin-top:8px">
        <div id="player-${m.id}-${v.yt}"></div>
      </div>
    `).join('');

    // Bloque de evaluaci√≥n embebido
    const canStart = m.videos.every(v=>doneVideos[v.yt]);
    const passed   = state.quizzes?.[m.id]?.passed;

    const quizBtnLabel = passed?'Aprobado ‚úì':'Comenzar evaluaci√≥n';
    const quizBtnClass = passed?'btn-success':'btn-primary';
    const quizDisabled = canStart?'':'disabled';
    const quizHint     = canStart?'Listo para evaluar':'Completa los videos para habilitar';

    const card=document.createElement('article'); card.className='card module';
    card.innerHTML=`
      <div class="num">${idx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${m.titulo}</h3>
          <span class="badge">${m.videos.length} videos</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Debes ver cada video completo para habilitar la evaluaci√≥n del m√≥dulo.</p>
        ${videosHtml}

        <div class="quiz-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div class="quiz-hint muted" id="hint-${m.id}">${quizHint}</div>
            <button class="btn ${quizBtnClass}" id="btn-${m.id}" ${quizDisabled}>${quizBtnLabel}</button>
          </div>
          <div id="quiz-${m.id}" style="display:none;margin-top:12px"></div>
          <div class="muted" id="res-${m.id}" style="display:none;margin-top:8px"></div>
        </div>
      </div>`;

    wrap.appendChild(card);

    // listeners del bot√≥n de quiz
    document.getElementById(`btn-${m.id}`).addEventListener('click',()=>{
      if(state.quizzes?.[m.id]?.passed) return;
      renderQuizForModule(m);
    });
  });
}

function ensureYTPlayersForCurrent(){
  if(!ytApiReady) return;
  const spec=getSpecialty() || 'MEDICINA INTERNA';
  const modulesDef = pickModulesFor(spec);
  modulesDef.forEach(m=>{
    m.videos.forEach(v=>{
      const pid=`player-${m.id}-${v.yt}`;
      if(players[pid]) return;
      const el=document.getElementById(pid);
      if(!el) return;
      players[pid] = new YT.Player(pid,{
        height:'360', width:'640', videoId:v.yt,
        playerVars:{rel:0,modestbranding:1,controls:1,disablekb:1},
        events:{
          onStateChange:(ev)=>{
            if(ev.data===YT.PlayerState.ENDED){
              state.videosDone = state.videosDone || {};
              state.videosDone[m.id] = state.videosDone[m.id] || {};
              state.videosDone[m.id][v.yt] = true;
              saveState(CURRENT_UID,state);
              updateGlobalProgress();
              maybeEnableQuiz(m);
            }
          }
        }
      });
    });
  });
}

/* ===== Quiz dentro del m√≥dulo ===== */
function maybeEnableQuiz(m){
  const canStart = m.videos.every(v=> (state.videosDone?.[m.id]||{})[v.yt]);
  const btn=$(`#btn-${m.id}`), hint=$(`#hint-${m.id}`);
  if(btn && hint){
    btn.disabled=!canStart;
    hint.textContent = canStart ? 'Listo para evaluar' : 'Completa los videos para habilitar';
  }
}
function renderQuizForModule(m){
  const wrap=$('#quiz-'+m.id); wrap.innerHTML='';
  m.quiz.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.marginBottom='8px';
    const opts=q.options.map(o=>`
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${q.id}" value="${o.key}">
        <span>${o.key}) ${o.label}</span>
      </label>`).join('');
    card.innerHTML=`<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>`;
    wrap.appendChild(card);
  });
  const submit=document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Enviar evaluaci√≥n';
  submit.addEventListener('click', ()=>gradeQuizModule(m));
  wrap.appendChild(submit);
  wrap.style.display='block';
}
function gradeQuizModule(m){
  let correct=0;
  m.quiz.forEach(q=>{
    const c=document.querySelector(`input[name="${q.id}"]:checked`);
    if(c && c.value===q.correct) correct++;
  });
  const PASS_PCT = 80;
  const scorePct=Math.round((correct/m.quiz.length)*100);
  state.quizzes = state.quizzes || {};
  state.quizzes[m.id]={correct,total:m.quiz.length,scorePct,passed:scorePct>=PASS_PCT};
  saveState(CURRENT_UID,state);

  const res=$(`#res-${m.id}`); res.style.display='block';
  res.textContent = `Resultado: ${correct}/${m.quiz.length} (${scorePct}%). ${state.quizzes[m.id].passed?'‚úÖ Aprobado':'‚ùå No aprobado'}.`;

  if(state.quizzes[m.id].passed){
    const btn=$(`#btn-${m.id}`); if(btn){ btn.textContent='Aprobado ‚úì'; btn.classList.remove('btn-primary'); btn.classList.add('btn-success'); }
    setTimeout(syncToCloud,300);
  }
}

/* ===== Progreso global + certificado ===== */
function updateGlobalProgress(){
  const spec = getSpecialty() || 'MEDICINA INTERNA';
  const modulesDef = pickModulesFor(spec);
  const totalVideos = modulesDef.reduce((a,m)=>a+m.videos.length,0);
  const doneVideos  = modulesDef.reduce((a,m)=>a + m.videos.filter(v=> (state.videosDone?.[m.id]||{})[v.yt]).length,0);
  const pct = totalVideos? Math.round((doneVideos/totalVideos)*100) : 0;

  $('#progress').style.display='block';
  $('#modules').style.display='grid';

  $('#bar').style.width=pct+'%';
  const evalsPassed = modulesDef.filter(m=> state.quizzes?.[m.id]?.passed).length;

  // Habilitar certificado cuando todos los m√≥dulos de la especialidad est√©n aprobados
  const allPassed = modulesDef.every(m=> state.quizzes?.[m.id]?.passed);
  const labelExtra = `‚Ä¢ Evaluaciones ${evalsPassed}/${modulesDef.length}${allPassed?' ‚Ä¢ ‚úÖ Listo para certificar':''}`;
  $('#progress-label').textContent=`${pct}% completado ‚Äî Videos ${doneVideos}/${totalVideos} ${labelExtra}`;

  // Bot√≥n de certificado on demand (mantenemos Ctrl+P en secci√≥n de certificado)
  if(allPassed){
    // mostrar modal de impresi√≥n directa
    const preferName = state.profile?.name || auth.currentUser?.displayName || '';
    document.getElementById('cert-nombre').textContent = preferName;
    const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
    document.getElementById('cert-fecha').textContent=`Fecha: ${fecha}`;
    document.getElementById('certificado').classList.add('show');
  }
}

/* ========= 13) Cloud sync (progreso + perfil) ========= */
async function userDoc(){
  const uid=auth.currentUser?.uid; if(!uid) return null;
  return db.collection('users').doc(uid).collection('courses').doc('soulmv');
}
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      state.videosDone = { ...(state.videosDone||{}), ...(cloud.videosDone||{}) };
      state.quizzes    = { ...(state.quizzes||{}),    ...(cloud.quizzes||{})    };
      saveState(CURRENT_UID,state);
    }
    const psnap=await db.collection('users').doc(user.uid).collection('profile').doc('main').get();
    if(psnap.exists){ state.profile= { ...(state.profile||{}), ...(psnap.data()||{}) }; saveState(CURRENT_UID,state); }
  }catch(e){ console.warn('No se pudo leer progreso/perfil',e); }
}
async function syncToCloud(){
  try{
    const ref=await userDoc(); if(!ref) return;
    const payload={ videosDone: state.videosDone||{}, quizzes: state.quizzes||{} };
    await ref.set(payload,{merge:true});
    const uid=auth.currentUser?.uid; if(uid && state.profile){
      await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true});
    }
  }catch(e){ console.warn('No se pudo guardar en la nube',e); }
}
</script>
</body>
</html>
