<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}
.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}
.btn-muted{background:#e5e7eb;color:#111827}
.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.input{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb}
.input-wrap{position:relative}
.input-wrap .input{padding-right:40px}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}
.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}
.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)}
.footer{margin-top:24px;color:var(--muted);font-size:13px}
/* Alertas */
.alert{border-radius:12px;padding:12px 14px;font-size:14px;margin-top:10px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.alert-ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
/* Certificado */
#certificado{display:none}
#certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)}
.cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Te pediremos verificar el correo antes de iniciar el curso. Tu progreso quedar√° guardado en la nube.</p>

        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" class="input" placeholder="usuario@dominio.com" required>
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn btn-muted" id="btn-reset">Restablecer contrase√±a</button>
            </div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" class="input" placeholder="usuario@dominio.com" required>
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" class="input" placeholder="M√≠nimo 6 caracteres" required>
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" class="input" placeholder="Repite la contrase√±a" required>
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
          </div>

          <div id="auth-msg" class="muted" style="min-height:18px"></div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none">
          <strong>Verifica tu correo:</strong> te enviamos un email con un enlace. Tras confirmar, vuelve y pulsa ‚ÄúYa verifiqu√© mi correo‚Äù.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar el cuestionario</li>
          <li>Correo v√°lido (cualquier dominio) y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" class="input" required>
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" class="input" required>
      </label>
      <label>Especialidad<br>
        <input id="pf-spec" type="text" class="input" required>
      </label>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Evaluaci√≥n + Certificado -->
  <section id="eval" class="card no-print" style="display:none;margin-top:16px">
    <h2 style="margin-top:0">Evaluaci√≥n final</h2>
    <p class="muted">Se habilita cuando completes todos los m√≥dulos.</p>

    <div id="quiz-intro" class="grid cols-2">
      <div>
        <button id="btn-start-quiz" class="btn btn-primary" disabled>Comenzar evaluaci√≥n</button>
        <p class="muted" style="font-size:12px">Debes aprobar con 80% para habilitar el certificado.</p>
      </div>
      <div>
        <button id="btn-cert" class="btn btn-success" disabled>Mostrar certificado</button>
        <p class="muted" style="font-size:12px">Disponible cuando completes los m√≥dulos y apruebes la evaluaci√≥n.</p>
      </div>
    </div>

    <div id="quiz" style="display:none;margin-top:16px"></div>
    <div id="quiz-result" class="muted" style="display:none;margin-top:10px"></div>
  </section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ======= Config del curso ======= */
const MODULOS = [
  { id:'mod1', titulo:'Navegaci√≥n b√°sica en Soul MV', yt:'dQw4w9WgXcQ', duracion:'10:05' },
  { id:'mod2', titulo:'Prescripci√≥n y √≥rdenes m√©dicas', yt:'l482T0yNkeo',  duracion:'08:40' },
  { id:'mod3', titulo:'Auditor√≠a m√©dica ‚Äì honorarios',  yt:'9bZkp7q19f0',  duracion:'12:10' }
];
const PASS_PCT = 80;
const QUESTIONS = [
  { id:'q1', text:'¬øQu√© m√≥dulo usas para registrar una prescripci√≥n?', options:[
    {key:'A',label:'M√≥dulo de Prescripci√≥n'},{key:'B',label:'M√≥dulo de Citas'},{key:'C',label:'M√≥dulo de Imagen'}], correct:'A'},
  { id:'q2', text:'La auditor√≠a de honorarios se valida contra:', options:[
    {key:'A',label:'Notas de enfermer√≠a'},{key:'B',label:'Tarifario MSP y prescripciones cerradas'},{key:'C',label:'Epicrisis provisional'}], correct:'B'},
  { id:'q3', text:'Para finalizar una nota cl√≠nica debes:', options:[
    {key:'A',label:'Guardar borrador'},{key:'B',label:'Cerrar/Finalizar el documento (FECHADO)'},{key:'C',label:'Imprimir sin cerrar'}], correct:'B'}
];

/* ======= Firebase (tu proyecto) ======= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ======= Helpers / estado local por usuario ======= */
const $ = s => document.querySelector(s);
$('#year').textContent = new Date().getFullYear();
const MSGS = {
  'auth/email-already-in-use':'Ese correo ya tiene una cuenta. Usa Iniciar sesi√≥n.',
  'auth/invalid-email':'El formato del correo no es v√°lido.',
  'auth/missing-email':'Ingresa tu correo.',
  'auth/missing-password':'Ingresa tu contrase√±a.',
  'auth/weak-password':'La contrase√±a es muy corta (m√≠nimo 6).',
  'auth/user-not-found':'Correo no registrado.',
  'auth/wrong-password':'Contrase√±a incorrecta.',
  'auth/too-many-requests':'Demasiados intentos. Intenta m√°s tarde.',
  'auth/network-request-failed':'Error de red. Revisa tu conexi√≥n.'
};
const msg = (t)=>{ const el=$('#auth-msg'); if(el) el.textContent=t; };

let CURRENT_UID = null;
function keyFor(uid){ return `soulmv_${uid||'anon'}`; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let state = {}; // por usuario

/* ======= Tabs + ojitos ======= */
function setTab(which){
  const onLogin = which==='login';
  $('#form-login').style.display = onLogin ? 'block' : 'none';
  $('#form-register').style.display = onLogin ? 'none'  : 'block';
  $('#tab-login').classList.toggle('btn-primary', onLogin);
  $('#tab-login').classList.toggle('btn-muted',   !onLogin);
  $('#tab-register').classList.toggle('btn-primary', !onLogin);
  $('#tab-register').classList.toggle('btn-muted',   onLogin);
}
$('#tab-login').addEventListener('click', ()=>setTab('login'));
$('#tab-register').addEventListener('click', ()=>setTab('reg'));
setTab('login');
document.addEventListener('click',(e)=>{
  const id = e.target.getAttribute('data-eye');
  if(!id) return;
  const inp = document.querySelector(id);
  if(inp) inp.type = (inp.type==='password') ? 'text' : 'password';
});

/* ======= onAuthStateChanged: r√°pido a UI, sync en background ======= */
auth.onAuthStateChanged(async (user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    setTab('login'); showLogin(); return;
  }
  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';

  if(!user.emailVerified){
    $('#verify-box').style.display='block';
    $('#btn-logout').style.display='none';
    $('#login-email').value = user.email || '';
    showLogin();
    return;
  }

  // Mostrar curso YA
  showCourse();

  // Sincronizar en background
  (async ()=>{
    try{ await syncFromCloud(user); renderModules(); updateProgress(); }
    catch(_){}
  })();
});

/* ======= Registro (env√≠o autom√°tico de verificaci√≥n) ======= */
$('#btn-register-2').addEventListener('click', async ()=>{
  const email= ($('#reg-email').value||'').trim();
  const pass = ($('#reg-pass').value||'').trim();
  const pass2= ($('#reg-pass2').value||'').trim();
  if(!email || !pass || !pass2) return msg('Completa todos los campos.');
  if(pass !== pass2) return msg('Las contrase√±as no coinciden.');

  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    if(methods && methods.length){
      setTab('login');
      $('#login-email').value = email;
      return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
    }

    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const user = cred.user;

    // Doc base
    await db.collection('users').doc(user.uid)
      .collection('courses').doc('soulmv')
      .set({}, { merge:true });

    // Enviar verificaci√≥n AUTOM√ÅTICA + fallback
    const actionCodeSettings = {
      url: 'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
      handleCodeInApp: false
    };
    try {
      await user.sendEmailVerification(actionCodeSettings);
    } catch(e) {
      try { await auth.currentUser?.sendEmailVerification(actionCodeSettings); } catch(_) {}
    }

    msg('Cuenta creada. Te enviamos un correo para verificarla (revisa Spam).');
    $('#verify-box').style.display='block';
    setTab('login');
    $('#login-email').value = email;
    startVerifyPolling();

  }catch(e){
    msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.');
  }
});

/* ======= Login ======= */
$('#btn-login').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim();
  const pass =($('#login-pass').value||'').trim();
  if(!email || !pass) return msg('Ingresa correo y contrase√±a.');
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    msg('Sesi√≥n iniciada.');
  }catch(e){
    if(e.code==='auth/user-not-found'){
      msg('Correo no registrado.');
      $('#reg-email').value = email;
      setTab('reg');
    }else{
      msg(MSGS[e.code] || 'Ocurri√≥ un error. Intenta nuevamente.');
    }
  }
});

$('#btn-reset').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim();
  if(!email) return msg('Escribe tu correo para enviarte el enlace.');
  try{ await auth.sendPasswordResetEmail(email); msg('Te enviamos un correo para restablecer la contrase√±a.'); }
  catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});

$('#btn-logout').addEventListener('click', async ()=>{
  await auth.signOut();
  msg('Sesi√≥n cerrada.');
  setTab('login');
});

/* ======= Verificaci√≥n ======= */
let _verifyPoll;
function startVerifyPolling(){
  clearInterval(_verifyPoll);
  const deadline = Date.now()+10*60*1000;
  _verifyPoll = setInterval(async ()=>{
    if(Date.now()>deadline) { clearInterval(_verifyPoll); return; }
    if(auth.currentUser){
      await auth.currentUser.reload();
      if(auth.currentUser.emailVerified){
        clearInterval(_verifyPoll);
        $('#verify-box').style.display='none';
        msg('¬°Correo verificado! Ya puedes continuar.');
        $('#login-email').value = auth.currentUser.email || '';
        showCourse();
      }
    }
  }, 8000);
}
$('#btn-check-verify').addEventListener('click', async ()=>{
  if(auth.currentUser){
    await auth.currentUser.reload();
    if(auth.currentUser.emailVerified){
      $('#verify-box').style.display='none';
      msg('¬°Correo verificado! Continuando‚Ä¶');
      $('#login-email').value = auth.currentUser.email || '';
      showCourse();
    }else{
      msg('A√∫n no detectamos la verificaci√≥n. Revisa tu correo o pulsa ‚ÄúReenviar verificaci√≥n‚Äù.');
    }
  }
});
$('#btn-resend-verify').addEventListener('click', async ()=>{
  try{
    const actionCodeSettings = {
      url: 'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
      handleCodeInApp: false
    };
    if(auth.currentUser){
      await auth.currentUser.sendEmailVerification(actionCodeSettings);
      msg('Correo de verificaci√≥n reenviado.');
      startVerifyPolling();
    }else{
      msg('Primero inicia sesi√≥n.');
    }
  }catch(e){ msg(MSGS[e.code] || 'No se pudo enviar.'); }
});
if(new URLSearchParams(location.search).get('verified')) startVerifyPolling();

/* ======= Vistas ======= */
function showCourse(){
  if(!auth.currentUser || !auth.currentUser.emailVerified){ return; }
  $('#step-welcome').style.display='none';
  $('#profile').style.display='block';
  $('#btn-logout').style.display='inline-flex';
  loadProfile().then(()=>{ toggleCourse(profileComplete()); });
}
function showLogin(){
  $('#step-welcome').style.display='block';
  $('#profile').style.display='none';
  $('#progress').style.display='none';
  $('#modules').style.display='none';
  $('#eval').style.display='none';
}
function profileComplete(){
  const p = state.profile || {};
  return !!(p.name && p.iddoc && p.spec);
}
function toggleCourse(enabled){
  if(enabled){
    $('#progress').style.display='block';
    $('#modules').style.display='grid';
    $('#eval').style.display='block';
    renderModules(); updateProgress();
    $('#pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  }else{
    $('#progress').style.display='none';
    $('#modules').style.display='none';
    $('#eval').style.display='none';
    $('#pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }
}

/* ======= M√≥dulos (YouTube) ======= */
const players = {};
function renderModules(){
  const wrap=$('#modules'); wrap.innerHTML='';
  MODULOS.forEach((m,idx)=>{
    const done = !!(state[m.id]?.done);
    const locked = idx>0 && !state[MODULOS[idx-1].id]?.done;
    const card=document.createElement('article'); card.className='card module';
    card.innerHTML=`
      <div class="num">${idx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${m.titulo}</h3>
          <span class="badge">${m.duracion||''}</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Debes ver el video completo para marcar el m√≥dulo como terminado.</p>
        <div class="yt-wrap" id="wrap-${m.id}">
          ${locked?`<div style="position:absolute;inset:0;display:grid;place-content:center;color:#fff;background:rgba(0,0,0,.6);text-align:center;padding:20px">Completa primero el m√≥dulo ${idx}.<br><small>(bloqueado)</small></div>`:''}
          <div id="player-${m.id}"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-muted" data-restart="${m.id}">Reiniciar</button>
          <button class="btn ${done?'btn-success':'btn-primary'}" data-complete="${m.id}" ${done?'':'disabled'}>${done?'Completado ‚úì':'Marcar como completado'}</button>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
  wrap.querySelectorAll('[data-restart]').forEach(b=>b.addEventListener('click',e=>{
    const id=e.currentTarget.getAttribute('data-restart'); players[id]?.seekTo(0,true);
  }));
  wrap.querySelectorAll('[data-complete]').forEach(b=>b.addEventListener('click',e=>{
    const id=e.currentTarget.getAttribute('data-complete');
    state[id]=state[id]||{}; state[id].done=true; saveState(CURRENT_UID,state);
    updateProgress(); renderModules(); setTimeout(syncToCloud,300);
  }));
}
window.onYouTubeIframeAPIReady = function(){
  MODULOS.forEach((m,idx)=>{
    const disabled = idx>0 && !state[MODULOS[idx-1].id]?.done;
    players[m.id] = new YT.Player(`player-${m.id}`,{
      height:'360', width:'640', videoId:m.yt,
      playerVars:{rel:0,modestbranding:1,controls:1,disablekb:1},
      events:{
        onReady:(ev)=>{ if(disabled){ ev.target.stopVideo(); } },
        onStateChange:(ev)=>{
          if(ev.data===YT.PlayerState.ENDED){
            const btn=document.querySelector(`[data-complete="${m.id}"]`);
            if(btn){ btn.disabled=false; btn.classList.remove('btn-primary'); btn.classList.add('btn-success'); btn.textContent='Marcar como completado'; }
          }
          if(ev.data===YT.PlayerState.PLAYING){
            try{
              const t=ev.target.getCurrentTime(); const last=state[m.id]?.t||0;
              if(t>last+30){ ev.target.seekTo(last,true); }
              state[m.id]=state[m.id]||{}; state[m.id].t=t; saveState(CURRENT_UID,state);
            }catch(_){}
          }
        }
      }
    });
  });
};

/* ======= Progreso / Quiz / Certificado ======= */
function updateProgress(){
  const total=MODULOS.length;
  const done =MODULOS.filter(m=>state[m.id]?.done).length;
  const pct  =Math.round((done/total)*100);
  $('#bar').style.width=pct+'%';
  $('#progress-label').textContent=`${pct}% completado (${done}/${total})`;
  const allDone=(done===total);
  $('#btn-start-quiz').disabled=!allDone;
  const passed=state.quiz?.passed;
  $('#btn-cert').disabled=!(allDone && passed);
}
function renderQuiz(){
  const wrap=$('#quiz'); wrap.innerHTML='';
  QUESTIONS.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.marginBottom='12px';
    const opts=q.options.map(o=>`
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${q.id}" value="${o.key}">
        <span>${o.key}) ${o.label}</span>
      </label>`).join('');
    card.innerHTML=`<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>`;
    wrap.appendChild(card);
  });
  const submit=document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Enviar evaluaci√≥n';
  submit.addEventListener('click', gradeQuiz); wrap.appendChild(submit);
}
function gradeQuiz(){
  let correct=0; QUESTIONS.forEach(q=>{ const c=document.querySelector(`input[name="${q.id}"]:checked`); if(c && c.value===q.correct) correct++; });
  const scorePct=Math.round((correct/QUESTIONS.length)*100);
  state.quiz={correct,total:QUESTIONS.length,scorePct,passed:scorePct>=PASS_PCT}; saveState(CURRENT_UID,state);
  const result=$('#quiz-result'); result.style.display='block';
  result.textContent=`Resultado: ${correct}/${QUESTIONS.length} (${scorePct}%). ${state.quiz.passed?'‚úÖ Aprobado':'‚ùå No aprobado'}.`;
  if(state.quiz.passed){ $('#btn-cert').disabled=false; }
  setTimeout(syncToCloud,300);
  window.scrollTo({ top: result.offsetTop-80, behavior:'smooth' });
}
$('#btn-start-quiz')?.addEventListener('click', ()=>{ $('#quiz-intro').style.display='none'; $('#quiz').style.display='block'; renderQuiz(); });
$('#btn-cert')?.addEventListener('click', ()=>{
  const preferName = state.profile?.name || auth.currentUser?.displayName || '';
  $('#cert-nombre').textContent = preferName;
  const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
  $('#cert-fecha').textContent=`Fecha: ${fecha}`;
  $('#certificado').classList.add('show'); setTimeout(()=>window.print(),400);
});

/* ======= Perfil + Cloud sync ======= */
async function userDoc(){
  const uid=auth.currentUser?.uid; if(!uid) return null;
  return db.collection('users').doc(uid).collection('courses').doc('soulmv');
}
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      MODULOS.forEach(m=>{
        const localDone=!!(state[m.id]?.done);
        const cloudDone=!!(cloud[m.id]?.done);
        state[m.id]={done:(localDone||cloudDone)};
      });
      state.quiz = cloud.quiz || state.quiz;
      saveState(CURRENT_UID,state);
    }
    const psnap=await db.collection('users').doc(user.uid).collection('profile').doc('main').get();
    if(psnap.exists){ state.profile=psnap.data(); saveState(CURRENT_UID,state); }
  }catch(e){ console.warn('No se pudo leer progreso/perfil',e); }
}
async function syncToCloud(){
  try{
    const ref=await userDoc(); if(!ref) return;
    const payload={ quiz: state.quiz };
    MODULOS.forEach(m=>{ payload[m.id]={done:!!(state[m.id]?.done)}; });
    await ref.set(payload,{merge:true});
    const uid=auth.currentUser?.uid; if(uid && state.profile){
      await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true});
    }
  }catch(e){ console.warn('No se pudo guardar en la nube',e); }
}
async function loadProfile(){
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){ state.profile=s.data(); saveState(CURRENT_UID,state); }
    $('#pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
    $('#pf-id').value   = state.profile?.iddoc || '';
    $('#pf-spec').value = state.profile?.spec  || '';
  }catch(e){ console.warn('Perfil no disponible',e); }
}
async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec =($('#pf-spec').value||'').trim();
  if(!name || !iddoc || !spec){
    $('#pf-msg').textContent='Completa nombre, c√©dula/pasaporte y especialidad.';
    return;
  }
  // UI optimista: habilitar m√≥dulos de inmediato
  state.profile={name,iddoc,spec}; saveState(CURRENT_UID,state);
  $('#pf-msg').textContent='‚úÖ Perfil guardado.';
  toggleCourse(true); renderModules(); updateProgress();
  setTimeout(()=>document.getElementById('modules')?.scrollIntoView({behavior:'smooth'}),150);

  // Guardar en la nube en segundo plano
  (async ()=>{
    try{
      const uid=auth.currentUser?.uid; if(!uid) return;
      await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true});
      if(name){ await auth.currentUser.updateProfile({displayName:name}); }
    }catch(e){
      console.warn('No se pudo guardar en la nube',e);
      $('#pf-msg').textContent='Perfil guardado localmente (sin conexi√≥n a la nube por ahora).';
    }
  })();
}
$('#btn-save-profile').addEventListener('click', saveProfile);
</script>
</body>
</html>
