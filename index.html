<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendEmailVerification,
  signOut
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_STORAGE_BUCKET",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let CURRENT_UID = null;

/* ===== Helpers ===== */
const $ = (sel) => document.querySelector(sel);
function msg(txt) { alert(txt); }
function normalizeEmail(v){ return (v||'').trim().toLowerCase(); }

/* ===== Listener de sesión ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    CURRENT_UID = null;
    $("#auth-user").textContent = "";
    $("#btn-logout").style.display = "none";
    setTab("login");
    return;
  }

  CURRENT_UID = user.uid;
  $("#auth-user").textContent = user.email;
  $("#btn-logout").style.display = "inline-flex";
  $("#verify-box").style.display = user.emailVerified ? "none" : "block";

  // Cargar curso sin bloquear
  showCourse();
});

/* ===== LOGIN ===== */
$("#btn-login").addEventListener("click", async () => {
  const email = normalizeEmail($("#login-email").value);
  const pass = ($("#login-pass").value || "").trim();
  if (!email || !pass) return msg("Ingresa correo y contraseña.");

  try {
    await signInWithEmailAndPassword(auth, email, pass);
    const u = auth.currentUser;
    if (u && !u.emailVerified) {
      msg("Sesión iniciada. Verifica tu correo para completar el acceso.");
      $("#verify-box").style.display = "block";
    } else {
      msg("Sesión iniciada.");
      $("#verify-box").style.display = "none";
    }
    showCourse();
  } catch (e) {
    if (e.code === "auth/user-not-found") {
      msg("Correo no registrado.");
      setTab("reg");
      $("#reg-email").value = email;
    } else if (
      e.code === "auth/wrong-password" ||
      e.code === "auth/invalid-credential" ||
      e.code === "auth/invalid-login-credentials"
    ) {
      msg("Contraseña incorrecta.");
    } else if (e.code === "auth/too-many-requests") {
      msg("Demasiados intentos. Intenta más tarde.");
    } else {
      msg("Error: " + e.message);
    }
  }
});

/* ===== REGISTRO ===== */
$("#btn-register-2").addEventListener("click", async () => {
  const email = normalizeEmail($("#reg-email").value);
  const pass = ($("#reg-pass").value || "").trim();
  const pass2 = ($("#reg-pass2").value || "").trim();
  if (!email || !pass || !pass2) return msg("Completa todos los campos.");
  if (pass !== pass2) return msg("Las contraseñas no coinciden.");

  try {
    const { user } = await createUserWithEmailAndPassword(auth, email, pass);

    // Guardar perfil en segundo plano
    setDoc(doc(db, "users", user.uid, "courses", "soulmv"), {}, { merge: true });

    // Enviar verificación inmediata
    try {
      await sendEmailVerification(user);
      msg("Cuenta creada. Te enviamos el correo de verificación.");
    } catch {
      msg("Cuenta creada. No se pudo enviar automáticamente, usa 'Reenviar verificación'.");
    }

    $("#verify-box").style.display = "block";
    setTab("login");
    $("#login-email").value = email;
  } catch (e) {
    if (e.code === "auth/email-already-in-use") {
      msg("Correo ya registrado. Usa Iniciar sesión.");
      setTab("login");
      $("#login-email").value = email;
    } else if (e.code === "auth/weak-password") {
      msg("La contraseña es muy corta (mínimo 6 caracteres).");
    } else {
      msg("Error: " + e.message);
    }
  }
});

/* ===== LOGOUT ===== */
$("#btn-logout").addEventListener("click", () => {
  signOut(auth);
  setTab("login");
});

/* ===== Tabs ===== */
function setTab(tab) {
  document.querySelectorAll(".tab").forEach((el) => el.style.display = "none");
  $("#" + tab).style.display = "block";
}

function showCourse() {
  setTab("course");
}

</script>
