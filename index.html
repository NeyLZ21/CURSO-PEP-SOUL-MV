<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>

<!-- Fuentes -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- Acelera Firebase Auth -->
<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://securetoken.googleapis.com">

<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.muted{color:var(--muted)} .footer{margin-top:24px;color:var(--muted);font-size:13px}
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)} .cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}
.input-wrap{position:relative} .input-wrap input{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.small{font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HV</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted small"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none" type="button">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Validamos el correo y, si existe, probamos la contrase√±a.</p>

        <div class="grid" id="auth-forms" autocomplete="off">
          <input type="text" style="display:none" aria-hidden="true" autocomplete="off">
          <input type="password" style="display:none" aria-hidden="true" autocomplete="new-password">

          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary" type="button">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted" type="button">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" name="login-email" type="email" placeholder="usuario@dominio.com"
                     style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb"
                     required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" name="current-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login" type="button">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb" type="button">Restablecer contrase√±a</button>
            </div>
            <div id="auth-msg" class="muted" style="min-height:18px;margin-top:6px"></div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" name="new-email" type="email" placeholder="usuario@dominio.com"
                     style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb"
                     required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" name="new-password" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" name="new-password2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2" type="button">Crear cuenta</button>
            </div>
          </div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary" type="button">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted" type="button">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar el cuestionario</li>
          <li>Correo v√°lido (cualquier dominio) y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br>
        <input id="pf-name" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>C√©dula o Pasaporte<br>
        <input id="pf-id" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
      <label>Especialidad<br>
        <input id="pf-spec" type="text" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb">
      </label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-save-profile" class="btn btn-primary" type="button">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div>
          <strong>Progreso del curso</strong>
          <div class="muted" id="progress-label">0% completado</div>
        </div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Evaluaci√≥n + Certificado -->
  <section id="eval" class="card no-print" style="display:none;margin-top:16px">
    <h2 style="margin-top:0">Evaluaci√≥n final</h2>
    <p class="muted">Se habilita cuando completes todos los m√≥dulos.</p>

    <div id="quiz-intro" class="grid cols-2">
      <div>
        <button id="btn-start-quiz" class="btn btn-primary" disabled type="button">Comenzar evaluaci√≥n</button>
        <p class="muted small">Debes aprobar con 80% para habilitar el certificado.</p>
      </div>
      <div>
        <button id="btn-cert" class="btn btn-success" disabled type="button">Mostrar certificado</button>
        <p class="muted small">Disponible cuando completes los m√≥dulos y apruebes la evaluaci√≥n.</p>
      </div>
    </div>

    <div id="quiz" style="display:none;margin-top:16px"></div>
    <div id="quiz-result" class="muted" style="display:none;margin-top:10px"></div>
  </section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ======= Firebase ======= */
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
if (db && db.enablePersistence) { db.enablePersistence({ synchronizeTabs: true }).catch(()=>{}); }

/* ======= Util ======= */
const $ = s => document.querySelector(s);
const msg = (t)=>{ const el=$('#auth-msg'); if(el) el.textContent=t||''; };
const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
$('#year').textContent = new Date().getFullYear();

/* Mostrar errores JS en pantalla para depurar si algo falla */
window.addEventListener('error', (ev)=>{
  console.error(ev.error || ev.message);
  msg('Error de script: ' + (ev.error?.message || ev.message));
});

/* ======= Estado local ======= */
function keyFor(uid){ return `soulmv_${uid||'anon'}`; }
function loadState(uid){ try{ return JSON.parse(localStorage.getItem(keyFor(uid))||'{}'); }catch{ return {}; } }
function saveState(uid, st){ localStorage.setItem(keyFor(uid), JSON.stringify(st)); }
let CURRENT_UID = null;
let state = {};

/* ======= Config del curso ======= */
const MODULOS = [
  { id:'mod1', titulo:'Navegaci√≥n b√°sica en Soul MV', yt:'dQw4w9WgXcQ', duracion:'10:05' },
  { id:'mod2', titulo:'Prescripci√≥n y √≥rdenes m√©dicas', yt:'l482T0yNkeo',  duracion:'08:40' },
  { id:'mod3', titulo:'Auditor√≠a m√©dica ‚Äì honorarios',  yt:'9bZkp7q19f0',  duracion:'12:10' }
];
const PASS_PCT = 80;
const QUESTIONS = [
  { id:'q1', text:'¬øQu√© m√≥dulo usas para registrar una prescripci√≥n?', options:[
    {key:'A',label:'M√≥dulo de Prescripci√≥n'},{key:'B',label:'M√≥dulo de Citas'},{key:'C',label:'M√≥dulo de Imagen'}], correct:'A'},
  { id:'q2', text:'La auditor√≠a de honorarios se valida contra:', options:[
    {key:'A',label:'Notas de enfermer√≠a'},{key:'B',label:'Tarifario MSP y prescripciones cerradas'},{key:'C',label:'Epicrisis provisional'}], correct:'B'},
  { id:'q3', text:'Para finalizar una nota cl√≠nica debes:', options:[
    {key:'A',label:'Guardar borrador'},{key:'B',label:'Cerrar/Finalizar el documento (FECHADO)'},{key:'C',label:'Imprimir sin cerrar'}], correct:'B'}
];

/* ======= Helpers ======= */
async function emailExistsStrict(email){
  try{
    const methods = await auth.fetchSignInMethodsForEmail(email);
    return Array.isArray(methods) && methods.length>0;
  }catch(_){ return false; }
}
function probeEmailExists(email){
  return (async ()=>{
    try{
      const methods = await auth.fetchSignInMethodsForEmail(email);
      return Array.isArray(methods) && methods.length>0;
    }catch(_){ return null; }
  })();
}

/* ======= Auth listener ======= */
auth.onAuthStateChanged((user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent='';
    $('#btn-logout').style.display='none';
    showLogin(); 
    return;
  }
  CURRENT_UID = user.uid;
  state = loadState(CURRENT_UID);
  $('#auth-user').textContent = user.email || '';

  if(!user.emailVerified){
    $('#verify-box').style.display='block';
    $('#btn-logout').style.display='none';
    showLogin();
    return;
  }
  showCourse();
});

/* ======= DOM Ready: listeners ======= */
document.addEventListener('DOMContentLoaded', ()=>{
  // Tabs
  function setTab(which){
    const onLogin = which==='login';
    $('#form-login').style.display = onLogin ? 'block' : 'none';
    $('#form-register').style.display = onLogin ? 'none'  : 'block';
    $('#tab-login').classList.toggle('btn-primary', onLogin);
    $('#tab-login').classList.toggle('btn-muted',   !onLogin);
    $('#tab-register').classList.toggle('btn-primary', !onLogin);
    $('#tab-register').classList.toggle('btn-muted',   onLogin);
  }
  $('#tab-login').addEventListener('click', ()=>setTab('login'));
  $('#tab-register').addEventListener('click', ()=>setTab('reg'));
  setTab('login');

  document.querySelectorAll('.eye').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const inp = document.querySelector(btn.dataset.eye);
      if(!inp) return; inp.type = inp.type==='password' ? 'text' : 'password';
    });
  });

  /* ======= Registro ======= */
  document.getElementById('btn-register-2').addEventListener('click', async ()=>{
    const email = ($('#reg-email').value||'').trim().toLowerCase();
    const pass  = ($('#reg-pass').value||'').trim();
    const pass2 = ($('#reg-pass2').value||'').trim();

    if(!email || !pass || !pass2) return msg('Completa todos los campos.');
    if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
    if(pass!==pass2) return msg('Las contrase√±as no coinciden.');

    try{
      const exists = await emailExistsStrict(email);
      if (exists){
        setTab('login'); $('#login-email').value = email;
        return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
      }

      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      const user = cred.user;
      if (auth.currentUser?.uid !== user.uid) await auth.updateCurrentUser(user);
      try { await auth.currentUser?.reload(); } catch(_){}

      const actionCodeSettings = { url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1', handleCodeInApp:false };
      try{ await auth.currentUser.sendEmailVerification(actionCodeSettings); }catch(_){}
      msg('Cuenta creada. Te enviamos el correo de verificaci√≥n (revisa Spam).');

      document.getElementById('verify-box').style.display='block';
      setTab('login'); $('#login-email').value = email;
    }catch(e){
      if (e.code === 'auth/email-already-in-use'){
        setTab('login'); $('#login-email').value = email;
        return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.');
      }
      msg('No se pudo registrar. ' + (e.message||''));
    }
  });

  /* ======= Login (r√°pido + desambiguaci√≥n) ======= */
  document.getElementById('btn-login').addEventListener('click', async (ev)=>{
    ev.preventDefault();

    const email = ($('#login-email').value||'').trim().toLowerCase();
    const pass  = ($('#login-pass').value||'').trim();

    if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
    if(!pass) return msg('Ingresa tu contrase√±a.');

    const btn = document.getElementById('btn-login');
    btn.disabled = true;
    msg('Validando contrase√±a‚Ä¶');

    const signPromise  = auth.signInWithEmailAndPassword(email, pass);
    const probePromise = probeEmailExists(email);

    let finished = false;
    const t1 = setTimeout(()=>{ if(!finished) msg('Conectando‚Ä¶'); }, 1200);
    const t2 = setTimeout(()=>{ if(!finished) msg('A√∫n conectando, casi listo‚Ä¶'); }, 3000);
    const t3 = setTimeout(()=>{ if(!finished) msg('La red est√° lenta. No cierres esta ventana‚Ä¶'); }, 5000);
    const hard = setTimeout(async ()=>{
      if(!finished){
        try{ await auth.signOut(); }catch(_){}
        finished = true; btn.disabled = false;
        msg('No pudimos conectar con el servidor. Intenta nuevamente.');
      }
    }, 12000);
    const clearAll=()=>{ clearTimeout(t1); clearTimeout(t2); clearTimeout(t3); clearTimeout(hard); };

    try{
      const cred = await signPromise;
      finished = true; clearAll();
      msg('Sesi√≥n iniciada. Entrando‚Ä¶');

      if (cred.user?.emailVerified){
        showCourse();
      } else {
        document.getElementById('verify-box').style.display='block';
      }
    }catch(e){
      finished = true; clearAll();

      // Espera corta por el probe (m√°x 1s)
      let exists = null;
      try{
        exists = await Promise.race([probePromise, new Promise(r=>setTimeout(()=>r(null), 1000))]);
      }catch(_){ exists = null; }

      if (e.code === 'auth/user-not-found' || exists === false){
        msg('Correo no registrado.');
        setTab('reg'); document.getElementById('reg-email').value = email;

      } else if (
        e.code === 'auth/wrong-password' ||
        e.code === 'auth/invalid-credential' ||
        e.code === 'auth/invalid-login-credentials' ||
        exists === true
      ){
        msg('Contrase√±a incorrecta.');

      } else if (e.code === 'auth/too-many-requests'){
        msg('Demasiados intentos. Intenta m√°s tarde.');
      } else if (e.code === 'auth/unauthorized-domain'){
        msg('Dominio no autorizado en Firebase Auth.');
      } else if (e.code === 'auth/network-request-failed'){
        msg('Error de red. Revisa tu conexi√≥n e int√©ntalo de nuevo.');
      } else if (e.code === 'auth/invalid-email'){
        msg('El formato del correo no es v√°lido.');
      } else {
        msg('Ocurri√≥ un error. ' + (e.message||'Intenta nuevamente.'));
      }
    } finally {
      btn.disabled = false;
    }
  });

  /* ======= Reset contrase√±a ======= */
  document.getElementById('btn-reset').addEventListener('click', async ()=>{
    const email=($('#login-email').value||'').trim().toLowerCase();
    if(!email) return msg('Escribe tu correo para enviarte el enlace.');
    if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
    try{
      const exists = await emailExistsStrict(email);
      if(!exists) return msg('Correo no registrado.');
      await auth.sendPasswordResetEmail(email);
      msg('Te enviamos un correo para restablecer la contrase√±a.');
    }catch(e){ msg('No se pudo enviar: ' + (e.message||'')); }
  });

  /* ======= Logout ======= */
  document.getElementById('btn-logout').addEventListener('click', async ()=>{
    await auth.signOut();
    msg('Sesi√≥n cerrada.');
  });
});

/* ======= Vistas / Curso ======= */
function showCourse(){
  if(!auth.currentUser || !auth.currentUser.emailVerified) return;

  document.getElementById('step-welcome').style.display='none';
  document.getElementById('profile').style.display='block';
  document.getElementById('btn-logout').style.display='inline-flex';

  CURRENT_UID = auth.currentUser.uid;
  state = loadState(CURRENT_UID);
  document.getElementById('pf-name').value = state.profile?.name || auth.currentUser.displayName || '';
  document.getElementById('pf-id').value   = state.profile?.iddoc || '';
  document.getElementById('pf-spec').value = state.profile?.spec  || '';

  toggleCourse(true);
  loadProfile().then(()=> toggleCourse(profileComplete()));
  syncFromCloud(auth.currentUser).then(()=>{ renderModules(); updateProgress(); }).catch(()=>{});
}
function showLogin(){
  document.getElementById('step-welcome').style.display='block';
  document.getElementById('profile').style.display='none';
  document.getElementById('progress').style.display='none';
  document.getElementById('modules').style.display='none';
  document.getElementById('eval').style.display='none';
}
function profileComplete(){
  const p = state.profile || {};
  return !!(p.name && p.iddoc && p.spec);
}
function toggleCourse(enabled){
  if(enabled){
    document.getElementById('progress').style.display='block';
    document.getElementById('modules').style.display='grid';
    document.getElementById('eval').style.display='block';
    renderModules(); updateProgress();
    document.getElementById('pf-help').textContent = 'Puedes actualizar tus datos cuando quieras.';
  }else{
    document.getElementById('progress').style.display='none';
    document.getElementById('modules').style.display='none';
    document.getElementById('eval').style.display='none';
    document.getElementById('pf-help').textContent = 'Completa todos los campos para habilitar los m√≥dulos.';
  }
}

/* ======= M√≥dulos (YouTube) ======= */
const players = {};
function renderModules(){
  const wrap=document.getElementById('modules'); wrap.innerHTML='';
  MODULOS.forEach((m,idx)=>{
    const done = !!(state[m.id]?.done);
    const locked = idx>0 && !state[MODULOS[idx-1].id]?.done;
    const card=document.createElement('article'); card.className='card module';
    card.innerHTML=`
      <div class="num">${idx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${m.titulo}</h3>
          <span class="badge">${m.duracion||''}</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Debes ver el video completo para marcar el m√≥dulo como terminado.</p>
        <div class="yt-wrap" id="wrap-${m.id}">
          ${locked?`<div style="position:absolute;inset:0;display:grid;place-content:center;color:#fff;background:rgba(0,0,0,.6);text-align:center;padding:20px">Completa primero el m√≥dulo ${idx}.<br><small>(bloqueado)</small></div>`:''}
          <div id="player-${m.id}"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-muted" data-restart="${m.id}" type="button">Reiniciar</button>
          <button class="btn ${done?'btn-success':'btn-primary'}" data-complete="${m.id}" ${done?'':'disabled'} type="button">${done?'Completado ‚úì':'Marcar como completado'}</button>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
  wrap.querySelectorAll('[data-restart]').forEach(b=>b.addEventListener('click',e=>{
    const id=e.currentTarget.getAttribute('data-restart'); players[id]?.seekTo(0,true);
  }));
  wrap.querySelectorAll('[data-complete]').forEach(b=>b.addEventListener('click',e=>{
    const id=e.currentTarget.getAttribute('data-complete');
    state[id]=state[id]||{}; state[id].done=true; saveState(CURRENT_UID,state);
    updateProgress(); renderModules();
  }));
}
window.onYouTubeIframeAPIReady = function(){
  MODULOS.forEach((m,idx)=>{
    const disabled = idx>0 && !state[MODULOS[idx-1].id]?.done;
    players[m.id] = new YT.Player(`player-${m.id}`,{
      height:'360', width:'640', videoId:m.yt,
      playerVars:{rel:0,modestbranding:1,controls:1,disablekb:1},
      events:{
        onReady:(ev)=>{ if(disabled){ ev.target.stopVideo(); } },
        onStateChange:(ev)=>{
          if(ev.data===YT.PlayerState.ENDED){
            const btn=document.querySelector(`[data-complete="${m.id}"]`);
            if(btn){ btn.disabled=false; btn.classList.remove('btn-primary'); btn.classList.add('btn-success'); btn.textContent='Marcar como completado'; }
          }
        }
      }
    });
  });
};

/* ======= Progreso / Quiz / Certificado ======= */
function updateProgress(){
  const total=MODULOS.length;
  const done =MODULOS.filter(m=>state[m.id]?.done).length;
  const pct  =Math.round((done/total)*100);
  document.getElementById('bar').style.width=pct+'%';
  document.getElementById('progress-label').textContent=`${pct}% completado (${done}/${total})`;
  const allDone=(done===total);
  document.getElementById('btn-start-quiz').disabled=!allDone;
  const passed=state.quiz?.passed;
  const certBtn = document.getElementById('btn-cert');
  if (certBtn) certBtn.disabled = !(allDone && passed);
}
function renderQuiz(){
  const wrap=document.getElementById('quiz'); wrap.innerHTML='';
  QUESTIONS.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card';
    const opts=q.options.map(o=>`
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${q.id}" value="${o.key}">
        <span>${o.key}) ${o.label}</span>
      </label>`).join('');
    card.innerHTML=`<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>`;
    wrap.appendChild(card);
  });
  const submit=document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Enviar evaluaci√≥n'; submit.type='button';
  submit.addEventListener('click', gradeQuiz); wrap.appendChild(submit);
}
function gradeQuiz(){
  let correct=0; QUESTIONS.forEach(q=>{ const c=document.querySelector(`input[name="${q.id}"]:checked`); if(c && c.value===q.correct) correct++; });
  const scorePct=Math.round((correct/QUESTIONS.length)*100);
  state.quiz={correct,total:QUESTIONS.length,scorePct,passed:scorePct>=PASS_PCT}; saveState(CURRENT_UID,state);
  const result=document.getElementById('quiz-result'); result.style.display='block';
  result.textContent=`Resultado: ${correct}/${QUESTIONS.length} (${scorePct}%). ${state.quiz.passed?'‚úÖ Aprobado':'‚ùå No aprobado'}.`;
  if(state.quiz.passed){ document.getElementById('btn-cert').disabled=false; }
  window.scrollTo({ top: result.offsetTop-80, behavior:'smooth' });
}
document.getElementById('btn-start-quiz')?.addEventListener('click', ()=>{
  document.getElementById('quiz-intro').style.display='none';
  document.getElementById('quiz').style.display='block';
  renderQuiz();
});
document.getElementById('btn-cert')?.addEventListener('click', ()=>{
  const preferName = state.profile?.name || auth.currentUser?.displayName || '';
  document.getElementById('cert-nombre').textContent = preferName;
  const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
  document.getElementById('cert-fecha').textContent=`Fecha: ${fecha}`;
  document.getElementById('certificado').classList.add('show'); setTimeout(()=>window.print(),400);
});

/* ======= Cloud sync (background) ======= */
async function userDoc(){
  const uid=auth.currentUser?.uid; if(!uid) return null;
  return db.collection('users').doc(uid).collection('courses').doc('soulmv');
}
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      MODULOS.forEach(m=>{
        const localDone=!!(state[m.id]?.done);
        const cloudDone=!!(cloud[m.id]?.done);
        state[m.id]={done:(localDone||cloudDone)};
      });
      state.quiz = cloud.quiz || state.quiz;
      saveState(CURRENT_UID,state);
    }
  }catch(e){ console.warn('No se pudo leer progreso',e); }
}
async function loadProfile(){
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){ state.profile=s.data(); saveState(CURRENT_UID,state); }
    document.getElementById('pf-name').value = state.profile?.name || auth.currentUser?.displayName || '';
    document.getElementById('pf-id').value   = state.profile?.iddoc || '';
    document.getElementById('pf-spec').value = state.profile?.spec  || '';
  }catch(e){ console.warn('Perfil no disponible',e); }
}
async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec =($('#pf-spec').value||'').trim();
  if(!name || !iddoc || !spec){
    document.getElementById('pf-msg').textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return;
  }
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    await db.collection('users').doc(uid).collection('profile').doc('main').set({name,iddoc,spec},{merge:true});
    state.profile={name,iddoc,spec}; saveState(CURRENT_UID,state);
    if(name){ await auth.currentUser.updateProfile({displayName:name}); }
    document.getElementById('pf-msg').textContent='‚úÖ Perfil guardado.'; toggleCourse(true);
  }catch(e){ document.getElementById('pf-msg').textContent='No se pudo guardar.'; }
}
document.getElementById('btn-save-profile').addEventListener('click', saveProfile);
</script>
</body>
</html>
