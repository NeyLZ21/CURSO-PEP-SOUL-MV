<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Acceso ‚Ä¢ HV Inducci√≥n</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://identitytoolkit.googleapis.com">
<link rel="preconnect" href="https://securetoken.googleapis.com">

<style>
:root{--brand:#781C38;--ink:#111827;--muted:#6b7280;--bg:#f8fafc;--card:#fff;--bd:#e5e7eb;--ok:#15803d}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:760px;margin:auto;padding:24px}
h1{margin:0 0 8px}
p.small{margin:0 0 14px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 22px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff}
.btn-muted{background:#e5e7eb;color:#111827}
.btn:disabled{opacity:.6;cursor:not-allowed}
.input{width:100%;padding:12px;border:1px solid var(--bd);border-radius:12px}
.small{font-size:12px;color:var(--muted)}
.tabs .btn{padding:8px 12px}
.input-wrap{position:relative}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;cursor:pointer}
.hidden{display:none !important}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:600}
.ok{color:var(--ok)} .err{color:#b91c1c}
#version{position:fixed;right:10px;bottom:10px;font-size:12px;color:#6b7280;background:#fff;border:1px dashed #e5e7eb;border-radius:10px;padding:4px 8px}
</style>
</head>
<body>
<div class="container">
  <h1>Acceso</h1>
  <p class="small">En registro se env√≠a verificaci√≥n autom√°tica al correo.</p>

  <div class="card">
    <div class="row tabs" style="margin-bottom:8px">
      <button id="tab-login" class="btn btn-primary" type="button">Iniciar sesi√≥n</button>
      <button id="tab-register" class="btn btn-muted" type="button">Registrarme</button>
    </div>

    <!-- LOGIN -->
    <section id="view-login" class="grid">
      <label>Correo electr√≥nico
        <input id="login-email" type="email" class="input" placeholder="usuario@dominio.com"
               autocomplete="username" name="username" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="login-pass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <button class="eye" type="button" data-eye="#login-pass" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-login" class="btn btn-primary" type="button">Confirmar</button>
        <button id="btn-reset" class="btn btn-muted" type="button">Restablecer contrase√±a</button>
      </div>
      <div id="login-msg" class="small" style="min-height:18px"></div>
    </section>

    <!-- REGISTRO -->
    <section id="view-register" class="grid hidden">
      <label>Correo electr√≥nico
        <input id="reg-email" type="email" class="input" placeholder="usuario@dominio.com"
               autocomplete="email" name="email" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="email">
      </label>
      <label>Contrase√±a
        <div class="input-wrap">
          <input id="reg-pass" type="password" class="input" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <label>Confirmar contrase√±a
        <div class="input-wrap">
          <input id="reg-pass2" type="password" class="input" placeholder="Repite la contrase√±a" autocomplete="new-password">
          <button class="eye" type="button" data-eye="#reg-pass2" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>
      </label>
      <div class="row">
        <button id="btn-register" class="btn btn-primary" type="button">Crear cuenta</button>
      </div>
      <div id="reg-msg" class="small" style="min-height:18px"></div>

      <div id="verify-box" class="hidden" style="margin-top:10px">
        <p class="small">Te enviamos un email para <strong>verificar tu cuenta</strong> (revisa Spam).</p>
        <div class="row">
          <button id="btn-check-verify" class="btn btn-primary" type="button">Ya verifiqu√©</button>
          <button id="btn-resend-verify" class="btn btn-muted" type="button">Reenviar verificaci√≥n</button>
        </div>
        <div id="verify-msg" class="small" style="min-height:18px"></div>
      </div>
    </section>
  </div>

  <div class="row" style="margin-top:12px">
    <span id="whoami" class="small"></span>
    <button id="btn-logout" class="btn btn-muted hidden" type="button">Cerrar sesi√≥n</button>
  </div>
</div>

<div id="version">HVQ v0812d</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
// ====== CONFIGURACI√ìN ======
const MODO_PRECISO = true; // ‚Üê pon true si NO tienes protecci√≥n anti-enumeraci√≥n y quieres mensajes espec√≠ficos

// ====== Firebase ======
const firebaseConfig = {
  apiKey: "AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",
  authDomain: "induccion-pep-hvq.firebaseapp.com",
  projectId: "induccion-pep-hvq",
  storageBucket: "induccion-pep-hvq.firebasestorage.app",
  messagingSenderId: "651724182766",
  appId: "1:651724182766:web:4eec9be43e9e8e60dc0fff",
  measurementId: "G-Z62L1CCYP1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
auth.languageCode = 'es';
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

// ====== Utils ======
const $ = s => document.querySelector(s);
const emailOk = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());
const setMsg = (el, t, cls) => { el.classList.remove('ok','err'); if(cls) el.classList.add(cls); el.textContent = t||''; };
const provName = p => ({'password':'correo y contrase√±a','google.com':'Google','apple.com':'Apple','facebook.com':'Facebook','microsoft.com':'Microsoft'}[p]||p);

// ====== Tabs & ojitos ======
function show(tab){
  $('#view-login').classList.toggle('hidden', tab!=='login');
  $('#view-register').classList.toggle('hidden', tab!=='register');
  $('#tab-login').classList.toggle('btn-primary', tab==='login');
  $('#tab-login').classList.toggle('btn-muted',   tab!=='login');
  $('#tab-register').classList.toggle('btn-primary', tab==='register');
  $('#tab-register').classList.toggle('btn-muted',   tab!=='register');
}
$('#tab-login').onclick=()=>show('login');
$('#tab-register').onclick=()=>show('register');
show('login');
document.querySelectorAll('.eye').forEach(b=>b.addEventListener('click',()=>{
  const i=document.querySelector(b.dataset.eye); if(i) i.type = i.type==='password' ? 'text':'password';
}));

// ====== Estado de sesi√≥n (UI) ======
auth.onAuthStateChanged(user=>{
  if(user){
    $('#whoami').innerHTML = `Sesi√≥n: <span class="badge">${user.email}</span> ${user.emailVerified ? '<span class="ok">(verificado)</span>':'<span class="err">(sin verificar)</span>'}`;
    $('#btn-logout').classList.remove('hidden');
  }else{
    $('#whoami').textContent = '';
    $('#btn-logout').classList.add('hidden');
  }
});

// ====== LOGIN ======
async function handleLogin(){
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const pass  = ($('#login-pass').value||'').trim();
  const msgEl = $('#login-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.','err');
  if(!pass)          return setMsg(msgEl,'Ingresa tu contrase√±a.','err');

  const btn = $('#btn-login');
  btn.disabled = true; setMsg(msgEl,'Validando‚Ä¶');

  try{
    // MODO PRECISO: primero comprobamos m√©todos de acceso
    if (MODO_PRECISO) {
      const methods = await auth.fetchSignInMethodsForEmail(email).catch(()=>null);
      if (methods && methods.length === 0) {
        setMsg(msgEl,'Correo no registrado.','err');
        return;
      }
      if (methods && !methods.includes('password')) {
        setMsg(msgEl, `Este correo est√° registrado con: ${methods.map(provName).join(', ')}.`, 'err');
        return;
      }
    }

    await auth.signInWithEmailAndPassword(email, pass);
    setMsg(msgEl,'Sesi√≥n iniciada.','ok');
    // location.href = './modulos/index.html'; // si deseas redirigir
  }catch(e){
    // Casos con c√≥digos diferenciados
    if (e.code === 'auth/wrong-password')         setMsg(msgEl,'Contrase√±a incorrecta.','err');
    else if (e.code === 'auth/user-not-found')    setMsg(msgEl,'Correo no registrado.','err');
    else if (e.code === 'auth/too-many-requests') setMsg(msgEl,'Demasiados intentos. Intenta m√°s tarde.','err');
    else if (e.code === 'auth/network-request-failed') setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.','err');
    else if (e.code === 'auth/invalid-credential' || e.code === 'auth/invalid-login-credentials') {
      // Protecci√≥n anti-enumeraci√≥n: intentamos refinar si est√° permitido
      if (MODO_PRECISO) {
        try{
          const methods = await auth.fetchSignInMethodsForEmail(email);
          if (!methods || methods.length === 0) setMsg(msgEl,'Correo no registrado.','err');
          else if (methods.includes('password')) setMsg(msgEl,'Contrase√±a incorrecta.','err');
          else setMsg(msgEl, `Este correo est√° registrado con: ${methods.map(provName).join(', ')}.`, 'err');
        }catch{ setMsg(msgEl,'Correo o contrase√±a incorrectos.','err'); }
      } else {
        setMsg(msgEl,'Correo o contrase√±a incorrectos.','err');
      }
    } else {
      setMsg(msgEl,'Error: '+(e.message||''),'err');
    }
  } finally {
    btn.disabled = false;
  }
}
$('#btn-login').addEventListener('click', handleLogin);
document.querySelector('#view-login').addEventListener('keydown', e=>{
  if(e.key==='Enter') { e.preventDefault(); handleLogin(); }
});

// ====== RESET ======
$('#btn-reset').addEventListener('click', async ()=>{
  const email = ($('#login-email').value||'').trim().toLowerCase();
  const msgEl = $('#login-msg');
  if(!emailOk(email)) return setMsg(msgEl,'Escribe un correo v√°lido.','err');

  try{
    if (MODO_PRECISO) {
      const methods = await auth.fetchSignInMethodsForEmail(email).catch(()=>null);
      if (methods && methods.length === 0) return setMsg(msgEl,'Correo no registrado.','err');
    }
    await auth.sendPasswordResetEmail(email);
    setMsg(msgEl, MODO_PRECISO ? 'Te enviamos un correo para restablecer la contrase√±a.' : 'Si la cuenta existe, te enviaremos un correo para restablecer la contrase√±a.','ok');
  }catch(e){
    if (e.code==='auth/network-request-failed') setMsg(msgEl,'Error de red. Revisa tu conexi√≥n.','err');
    else setMsg(msgEl,'No se pudo enviar: ' + (e.message||''),'err');
  }
});

// ====== REGISTRO ======
async function handleRegister(){
  const email = ($('#reg-email').value||'').trim().toLowerCase();
  const pass  = ($('#reg-pass').value||'').trim();
  const pass2 = ($('#reg-pass2').value||'').trim();
  const msgEl = $('#reg-msg');

  if(!emailOk(email)) return setMsg(msgEl,'El formato del correo no es v√°lido.','err');
  if(pass.length<6)   return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).','err');
  if(pass!==pass2)    return setMsg(msgEl,'Las contrase√±as no coinciden.','err');

  const btn = $('#btn-register');
  btn.disabled = true; setMsg(msgEl,'Creando cuenta‚Ä¶');

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);

    try{
      await cred.user.sendEmailVerification({
        url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',
        handleCodeInApp:false
      });
      setMsg(msgEl,'Cuenta creada. Te enviamos el correo de verificaci√≥n.','ok');
    }catch(_){
      setMsg(msgEl,'Cuenta creada. No se pudo enviar autom√°ticamente. Usa ‚ÄúReenviar verificaci√≥n‚Äù.','err');
    }
    $('#verify-box').classList.remove('hidden');
    show('login');
  }catch(e){
    if (e.code==='auth/email-already-in-use') return setMsg(msgEl,'Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.','err');
    if (e.code==='auth/weak-password')        return setMsg(msgEl,'La contrase√±a es muy corta (m√≠nimo 6).','err');
    if (e.code==='auth/invalid-email')        return setMsg(msgEl,'El correo no es v√°lido.','err');
    setMsg(msgEl,'No se pudo registrar: ' + (e.message||''),'err');
  } finally {
    btn.disabled = false;
  }
}
$('#btn-register').addEventListener('click', handleRegister);
document.querySelector('#view-register').addEventListener('keydown', e=>{
  if(e.key==='Enter') { e.preventDefault(); handleRegister(); }
});

// ====== Verificaci√≥n & Logout ======
$('#btn-check-verify').onclick = async ()=>{
  const m=$('#verify-msg');
  try{ await auth.currentUser?.reload(); setMsg(m, auth.currentUser?.emailVerified ? '‚úÖ Verificado.' : 'A√∫n sin verificar.'); }
  catch(e){ setMsg(m,'Error: '+(e.message||''),'err'); }
};
$('#btn-resend-verify').onclick = async ()=>{
  const m=$('#verify-msg');
  try{ await auth.currentUser?.sendEmailVerification({url:'https://neylz21.github.io/CURSO-PEP-SOUL-MV/?verified=1',handleCodeInApp:false}); setMsg(m,'Enlace reenviado.','ok'); }
  catch(e){ setMsg(m,'No se pudo reenviar: '+(e.message||''),'err'); }
};
$('#btn-logout').onclick = ()=>auth.signOut().catch(()=>{});
</script>
</body>
</html>
