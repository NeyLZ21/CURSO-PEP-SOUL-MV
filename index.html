<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inducci√≥n a Soul MV ‚Ä¢ Hospital Vozandes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#781C38;
      --ink:#111827;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d;--warn:#b45309;--err:#b91c1c;
      --ring:#e5e7eb
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .container{max-width:980px;margin:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
    header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
    h1{font-size:clamp(22px,3.2vw,34px);margin:0}
    .subtitle{color:var(--muted);margin-top:4px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}

    /* Inputs y botones (unificados para que no ‚Äúcambien‚Äù entre pesta√±as) */
    input[type="text"],input[type="email"],input[type="password"]{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--ring);outline:none;
      transition: box-shadow .2s,border-color .2s; background:#fff;
    }
    input[type="text"]:focus,input[type="email"]:focus,input[type="password"]:focus{
      border-color:#d1d5db; box-shadow:0 0 0 4px rgba(120,28,56,.10);
    }
    .row{display:flex;gap:10px;align-items:center}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-muted{background:#e5e7eb;color:#111827}
    .btn-ok{background:var(--ok);color:#fff}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    /* Toggle pesta√±as */
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tab{padding:8px 12px;border-radius:999px;background:#f3f4f6;color:#111827;font-weight:600;cursor:pointer;border:1px solid #e5e7eb}
    .tab.active{background:var(--brand);color:#fff;border-color:transparent}
    .hint{color:var(--muted);font-size:12px}
    .msg{font-size:14px;margin-top:6px}
    .msg.ok{color:var(--ok)} .msg.err{color:var(--err)}
    .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:.7}
    .field{position:relative}

    /* Requisitos tarjeta */
    .warn-card{background:#fff7f7;border:1px dashed #fda4af}
    .yellow{background:#fffbeb;border:1px solid #fde68a}
    .top-right{margin-left:auto;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">HV</div>
      <div style="flex:1">
        <h1>Inducci√≥n a Soul MV</h1>
        <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
      </div>
      <div id="auth-chip" class="top-right"></div>
    </header>

    <!-- Acceso -->
    <section id="sec-auth" class="card">
      <div class="tabs">
        <button id="tab-login" class="tab active">Iniciar sesi√≥n</button>
        <button id="tab-reg" class="tab">Registrarme</button>
      </div>

      <!-- LOGIN -->
      <div id="pane-login">
        <div class="grid">
          <label>Correo electr√≥nico
            <input id="li-email" type="email" placeholder="usuario@dominio.com" autocomplete="username" required>
          </label>
          <label>Contrase√±a
            <div class="field">
              <input id="li-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
              <span class="eye" data-eye="li-pass">üëÅ</span>
            </div>
          </label>
          <div class="row">
            <button id="btn-login" class="btn btn-primary">Confirmar</button>
            <button id="btn-reset" class="btn btn-muted">Restablecer contrase√±a</button>
          </div>
          <div id="li-msg" class="msg"></div>
        </div>
      </div>

      <!-- REGISTRO -->
      <div id="pane-reg" style="display:none">
        <div class="grid cols-2">
          <label>Nombre y apellido (para certificado)
            <input id="rg-name" type="text" placeholder="Ej.: Mar√≠a P√©rez" required>
          </label>
          <label>Correo electr√≥nico
            <input id="rg-email" type="email" placeholder="usuario@dominio.com" autocomplete="username" required>
          </label>
        </div>
        <div class="grid cols-2">
          <label>Contrase√±a
            <div class="field">
              <input id="rg-pass" type="password" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password" required>
              <span class="eye" data-eye="rg-pass">üëÅ</span>
            </div>
            <div class="hint">M√≠nimo 6 caracteres</div>
          </label>
          <label>Confirmar contrase√±a
            <div class="field">
              <input id="rg-pass2" type="password" placeholder="Repite la contrase√±a" autocomplete="new-password" required>
              <span class="eye" data-eye="rg-pass2">üëÅ</span>
            </div>
          </label>
        </div>
        <div class="row">
          <button id="btn-register" class="btn btn-primary">Crear cuenta</button>
        </div>

        <div id="verify-box" class="card yellow" style="display:none;margin-top:12px">
          <strong>Verifica tu correo:</strong>
          <p class="hint" style="margin:.3rem 0 .6rem">Te enviamos un correo de verificaci√≥n. Confirma tu cuenta y luego pulsa el bot√≥n para volver a comprobar.</p>
          <div class="row">
            <button id="btn-check-verify" class="btn btn-ok">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
          <div id="verify-msg" class="msg"></div>
        </div>

        <div id="rg-msg" class="msg"></div>
      </div>

      <div class="card warn-card" style="margin-top:16px">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul style="margin:8px 0 0 18px">
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar el cuestionario</li>
          <li>Correo v√°lido (cualquier dominio) y verificado</li>
        </ul>
      </div>
    </section>

    <!-- PERFIL (solo cuando inicia y est√° verificado) -->
    <section id="sec-profile" class="card" style="display:none;margin-top:16px">
      <h2 style="margin:0 0 8px">Mi perfil</h2>
      <div class="grid cols-2">
        <label>Nombre completo (para certificado)
          <input id="pf-name" type="text" required>
        </label>
        <label>C√©dula o Pasaporte
          <input id="pf-id" type="text" required>
        </label>
        <label>Especialidad
          <input id="pf-spec" type="text" required>
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
        <button id="btn-logout" class="btn btn-muted" style="margin-left:auto">Cerrar sesi√≥n</button>
      </div>
      <div id="pf-msg" class="msg"></div>
    </section>

    <!-- marcador para que, al guardar perfil, puedas anclar tu secci√≥n de m√≥dulos -->
    <div id="modules" style="height:1px"></div>

    <div style="margin-top:24px;color:var(--muted);font-size:13px">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ======= RELLENA CON TU CONFIG DE FIREBASE =======
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      appId: "TU_APP_ID",
      messagingSenderId: "TU_SENDER_ID"
    };
    // ================================================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    // UI helpers
    function setTab(name){
      const isLogin = (name==='login');
      $('#tab-login').classList.toggle('active', isLogin);
      $('#tab-reg').classList.toggle('active', !isLogin);
      $('#pane-login').style.display = isLogin ? 'block':'none';
      $('#pane-reg').style.display   = !isLogin ? 'block':'none';
    }
    $('#tab-login').onclick = ()=> setTab('login');
    $('#tab-reg').onclick   = ()=> setTab('reg');

    // Eye toggles
    document.addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-eye');
      if(!id) return;
      const inp = byId(id);
      inp.type = (inp.type==='password')?'text':'password';
    });

    // A√±o
    $('#year').textContent = new Date().getFullYear();

    // ============ AUTH FLOW ============
    function showMsg(el, text, type=''){ const n=$(el); n.textContent=text; n.className='msg '+(type||''); }

    // Login (Confirmar)
    $('#btn-login').addEventListener('click', async ()=>{
      const email = ($('#li-email').value||'').trim();
      const pass  = ($('#li-pass').value||'').trim();
      if(!email || !pass){ return showMsg('#li-msg','Escribe correo y contrase√±a.','err'); }
      try{
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if(!methods || methods.length===0){
          return showMsg('#li-msg','Correo no registrado.','err');
        }
        await auth.signInWithEmailAndPassword(email, pass);
        showMsg('#li-msg','Sesi√≥n iniciada.','ok');
      }catch(e){
        showMsg('#li-msg','Error: '+(e?.message||'Intenta nuevamente.'),'err');
      }
    });

    // Reset pass
    $('#btn-reset').addEventListener('click', async ()=>{
      const email = ($('#li-email').value||'').trim();
      if(!email) return showMsg('#li-msg','Escribe tu correo para enviarte el enlace.','err');
      try{ await auth.sendPasswordResetEmail(email); showMsg('#li-msg','Hemos enviado el enlace para restablecer tu contrase√±a.','ok'); }
      catch(e){ showMsg('#li-msg','No se pudo enviar: '+e.message,'err'); }
    });

    // Registro
    $('#btn-register').addEventListener('click', async ()=>{
      const name = ($('#rg-name').value||'').trim();
      const email= ($('#rg-email').value||'').trim();
      const p1   = ($('#rg-pass').value||'').trim();
      const p2   = ($('#rg-pass2').value||'').trim();
      if(!name || !email || !p1 || !p2) return showMsg('#rg-msg','Completa todos los campos.','err');
      if(p1.length<6) return showMsg('#rg-msg','La contrase√±a debe tener al menos 6 caracteres.','err');
      if(p1!==p2)     return showMsg('#rg-msg','Las contrase√±as no coinciden.','err');

      try{
        const { user } = await auth.createUserWithEmailAndPassword(email, p1);
        await user.updateProfile({ displayName:name });
        // crea docs base
        await db.collection('users').doc(user.uid).set({ created: firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
        // Env√≠a verificaci√≥n autom√°ticamente
        await user.sendEmailVerification();
        $('#verify-box').style.display='block';
        showMsg('#rg-msg','Cuenta creada. Te enviamos un correo de verificaci√≥n.','ok');
      }catch(e){
        showMsg('#rg-msg','Error al registrar: '+e.message,'err');
      }
    });

    // Reenviar verif.
    $('#btn-resend-verify').addEventListener('click', async ()=>{
      try{
        if(auth.currentUser){ await auth.currentUser.sendEmailVerification(); showMsg('#verify-msg','Verificaci√≥n reenviada. Revisa tu correo.','ok'); }
      }catch(e){ showMsg('#verify-msg','No se pudo reenviar: '+e.message,'err'); }
    });

    // Ya verifiqu√©
    $('#btn-check-verify').addEventListener('click', async ()=>{
      try{
        await auth.currentUser.reload();
        if(auth.currentUser.emailVerified){
          showMsg('#verify-msg','¬°Correo verificado! Ya puedes iniciar sesi√≥n.','ok');
          // cambia a pesta√±a login y prellena email
          setTab('login');
          $('#li-email').value = auth.currentUser.email || '';
        }else{
          showMsg('#verify-msg','A√∫n no est√° verificado. Revisa tu correo.','err');
        }
      }catch(e){
        showMsg('#verify-msg','No se pudo comprobar: '+e.message,'err');
      }
    });

    // Cerrar sesi√≥n
    $('#btn-logout').addEventListener('click', async ()=>{
      await auth.signOut();
      // Deja activa la pesta√±a INICIAR SESI√ìN
      setTab('login');
      $('#auth-chip').textContent='';
      $('#sec-profile').style.display='none';
      $('#sec-auth').style.display='block';
      showMsg('#li-msg','Sesi√≥n cerrada.','ok');
    });

    // ============ PROFILE ============
    async function loadProfile(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      const snap = await db.collection('users').doc(uid).collection('profile').doc('main').get();
      if(snap.exists){
        const p = snap.data();
        $('#pf-name').value = p?.name || auth.currentUser.displayName || '';
        $('#pf-id').value   = p?.iddoc || '';
        $('#pf-spec').value = p?.spec || '';
      }else{
        $('#pf-name').value = auth.currentUser.displayName || '';
        $('#pf-id').value   = '';
        $('#pf-spec').value = '';
      }
    }

    async function saveProfile(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      const name = ($('#pf-name').value||'').trim();
      const iddoc= ($('#pf-id').value||'').trim();
      const spec = ($('#pf-spec').value||'').trim();
      if(!name || !iddoc || !spec) return showMsg('#pf-msg','Completa nombre, c√©dula/pasaporte y especialidad.','err');
      try{
        await db.collection('users').doc(uid).collection('profile').doc('main')
          .set({ name, iddoc, spec, updated: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        await auth.currentUser.updateProfile({ displayName:name });
        showMsg('#pf-msg','Perfil guardado.','ok');
        // Redirige a m√≥dulos/secci√≥n de curso (ajusta si tu ruta es distinta)
        location.hash = '#modules';
      }catch(e){ showMsg('#pf-msg','No se pudo guardar: '+e.message,'err'); }
    }
    $('#btn-save-profile').addEventListener('click', saveProfile);

    // ============ STATE ============
    auth.onAuthStateChanged(async (user)=>{
      // Si se lleg√≥ con ...?verified=1 (retorno del email link), muestra login y rellena
      if(new URLSearchParams(location.search).get('verified')==='1' && user){
        setTab('login');
        $('#li-email').value = user.email || '';
      }

      if(!user){
        // sin sesi√≥n
        $('#auth-chip').textContent='';
        setTab('login');
        $('#sec-auth').style.display='block';
        $('#sec-profile').style.display='none';
        return;
      }
      // con sesi√≥n
      $('#auth-chip').textContent = `${user.email} ${user.emailVerified?'(verificado)':'(no verificado)'}`;

      if(!user.emailVerified){
        // si no est√° verificado, quedarse en acceso
        $('#sec-auth').style.display='block';
        $('#sec-profile').style.display='none';
        // fuerza login tab y prellena email correcto
        setTab('login');
        $('#li-email').value = user.email || '';
        return;
      }

      // verificado ‚Üí mostrar perfil
      $('#sec-auth').style.display='none';
      $('#sec-profile').style.display='block';
      await loadProfile();
    });
  </script>
</body>
</html>
