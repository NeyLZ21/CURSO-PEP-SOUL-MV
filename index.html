<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inducci√≥n a PEP-SOUL MV ‚Ä¢ Hospital Vozandes</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- Acelera YouTube -->
<link rel="preconnect" href="https://www.youtube.com">
<link rel="preconnect" href="https://i.ytimg.com">
<link rel="dns-prefetch" href="https://www.youtube.com">
<link rel="dns-prefetch" href="https://i.ytimg.com">

<style>
:root{--brand:#781C38;--ink:#1f2937;--muted:#6b7280;--bg:#f8fafc;--card:#ffffff;--ok:#15803d}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:auto;padding:24px}
header{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
header .logo{width:48px;height:48px;border-radius:12px;background:var(--brand);display:grid;place-content:center;color:#fff;font-weight:800}
h1{font-size:clamp(22px,3.5vw,34px);margin:0}.subtitle{color:var(--muted);margin-top:4px}
.card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
button,.btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--brand);color:#fff}.btn-muted{background:#e5e7eb;color:#111827}.btn-success{background:var(--ok);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2ff;color:#3730a3}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:var(--brand);width:0}
.module{display:flex;gap:16px;align-items:flex-start}.module .num{flex:0 0 auto;width:36px;height:36px;border-radius:10px;background:#f3f4f6;display:grid;place-content:center;font-weight:700}.module .meta{flex:1}
.yt-wrap{position:relative;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000;margin-top:12px}
.yt-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.lock{position:absolute;inset:0;display:grid;place-content:center;background:rgba(17,24,39,.65);color:#fff;font-weight:700;font-size:14px;border-radius:16px;backdrop-filter:blur(1px)}
.muted{color:var(--muted)}
.footer{margin-top:24px;color:var(--muted);font-size:13px}

/* Certificado */
#certificado{display:none} #certificado.show{display:block}
@media print{.no-print{display:none !important} #certificado{display:block}}
.cert-card{background:#fff;border:4px solid var(--brand);border-radius:20px;padding:40px;text-align:center}
.cert-title{font-size:28px;font-weight:800;margin:0 0 10px;color:var(--brand)}
.cert-name{font-size:26px;font-weight:800;margin:8px 0}
.cert-meta{color:#374151;margin-top:10px}

/* Inputs */
.input-wrap{position:relative}
.input-wrap input, input, select{width:100%;padding:12px 40px 12px 12px;border-radius:12px;border:1px solid #e5e7eb}
select{appearance:none;background:#fff}
.eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;border:0;background:transparent;font-size:16px}

/* Avisos */
.alert{border-radius:12px;padding:12px 14px;font-size:14px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}

/* Guardando‚Ä¶ */
.saving::after{content:'';display:inline-block;width:14px;height:14px;margin-left:8px;border:2px solid #9ca3af;border-top-color:transparent;border-radius:999px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* P√≥ster lazy */
.poster{position:absolute;inset:0;background:#000;display:grid;place-items:center;cursor:pointer}
.poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.8)}
.poster button{position:relative;z-index:2;padding:10px 14px;border-radius:999px;background:#ffffffd9;font-weight:800;border:0}
.warnmsg{position:absolute;left:12px;right:12px;bottom:12px;background:#fff3cd;color:#7a5400;border-radius:10px;padding:8px 10px;font-size:13px;display:none}
</style>
</head>

<body>
<div class="container">
  <header class="no-print">
    <div class="logo">HVQ</div>
    <div style="flex:1">
      <h1>Inducci√≥n a Soul MV</h1>
      <div class="subtitle">Curso para nuevos m√©dicos ‚Ä¢ Hospital Vozandes</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="auth-user" class="muted" style="font-size:13px"></span>
      <button id="btn-logout" class="btn btn-muted" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Acceso -->
  <section id="step-welcome" class="card no-print">
    <div class="grid cols-2" style="align-items:start">
      <div>
        <h2 style="margin:0 0 6px">Acceso</h2>
        <p class="muted" style="margin:0 0 14px">Inicia sesi√≥n o reg√≠strate con tu correo y una contrase√±a. Tu progreso queda guardado en la nube.</p>

        <div class="grid" id="auth-forms">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-login" class="btn btn-primary">Iniciar sesi√≥n</button>
            <button id="tab-register" class="btn btn-muted">Registrarme</button>
          </div>

          <!-- LOGIN -->
          <div id="form-login">
            <label>Correo electr√≥nico<br>
              <input id="login-email" type="email" placeholder="usuario@dominio.com" required autocomplete="username email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                <button type="button" class="eye" data-eye="#login-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-primary" id="btn-login">Confirmar</button>
              <button class="btn" id="btn-reset" style="background:#e5e7eb">Restablecer contrase√±a</button>
            </div>
          </div>

          <!-- REGISTRO -->
          <div id="form-register" style="display:none">
            <label>Correo electr√≥nico<br>
              <input id="reg-email" type="email" placeholder="usuario@dominio.com" required autocomplete="email" autocapitalize="none" autocorrect="off" inputmode="email">
            </label>
            <label>Contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass" type="password" placeholder="M√≠nimo 6 caracteres" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass">üëÅÔ∏è</button>
              </div>
            </label>
            <label>Confirmar contrase√±a<br>
              <div class="input-wrap">
                <input id="reg-pass2" type="password" placeholder="Repite la contrase√±a" required autocomplete="new-password">
                <button type="button" class="eye" data-eye="#reg-pass2">üëÅÔ∏è</button>
              </div>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-muted" id="btn-register-2">Crear cuenta</button>
            </div>
          </div>

          <div id="auth-msg" class="muted" style="min-height:18px"></div>
        </div>

        <div id="verify-box" class="alert alert-warn" style="display:none;margin-top:10px">
          <strong>Verifica tu correo:</strong> te enviamos un email de verificaci√≥n. Conf√≠rmalo y vuelve a esta pantalla para continuar.
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-check-verify" class="btn btn-primary">Ya verifiqu√© mi correo</button>
            <button id="btn-resend-verify" class="btn btn-muted">Reenviar verificaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="background:#fff7f7;border:1px dashed #fda4af">
        <div class="badge"><span>‚ÑπÔ∏è</span> Requisitos</div>
        <ul>
          <li>Tener acceso a Internet</li>
          <li>Completar todos los videos para habilitar la evaluaci√≥n</li>
          <li>Correo v√°lido y verificado</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Perfil -->
  <section id="profile" class="card no-print" style="display:none;margin:18px 0">
    <h2 style="margin:0 0 8px">Mi perfil</h2>
    <p class="muted" id="pf-help">Completa todos los campos para habilitar los m√≥dulos.</p>
    <div class="grid cols-2">
      <label>Nombre completo (para certificado)<br><input id="pf-name" type="text" required></label>
      <label>C√©dula o Pasaporte<br><input id="pf-id" type="text" required></label>

      <label style="grid-column:1/-1">Especialidad<br>
        <select id="pf-spec"></select>
        <small class="muted">Selecciona de la lista. Esto define los m√≥dulos que ver√°s.</small>
      </label>
    </div>
    <div class="actions" style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-edit-profile" class="btn btn-muted" style="display:none">Modificar</button>
      <button id="btn-save-profile" class="btn btn-primary">Guardar perfil</button>
    </div>
    <div id="pf-msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- Progreso -->
  <section id="progress" class="no-print" style="display:none;margin:18px 0">
    <div class="card">
      <div class="grid cols-2" style="align-items:center">
        <div><strong>Progreso del curso</strong><div class="muted" id="progress-label">0% completado</div></div>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- M√≥dulos -->
  <section id="modules" class="grid no-print" style="display:none"></section>

  <!-- Certificado imprimible -->
  <section id="certificado" class="container">
    <div class="cert-card">
      <div class="cert-title">Certificado de participaci√≥n</div>
      <p>Otorgado a</p>
      <div class="cert-name" id="cert-nombre">Nombre Apellido</div>
      <p>por completar el curso <strong>Inducci√≥n a Soul MV</strong>.</p>
      <div class="cert-meta">
        <div id="cert-fecha"></div>
        <div>Hospital Vozandes ‚Ä¢ Formaci√≥n Interna</div>
      </div>
    </div>
  </section>

  <div class="footer no-print">¬© <span id="year"></span> Hospital Vozandes ‚Äî Inducci√≥n Soul MV</div>
</div>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* =============================== DATA =============================== */
const ESPECIALIDADES=[ "ACUPUNTURA","ALERGOLOGIA","ANESTESIOLOGIA","CARDIOLOGIA","CARDIOLOGIA HEMODINAMIA","CARDIOLOGIA INTERVENCIONISTA","CARDIOLOGIA PEDIATRICA","CIR. GENERAL-COLOPROCTOLOGIA","CIR. MANO/MU√ëE-NERVIO PERI/BRA","CIRUGIA CARDIACA","CIRUGIA DE CABEZA Y CUELLO","CIRUGIA DE COLUMNA","CIRUGIA DE HOMBRO Y CODO","CIRUGIA GENERAL","CIRUGIA ONCOLOGICA","CIRUGIA PEDIATRICA","CIRUGIA PLASTICA","CIRUGIA TORACICA","CIRUGIA VASCULAR","COLOPROCTOLOGIA","CUIDADOS PALIATIVOS","DERMATOLOGIA","DIABETOLOGIA","EMERGENCIAS Y DESASTRES","ENDOCRINO PEDIATRA","ENDOCRINOLOGIA","ENFERMEDADES AUTOINMUNES","FISIATRIA","FONOAUDIOLOGIA","GASTROENTEROLOGIA","GASTROENTEROLOGIA PEDIATRICA","GENETICA MEDICA","GERIATRIA","GINECOLOGIA INFANTO JUVENIL","GINECOLOGIA ONCOLOGICA","GINECOLOGIA Y OBSTETRICIA","HEMATOLOGIA","HEMATOLOGO ONCOLOGO PEDIATRIA","HEPATOLOGIA","INFECTOLOGIA","INFECTOLOGIA PEDIATRICA","INTERVENCIONISMO","MASTOLOGIA","MAXILO FACIAL","MEDICINA CRITICA","MEDICINA CRITICA PEDIATRICA","MEDICINA DEL DEPORTE","MEDICINA FAMILIAR","MEDICINA FAMILIAR EMERGENCIA","MEDICINA GENERAL","MEDICINA INTERNA","MEDICINA MATERNO FETAL","MEDICINA PALIATIVA","MICROBIOLOGIA","NEFROLOGIA","NEFROLOGIA PEDIATRICA","NEONATOLOGIA","NEUMOLOGIA","NEUMOLOGIA PEDIATRICA","NEUROCIRUGIA","NEUROFISIOLOGIA CLINICA","NEUROLOGIA","NEUROLOGIA PEDIATRICA","NEUROPSICOLOGIA","NEURORADIOL INTERVENCIONISTA","NEURORADIOLOGIA","NUTRICION","ODONTOLOGIA","ODONTOPEDIATRIA","OFTALMOLOGIA","OFTALMOLOGIA PEDIATRICA","ONCOLOGIA CLINICA","OTORRINOLARINGOLOGIA","PATOLOGIA","PEDIATRIA","PSICOLOGIA","PSIQUIATRIA","RADIOLOGIA","RADIOLOGIA INTERVENCIONISTA","RADIOTERAPIA","RESIDENTE/INTERNO","REUMATOLOGIA","REUMATOLOGIA PEDIATRICA","SEXOLOGIA","TRATAMIENTO DEL DOLOR","TRAUMATO PEDIATRICA DE COLUMNA","TRAUMATOLOGIA DEL COLUMNA","TRAUMATOLOGIA ONCOLOGICA","TRAUMATOLOGIA PEDIATRICA","TRAUMATOLOGIA Y ORTOPEDIA","UROLOGIA","UROLOGIA PEDIATRICA" ];

const M={ CE:"CONSULTA EXTERNA", H:"HOSPITALIZACI√ìN-HDD", CQ:"CENTRO QUIR√öRGICO", G:"GENERALIDADES", AN:"ANESTESIOLOG√çA", EM:"EMERGENCIAS" };
const BASE_MEDICA=[M.G,M.H,M.CE], BASE_QUIR=[M.G,M.H,M.CE,M.CQ];
const ESPEC_MODS={
  "ACUPUNTURA":BASE_MEDICA,"ALERGOLOGIA":BASE_MEDICA,"ANESTESIOLOGIA":[M.G,M.AN],
  "CARDIOLOGIA":BASE_MEDICA,"CARDIOLOGIA HEMODINAMIA":BASE_MEDICA,"CARDIOLOGIA INTERVENCIONISTA":BASE_MEDICA,"CARDIOLOGIA PEDIATRICA":BASE_MEDICA,
  "CIR. GENERAL-COLOPROCTOLOGIA":BASE_QUIR,"CIR. MANO/MU√ëE-NERVIO PERI/BRA":BASE_QUIR,"CIRUGIA CARDIACA":BASE_QUIR,"CIRUGIA DE CABEZA Y CUELLO":BASE_QUIR,"CIRUGIA DE COLUMNA":BASE_QUIR,"CIRUGIA DE HOMBRO Y CODO":BASE_QUIR,"CIRUGIA GENERAL":BASE_QUIR,"CIRUGIA ONCOLOGICA":BASE_QUIR,"CIRUGIA PEDIATRICA":BASE_QUIR,"CIRUGIA PLASTICA":BASE_QUIR,"CIRUGIA TORACICA":BASE_QUIR,"CIRUGIA VASCULAR":BASE_QUIR,"COLOPROCTOLOGIA":BASE_QUIR,
  "CUIDADOS PALIATIVOS":BASE_MEDICA,"DERMATOLOGIA":BASE_MEDICA,"DIABETOLOGIA":BASE_MEDICA,
  "EMERGENCIAS Y DESASTRES":[M.G,M.EM],"ENDOCRINO PEDIATRA":BASE_MEDICA,"ENDOCRINOLOGIA":BASE_MEDICA,
  "ENFERMEDADES AUTOINMUNES":BASE_MEDICA,"FISIATRIA":BASE_MEDICA,"FONOAUDIOLOGIA":BASE_MEDICA,
  "GASTROENTEROLOGIA":BASE_QUIR,"GASTROENTEROLOGIA PEDIATRICA":BASE_QUIR,"GENETICA MEDICA":BASE_MEDICA,"GERIATRIA":BASE_MEDICA,
  "GINECOLOGIA INFANTO JUVENIL":BASE_QUIR,"GINECOLOGIA ONCOLOGICA":BASE_QUIR,"GINECOLOGIA Y OBSTETRICIA":BASE_QUIR,
  "HEMATOLOGIA":BASE_QUIR,"HEMATOLOGO ONCOLOGO PEDIATRIA":BASE_QUIR,"HEPATOLOGIA":BASE_MEDICA,
  "INFECTOLOGIA":BASE_MEDICA,"INFECTOLOGIA PEDIATRICA":BASE_MEDICA,"INTERVENCIONISMO":BASE_QUIR,"MASTOLOGIA":BASE_QUIR,"MAXILO FACIAL":BASE_QUIR,
  "MEDICINA CRITICA":BASE_MEDICA,"MEDICINA CRITICA PEDIATRICA":BASE_MEDICA,"MEDICINA DEL DEPORTE":BASE_MEDICA,"MEDICINA FAMILIAR":[M.G,M.CE],"MEDICINA FAMILIAR EMERGENCIA":[M.G,M.EM],
  "MEDICINA GENERAL":BASE_MEDICA,"MEDICINA INTERNA":BASE_MEDICA,"MEDICINA MATERNO FETAL":BASE_MEDICA,"MEDICINA PALIATIVA":BASE_MEDICA,"MICROBIOLOGIA":BASE_MEDICA,
  "NEFROLOGIA":BASE_MEDICA,"NEFROLOGIA PEDIATRICA":BASE_MEDICA,"NEONATOLOGIA":BASE_MEDICA,"NEUMOLOGIA":BASE_MEDICA,"NEUMOLOGIA PEDIATRICA":BASE_MEDICA,
  "NEUROCIRUGIA":BASE_QUIR,"NEUROFISIOLOGIA CLINICA":BASE_MEDICA,"NEUROLOGIA":BASE_QUIR,"NEUROLOGIA PEDIATRICA":BASE_QUIR,"NEUROPSICOLOGIA":BASE_MEDICA,"NEURORADIOL INTERVENCIONISTA":BASE_QUIR,"NEURORADIOLOGIA":BASE_QUIR,
  "NUTRICION":BASE_MEDICA,"ODONTOLOGIA":BASE_QUIR,"ODONTOPEDIATRIA":BASE_QUIR,"OFTALMOLOGIA":BASE_QUIR,"OFTALMOLOGIA PEDIATRICA":BASE_QUIR,
  "ONCOLOGIA CLINICA":BASE_QUIR,"OTORRINOLARINGOLOGIA":BASE_QUIR,"PATOLOGIA":BASE_MEDICA,"PEDIATRIA":BASE_MEDICA,"PSICOLOGIA":BASE_MEDICA,"PSIQUIATRIA":BASE_MEDICA,
  "RADIOLOGIA":BASE_QUIR,"RADIOLOGIA INTERVENCIONISTA":BASE_QUIR,"RADIOTERAPIA":BASE_QUIR,"RESIDENTE/INTERNO":BASE_QUIR,
  "REUMATOLOGIA":BASE_MEDICA,"REUMATOLOGIA PEDIATRICA":BASE_MEDICA,"SEXOLOGIA":BASE_MEDICA,
  "TRATAMIENTO DEL DOLOR":BASE_QUIR,"TRAUMATO PEDIATRICA DE COLUMNA":BASE_QUIR,"TRAUMATOLOGIA DEL COLUMNA":BASE_QUIR,"TRAUMATOLOGIA ONCOLOGICA":BASE_QUIR,"TRAUMATOLOGIA PEDIATRICA":BASE_QUIR,"TRAUMATOLOGIA Y ORTOPEDIA":BASE_QUIR,
  "UROLOGIA":BASE_QUIR,"UROLOGIA PEDIATRICA":BASE_QUIR
};
const VIDEO_DEFAULTS={
  "GENERALIDADES":["dQw4w9WgXcQ","l482T0yNkeo","9bZkp7q19f0"],
  "HOSPITALIZACI√ìN-HDD":["eY52Zsg-KVI","fJ9rUzIMcZQ","L_jWHffIx5E"],
  "CONSULTA EXTERNA":["kXYiU_JCYtU","hTWKbfoikeg","QH2-TGUlwu4"],
  "CENTRO QUIR√öRGICO":["3JZ_D3ELwOQ","04854XqcfCY","ktvTqknDobU"],
  "ANESTESIOLOG√çA":["60ItHLz5WEA","CevxZvSJLk8","ktvTqknDobU"],
  "EMERGENCIAS":["2vjPBrBU-TM","hTWKbfoikeg","lWA2pjMjpBs"]
};
const DEFAULT_VIDEOS=["dQw4w9WgXcQ"];

/* =============================== Firebase =============================== */
const firebaseConfig={apiKey:"AIzaSyBSfmhvU6e778w7S6GQd3WDRFHF7wE0iZ8",authDomain:"induccion-pep-hvq.firebaseapp.com",projectId:"induccion-pep-hvq",storageBucket:"induccion-pep-hvq.firebasestorage.app",messagingSenderId:"651724182766",appId:"1:651724182766:web:4eec9be43e9e8e60dc0fff",measurementId:"G-Z62L1CCYP1"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
/* Persistencia offline para que los writes no se cuelguen en redes lentas */
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

/* =============================== Estado / helpers =============================== */
const $=s=>document.querySelector(s);
$('#year').textContent=new Date().getFullYear();

const MSGS={
 'auth/email-already-in-use':'Ese correo ya tiene una cuenta. Usa Iniciar sesi√≥n.',
 'auth/invalid-email':'El formato del correo no es v√°lido.',
 'auth/missing-email':'Ingresa tu correo.',
 'auth/missing-password':'Ingresa tu contrase√±a.',
 'auth/weak-password':'La contrase√±a es muy corta (m√≠nimo 6).',
 'auth/user-not-found':'Correo no registrado.',
 'auth/wrong-password':'Contrase√±a incorrecta.',
 'auth/invalid-credential':'Contrase√±a incorrecta.',
 'auth/invalid-login-credentials':'Contrase√±a incorrecta.',
 'auth/too-many-requests':'Demasiados intentos. Intenta m√°s tarde.',
 'auth/network-request-failed':'Error de red. Revisa tu conexi√≥n.'
};
const msg=t=>{const el=$('#auth-msg'); if(el) el.textContent=t||'';};
const emailOk=e=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||'').trim().toLowerCase());

let CURRENT_UID=null;
const keyFor=uid=>`soulmv_${uid||'anon'}`;
const loadState=uid=>{try{return JSON.parse(localStorage.getItem(keyFor(uid))||'{}');}catch{return {}}};
const saveStateLocal=(uid,st)=>localStorage.setItem(keyFor(uid),JSON.stringify(st));
let state=loadState(null);
let unsubProfile=null;
let savingProfile=false;

/* =============================== YouTube control =============================== */
let ytApiReady=false;
const players={};                 // pid -> {player,meta}
const cfgByPid=new Map();
let lastPlayingPid=null;

function ytThumb(id){ return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`; }
function makePoster(pid, videoId, lockedMsg){
  const lockLayer = lockedMsg ? `<div class="lock" id="lock-${pid}">üîí ${lockedMsg}</div>` : '';
  return `
    <div class="yt-wrap" style="margin-top:8px">
      <div id="${pid}"></div>
      <div class="poster" data-load="${pid}">
        <img src="${ytThumb(videoId)}" alt="">
        <button type="button">Ver video ‚ñ∂</button>
      </div>
      ${lockLayer}
      <div class="warnmsg" id="warn-${pid}"></div>
    </div>`;
}

function prevModuleConcluded(moduleId){
  const mods = state.course?.modules || [];
  const idx = mods.findIndex(m=>m.id===moduleId);
  if(idx<=0) return true;
  const prev = mods[idx-1];
  const passed = !!(state.quizzes?.[prev.id]?.passed);
  const allVideosDone = prev.videos.every(v => (state.videosDone?.[prev.id]||{})[v.yt]);
  return passed || allVideosDone;
}

function ensureStoreFor(mid,vid){
  state.play=state.play||{};
  state.play[mid]=state.play[mid]||{};
  state.play[mid][vid]=state.play[mid][vid]||{t:0,allow:0,dur:0};
  return state.play[mid][vid];
}
function persist(){ saveStateLocal(CURRENT_UID,state); }

function clickToLoad(pid){
  const cfg=cfgByPid.get(pid); if(!cfg) return;
  if(isLocked(cfg)){ showWarn(pid, lockReason(cfg)); return; }
  if(players[pid]) return;
  actuallyCreatePlayer(cfg);
  const poster=document.querySelector(`.poster[data-load="${pid}"]`);
  if(poster) poster.remove();
}
function isLocked({moduleId,index}){
  if(index===0 && !prevModuleConcluded(moduleId)) return true;
  if(index>0){
    const m=(state.course?.modules||[]).find(mm=>mm.id===moduleId);
    const prevId=m?.videos[index-1]?.yt;
    return !((state.videosDone?.[moduleId]||{})[prevId]);
  }
  return false;
}
function lockReason({moduleId,index}){
  if(index===0 && !prevModuleConcluded(moduleId)) return 'Primero concluye el m√≥dulo anterior';
  return 'Termina el video anterior';
}
function showWarn(pid, text){
  const w=document.getElementById(`warn-${pid}`); if(!w) return;
  w.textContent=text; w.style.display='block';
  setTimeout(()=>{ if(w) w.style.display='none'; },1700);
}

function actuallyCreatePlayer({pid,videoId,moduleId,index}){
  if(players[pid]) return;
  const store=ensureStoreFor(moduleId,videoId);
  const meta={pid,videoId,moduleId,index,tick:null,retries:0};
  players[pid]={player:null,meta};

  const holder=document.getElementById(pid); if(!holder) return;

  players[pid].player=new YT.Player(pid,{
    height:'360',width:'640',videoId,
    playerVars:{rel:0,modestbranding:1,controls:1,disablekb:1,playsinline:1},
    events:{
      onReady:(ev)=>{
        try{
          const ifr=holder.querySelector('iframe');
          if(ifr) ifr.setAttribute('allow','autoplay; fullscreen; encrypted-media; picture-in-picture');
          ev.target.unMute(); ev.target.setVolume(100);
        }catch(_){}
        const startAt=Math.min(store.t||0,store.allow||0);
        if(startAt>1){ try{ev.target.seekTo(startAt,true);}catch(_){ } }
      },
      onStateChange:(ev)=>{
        const p=ev.target, st=ev.data;
        if(st===YT.PlayerState.PLAYING){
          lastPlayingPid=pid;
          if(isLocked(meta)){
            showWarn(pid, lockReason(meta));
            try{p.pauseVideo();}catch(_){}
            return;
          }
          startTick();
        }else if(st===YT.PlayerState.PAUSED){
          persist();
        }else if(st===YT.PlayerState.ENDED){
          stopTick();
          state.videosDone=state.videosDone||{};
          state.videosDone[moduleId]=state.videosDone[moduleId]||{};
          state.videosDone[moduleId][videoId]=true;
          store.allow=store.dur||store.allow;
          store.t=store.allow;
          persist();
          const nextPid=`player-${moduleId}-${index+1}`;
          const nextLock=document.getElementById(`lock-${nextPid}`); if(nextLock) nextLock.remove();
          updateGlobalProgress();
          const m=(state.course?.modules||[]).find(mm=>mm.id===moduleId);
          maybeEnableQuiz({id:moduleId,videos:m?.videos||[]});
        }
      },
      onError:()=>{
        if(meta.retries<3){
          meta.retries++;
          setTimeout(()=>{
            try{ players[pid]?.player?.destroy?.(); }catch(_){}
            delete players[pid];
            actuallyCreatePlayer({pid,videoId,moduleId,index});
          }, 600*meta.retries);
        }else{
          const w=document.getElementById(`warn-${pid}`);
          if(w){ w.textContent='No se pudo cargar el video. Recarga la p√°gina.'; w.style.display='block'; }
        }
      }
    }
  });

  function startTick(){
    stopTick();
    meta.tick=setInterval(()=>{
      const inst=players[pid]; if(!inst) return;
      const p=inst.player;
      let cur=0,dur=0,st;
      try{ cur=p.getCurrentTime?.()||0; dur=p.getDuration?.()||0; st=p.getPlayerState?.(); }catch(_){}
      if(dur && (!store.dur || Math.abs(store.dur-dur)>0.5)){ store.dur=dur; persist(); }
      if(cur>(store.allow+1.0)){ try{ p.seekTo(store.allow,true); }catch(_){ } return; }
      if(st===YT.PlayerState.PLAYING){
        if(cur>store.allow) store.allow=cur;
        store.t=cur;
      }else{
        store.t=cur;
      }
    },500);
  }
  function stopTick(){ if(meta.tick){ clearInterval(meta.tick); meta.tick=null; } }
}

/* Pausar al salir de la pesta√±a y reanudar sin adelantar */
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    Object.values(players).forEach(({player})=>{ try{player.pauseVideo();}catch(_){ } });
    persist();
  }else{
    if(lastPlayingPid && players[lastPlayingPid]?.player){
      try{ players[lastPlayingPid].player.playVideo(); }catch(_){}
    }
  }
});
window.addEventListener('pagehide', persist);
window.addEventListener('beforeunload', persist);
window.onYouTubeIframeAPIReady=()=>{ ytApiReady=true; };

/* =============================== Auth =============================== */
document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click',()=>{ const inp=document.querySelector(btn.dataset.eye); if(!inp) return; inp.type=inp.type==='password'?'text':'password'; });
});
function setTab(which){
  const onLogin=(which==='login');
  $('#form-login').style.display=onLogin?'block':'none';
  $('#form-register').style.display=onLogin?'none':'block';
  $('#tab-login').classList.toggle('btn-primary',onLogin);
  $('#tab-login').classList.toggle('btn-muted',!onLogin);
  $('#tab-register').classList.toggle('btn-primary',!onLogin);
  $('#tab-register').classList.toggle('btn-muted',onLogin);
}
$('#tab-login').addEventListener('click',()=>setTab('login'));
$('#tab-register').addEventListener('click',()=>setTab('reg'));
setTab('login');

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    CURRENT_UID=null; state={}; $('#auth-user').textContent=''; $('#btn-logout').style.display='none'; $('#verify-box').style.display='none'; setTab('login'); showLogin();
    if (unsubProfile) { try{unsubProfile();}catch(_){ } unsubProfile=null; }
    return;
  }
  CURRENT_UID=user.uid; state=loadState(CURRENT_UID)||{}; $('#auth-user').textContent=user.email||'';
  try{ await user.reload(); }catch(_){}
  if(!user.emailVerified){ showLogin(); $('#verify-box').style.display='block'; return; }
  $('#verify-box').style.display='none';
  showCourse();
  syncFromCloud(user).catch(()=>{});
});

document.getElementById('btn-register-2').addEventListener('click', async ()=>{
  const email=($('#reg-email').value||'').trim().toLowerCase();
  const pass=($('#reg-pass').value||'').trim();
  const pass2=($('#reg-pass2').value||'').trim();
  if(!email||!pass||!pass2) return msg('Completa todos los campos.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  if(pass!==pass2) return msg('Las contrase√±as no coinciden.');

  try{
    const methods=await auth.fetchSignInMethodsForEmail(email);
    if(methods&&methods.length){ setTab('login'); $('#login-email').value=email; return msg('Ese correo ya tiene cuenta. Usa Iniciar sesi√≥n.'); }
    const {user}=await auth.createUserWithEmailAndPassword(email,pass);
    if(auth.currentUser?.uid!==user.uid) await auth.updateCurrentUser(user);
    db.collection('users').doc(user.uid).collection('courses').doc('soulmv').set({}, {merge:true}).catch(()=>{});
    const url=location.origin+location.pathname+'?verified=1';
    const acs={url,handleCodeInApp:false};
    try{ await auth.currentUser.sendEmailVerification(acs); msg('Te enviamos el correo de verificaci√≥n (revisa Spam).'); }
    catch(_){ msg('No se pudo enviar autom√°ticamente. Usa ‚ÄúReenviar verificaci√≥n‚Äù.'); }
    $('#verify-box').style.display='block'; setTab('login'); $('#login-email').value=email;
  }catch(e){ msg(MSGS[e.code]||'Ocurri√≥ un error. Intenta nuevamente.'); }
});

document.getElementById('btn-check-verify').addEventListener('click', async ()=>{
  if(auth.currentUser){ await auth.currentUser.reload(); if(auth.currentUser.emailVerified){ $('#verify-box').style.display='none'; showCourse(); } }
});
document.getElementById('btn-resend-verify').addEventListener('click', async ()=>{
  try{
    const url=location.origin+location.pathname+'?verified=1';
    const acs={url,handleCodeInApp:false};
    if(auth.currentUser){ await auth.currentUser.sendEmailVerification(acs); msg('Te enviamos el correo de verificaci√≥n (revisa Spam).'); }
    else { msg('Primero inicia sesi√≥n.'); }
  }catch(e){ msg(MSGS[e.code]||'No se pudo enviar.'); }
});
document.getElementById('btn-login').addEventListener('click', async ()=>{
  const email=($('#login-email').value||'').trim().toLowerCase();
  const pass=($('#login-pass').value||'').trim();
  if(!email||!pass) return msg('Ingresa correo y contrase√±a.');
  if(!emailOk(email)) return msg('El formato del correo no es v√°lido.');
  const btn=$('#btn-login'); btn.disabled=true;
  try{
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    const u=cred.user||auth.currentUser; await u.reload().catch(()=>{});
    if(!u.emailVerified){ msg('Debes verificar tu correo antes de continuar.'); $('#verify-box').style.display='block'; return; }
    msg('Sesi√≥n iniciada.'); $('#verify-box').style.display='none';
    showCourse(); syncFromCloud(u).catch(()=>{});
  }catch(e){
    let methods=[]; try{methods=await auth.fetchSignInMethodsForEmail(email);}catch(_){}
    if(!methods||methods.length===0){ msg('Correo no registrado.'); setTab('reg'); $('#reg-email').value=email; }
    else if(['auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(e.code)){ msg('Contrase√±a incorrecta.'); }
    else if(e.code==='auth/too-many-requests'){ msg('Demasiados intentos. Intenta m√°s tarde.'); }
    else if(e.code==='auth/invalid-email'){ msg('El formato del correo no es v√°lido.'); }
    else{ msg(MSGS[e.code]||'Ocurri√≥ un error. Intenta nuevamente.'); }
  }finally{ btn.disabled=false; }
});
document.getElementById('btn-logout').addEventListener('click', async ()=>{ await auth.signOut(); msg('Sesi√≥n cerrada.'); });

/* =============================== Vistas / Perfil =============================== */
function buildSpecOptions(sel){
  sel.innerHTML = `<option value="" disabled selected>Selecciona tu especialidad‚Ä¶</option>` +
    ESPECIALIDADES.map(s=>`<option value="${s}">${s}</option>`).join('');
}
buildSpecOptions(document.getElementById('pf-spec'));

function showCourse(){
  if(!auth.currentUser) return;
  if(!auth.currentUser.emailVerified){ showLogin(); $('#verify-box').style.display='block'; return; }

  $('#step-welcome').style.display='none';
  $('#btn-logout').style.display='inline-flex';
  $('#profile').style.display='block';

  const name = state.profile?.name || auth.currentUser?.displayName || '';
  $('#pf-name').value=name;
  $('#pf-id').value=state.profile?.iddoc||'';
  $('#pf-spec').value=ESPECIALIDADES.includes(state.profile?.spec||'') ? state.profile.spec : '';

  setProfileReadonly(!name || !state.profile?.iddoc || !state.profile?.spec ? false : true);
  $('#pf-help').textContent = (profileComplete() ? 'Puedes actualizar tus datos cuando quieras.' : 'Completa todos los campos para habilitar los m√≥dulos.');

  renderAllBySpecialty(getSpecialty());
  updateGlobalProgress();
  startProfileRealtime();
  loadProfile().then(()=>{
    $('#pf-spec').value=ESPECIALIDADES.includes(state.profile?.spec||'') ? state.profile.spec : '';
    renderAllBySpecialty(getSpecialty()); updateGlobalProgress();
    if(profileComplete()) setProfileReadonly(true);
  }).catch(()=>{});
}
function showLogin(){ $('#step-welcome').style.display='block'; $('#profile').style.display='none'; $('#progress').style.display='none'; $('#modules').style.display='none'; }
function profileComplete(){ const p=state.profile||{}; return !!(p.name&&p.iddoc&&p.spec&&ESPECIALIDADES.includes(p.spec)); }
function setProfileReadonly(ro){
  ['pf-name','pf-id','pf-spec'].forEach(id=>{
    const el=document.getElementById(id);
    el.disabled=ro; el.style.background=ro?'#eef2ff':'#fff';
  });
  $('#btn-edit-profile').style.display=ro?'inline-flex':'none';
  $('#btn-save-profile').style.display=ro?'none':'inline-flex';
}
document.getElementById('btn-edit-profile').addEventListener('click',()=>{
  setProfileReadonly(false); $('#pf-help').textContent='Edita tus datos y guarda los cambios.';
});
function getSpecialty(){ return (state.profile?.spec||'').trim(); }

function startProfileRealtime(){
  if (unsubProfile) { try{unsubProfile();}catch(_){ } unsubProfile=null; }
  const uid=auth.currentUser?.uid; if(!uid) return;
  const ref=db.collection('users').doc(uid).collection('profile').doc('main');
  unsubProfile=ref.onSnapshot((snap)=>{
    if(!snap.exists) return;
    const cloud=snap.data()||{}; const prevSpec=state.profile?.spec;
    state.profile={...state.profile,...cloud}; persist();
    if(document.getElementById('pf-name').disabled){
      $('#pf-name').value=state.profile?.name||auth.currentUser?.displayName||'';
      $('#pf-id').value=state.profile?.iddoc||'';
      $('#pf-spec').value=ESPECIALIDADES.includes(state.profile?.spec||'') ? state.profile.spec : '';
    }
    if(prevSpec!==state.profile?.spec && ESPECIALIDADES.includes(state.profile?.spec||'')){
      renderAllBySpecialty(state.profile.spec); updateGlobalProgress();
    }
    if(savingProfile){
      savingProfile=false;
      const pfMsg=$('#pf-msg'); pfMsg.classList.remove('saving'); pfMsg.textContent='‚úÖ Perfil guardado.';
      setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; },2500);
      setProfileReadonly(true);
    }
  });
}
async function loadProfile(){
  try{
    const uid=auth.currentUser?.uid; if(!uid) return;
    const s=await db.collection('users').doc(uid).collection('profile').doc('main').get();
    if(s.exists){
      state.profile=s.data(); persist();
      $('#pf-name').value=state.profile?.name||auth.currentUser?.displayName||'';
      $('#pf-id').value=state.profile?.iddoc||'';
      $('#pf-spec').value=ESPECIALIDADES.includes(state.profile?.spec||'') ? state.profile.spec : '';
    }
  }catch(e){ console.warn('Perfil no disponible',e); }
}
async function saveProfile(){
  const name=($('#pf-name').value||'').trim();
  const iddoc=($('#pf-id').value||'').trim();
  const spec=($('#pf-spec').value||'').trim();
  const pfMsg=$('#pf-msg'); const btn=$('#btn-save-profile');

  if(!name||!iddoc||!spec){ pfMsg.textContent='Completa nombre, c√©dula/pasaporte y especialidad.'; return; }
  if(!ESPECIALIDADES.includes(spec)){ pfMsg.textContent='Selecciona una especialidad v√°lida de la lista.'; return; }

  state.profile={name,iddoc,spec}; persist();
  renderAllBySpecialty(spec); updateGlobalProgress();
  document.getElementById('modules')?.scrollIntoView({behavior:'smooth',block:'start'});

  pfMsg.classList.add('saving'); pfMsg.textContent='Guardando‚Ä¶'; btn.disabled=true; savingProfile=true;

  // Watchdog anti-colgado
  const watchdog=setTimeout(()=>{
    if(!savingProfile) return;
    savingProfile=false; pfMsg.classList.remove('saving');
    pfMsg.textContent='Guardado local (posible red lenta). Intenta nuevamente cuando tengas internet.';
    btn.disabled=false;
  }, 10000);

  try{
    if(name){ try{ await auth.currentUser.updateProfile({displayName:name}); }catch(_){ } }
    const uid=auth.currentUser?.uid; if(!uid) throw new Error('Sin UID');
    const ref=db.collection('users').doc(uid).collection('profile').doc('main');
    const payload={...state.profile,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    await ref.set(payload,{merge:true});
    clearTimeout(watchdog);
    savingProfile=false; pfMsg.classList.remove('saving'); pfMsg.textContent='‚úÖ Perfil guardado.'; setProfileReadonly(true);
    setTimeout(()=>{ if(pfMsg.textContent.includes('‚úÖ')) pfMsg.textContent=''; },2500);
  }catch(e){
    clearTimeout(watchdog);
    savingProfile=false; pfMsg.classList.remove('saving'); pfMsg.textContent='No se pudo guardar en la nube; tus datos quedan localmente.'; setProfileReadonly(false);
  }finally{ btn.disabled=false; }
}
document.getElementById('btn-save-profile').addEventListener('click',saveProfile);

/* =============================== Render m√≥dulos / videos =============================== */
function mkModule(id,titulo,ytIds){
  const vids=(ytIds&&ytIds.length?ytIds:DEFAULT_VIDEOS).slice(0,5).map((v,i)=>({yt:v,dur:'08:00',n:i+1}));
  const quiz=[
    {id:`${id}-q1`,text:'Pregunta 1 del m√≥dulo',options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'A'},
    {id:`${id}-q2`,text:'Pregunta 2 del m√≥dulo',options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'B'},
    {id:`${id}-q3`,text:'Pregunta 3 del m√≥dulo',options:[{key:'A',label:'Opci√≥n A'},{key:'B',label:'Opci√≥n B'},{key:'C',label:'Opci√≥n C'}],correct:'B'}
  ];
  return {id,titulo,videos:vids,quiz};
}
function pickModulesFor(spec){
  const wanted=ESPEC_MODS[spec]||[M.G];
  return wanted.map((titulo,idx)=>{
    const ids=VIDEO_DEFAULTS[titulo]||DEFAULT_VIDEOS;
    const mId=`${titulo.toLowerCase().replace(/\s+/g,'-')}-${idx+1}`;
    return mkModule(mId,titulo,ids);
  });
}
function renderAllBySpecialty(spec){
  const useSpec=spec||'MEDICINA INTERNA';
  const modulesDef=pickModulesFor(useSpec);
  state.course={spec:useSpec,modules:modulesDef}; persist();

  $('#progress').style.display='block'; $('#modules').style.display='grid';
  renderModules(modulesDef); updateGlobalProgress();
}
function renderModules(modulesDef){
  // destruye players previos
  Object.keys(players).forEach(k=>{
    try{ players[k]?.player?.stopVideo?.(); players[k]?.player?.destroy?.(); }catch(_){}
    delete players[k];
  });
  cfgByPid.clear();

  const wrap=$('#modules'); wrap.innerHTML='';
  modulesDef.forEach((m,modIdx)=>{
    const doneVideos=(state.videosDone?.[m.id]||{});
    const firstLockedMsg = modIdx===0 ? null : (prevModuleConcluded(m.id) ? null : 'Primero concluye el m√≥dulo anterior');

    const videosHtml=m.videos.map((v,i)=>{
      const pid=`player-${m.id}-${i}`;
      const locked=(i===0)?!!firstLockedMsg:!doneVideos[m.videos[i-1].yt];
      const lockedMsg=locked?((i===0&&firstLockedMsg)?firstLockedMsg:'Termina el video anterior'):null;
      cfgByPid.set(pid,{pid,videoId:v.yt,moduleId:m.id,index:i});
      return makePoster(pid, v.yt, lockedMsg);
    }).join('');

    const canStart=m.videos.every(v=>doneVideos[v.yt]);
    const passed=state.quizzes?.[m.id]?.passed;
    const quizBtnLabel=passed?'Aprobado ‚úì':'Comenzar evaluaci√≥n';
    const quizBtnClass=passed?'btn-success':'btn-primary';
    const quizDisabled=canStart?'':'disabled';
    const quizHint=canStart?'Listo para evaluar':'Completa los videos para habilitar';

    const card=document.createElement('article');
    card.className='card module';
    card.innerHTML=`
      <div class="num">${modIdx+1}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <h3 style="margin:0">${m.titulo}</h3>
          <span class="badge">${m.videos.length} videos</span>
        </div>
        <p class="muted" style="margin:6px 0 10px">Debes ver cada video completo (sin adelantar) para habilitar la evaluaci√≥n.</p>
        ${videosHtml}
        <div class="quiz-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div class="quiz-hint muted" id="hint-${m.id}">${quizHint}</div>
            <button class="btn ${quizBtnClass}" id="btn-${m.id}" ${quizDisabled}>${quizBtnLabel}</button>
          </div>
          <div id="quiz-${m.id}" style="display:none;margin-top:12px"></div>
          <div class="muted" id="res-${m.id}" style="display:none;margin-top:8px"></div>
        </div>
      </div>`;
    wrap.appendChild(card);

    // click en cada p√≥ster
    m.videos.forEach((v,i)=>{
      const pid=`player-${m.id}-${i}`;
      const poster=card.querySelector(`[data-load="${pid}"]`);
      poster?.addEventListener('click',()=>clickToLoad(pid));
      poster?.querySelector('button')?.addEventListener('click',e=>{ e.stopPropagation(); clickToLoad(pid); });
    });

    document.getElementById(`btn-${m.id}`).addEventListener('click',()=>{
      if(state.quizzes?.[m.id]?.passed) return;
      renderQuizForModule(m);
    });
  });
}

/* =============================== Quiz / progreso =============================== */
function maybeEnableQuiz(m){
  const canStart=m.videos.every(v=>(state.videosDone?.[m.id]||{})[v.yt]);
  const btn=document.querySelector(`#btn-${m.id}`), hint=document.querySelector(`#hint-${m.id}`);
  if(btn&&hint){ btn.disabled=!canStart; hint.textContent=canStart?'Listo para evaluar':'Completa los videos para habilitar'; }
}
function renderQuizForModule(m){
  const wrap=document.querySelector(`#quiz-${m.id}`); wrap.innerHTML='';
  m.quiz.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.marginBottom='8px';
    const opts=q.options.map(o=>`
      <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
        <input type="radio" name="${q.id}" value="${o.key}"> <span>${o.key}) ${o.label}</span>
      </label>`).join('');
    card.innerHTML=`<strong>${idx+1}. ${q.text}</strong><div style="margin-top:6px">${opts}</div>`;
    wrap.appendChild(card);
  });
  const submit=document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Enviar evaluaci√≥n';
  submit.addEventListener('click',()=>gradeQuizModule(m));
  wrap.appendChild(submit); wrap.style.display='block';
}
function gradeQuizModule(m){
  let correct=0; m.quiz.forEach(q=>{ const c=document.querySelector(`input[name="${q.id}"]:checked`); if(c && c.value===q.correct) correct++; });
  const PASS_PCT=80; const scorePct=Math.round((correct/m.quiz.length)*100);
  state.quizzes=state.quizzes||{}; state.quizzes[m.id]={correct,total:m.quiz.length,scorePct,passed:scorePct>=PASS_PCT}; persist();
  const res=document.querySelector(`#res-${m.id}`); res.style.display='block';
  res.textContent=`Resultado: ${correct}/${m.quiz.length} (${scorePct}%). ${state.quizzes[m.id].passed?'‚úÖ Aprobado':'‚ùå No aprobado'}.`;
  if(state.quizzes[m.id].passed){
    const btn=document.querySelector(`#btn-${m.id}`);
    if(btn){ btn.textContent='Aprobado ‚úì'; btn.classList.remove('btn-primary'); btn.classList.add('btn-success'); }
    setTimeout(syncToCloud,300);
  }
}
function updateGlobalProgress(){
  const spec=getSpecialty()||'MEDICINA INTERNA';
  const modulesDef=pickModulesFor(spec);
  const totalVideos=modulesDef.reduce((a,m)=>a+m.videos.length,0);
  const doneVideos=modulesDef.reduce((a,m)=>a + m.videos.filter(v=>(state.videosDone?.[m.id]||{})[v.yt]).length,0);
  const pct=totalVideos? Math.round((doneVideos/totalVideos)*100) : 0;
  $('#progress').style.display='block'; $('#modules').style.display='grid';
  $('#bar').style.width=pct+'%';
  const evalsPassed=modulesDef.filter(m=> state.quizzes?.[m.id]?.passed).length;
  const allPassed=modulesDef.every(m=> state.quizzes?.[m.id]?.passed);
  const labelExtra = `‚Ä¢ Evaluaciones ${evalsPassed}/${modulesDef.length}${allPassed?' ‚Ä¢ ‚úÖ Listo para certificar':''}`;
  $('#progress-label').textContent=`${pct}% completado ‚Äî Videos ${doneVideos}/${totalVideos} ${labelExtra}`;
  if(allPassed){
    const preferName = state.profile?.name || auth.currentUser?.displayName || '';
    document.getElementById('cert-nombre').textContent = preferName;
    const f=new Date(); const fecha=f.toLocaleDateString('es-EC',{year:'numeric',month:'long',day:'numeric'});
    document.getElementById('cert-fecha').textContent=`Fecha: ${fecha}`;
    document.getElementById('certificado').classList.add('show');
  }
}

/* =============================== Cloud sync =============================== */
async function userDoc(){ const uid=auth.currentUser?.uid; if(!uid) return null; return db.collection('users').doc(uid).collection('courses').doc('soulmv'); }
async function syncFromCloud(user){
  try{
    const ref=await userDoc(); if(!ref) return;
    const snap=await ref.get();
    if(snap.exists){
      const cloud=snap.data()||{};
      state.videosDone={...(state.videosDone||{}),...(cloud.videosDone||{})};
      state.quizzes={...(state.quizzes||{}),...(cloud.quizzes||{})};
      state.play={...(state.play||{}),...(cloud.play||{})};
      persist();
    }
    const psnap=await db.collection('users').doc(user.uid).collection('profile').doc('main').get();
    if(psnap.exists){ state.profile={...(state.profile||{}),...(psnap.data()||{})}; persist(); }
  }catch(e){ console.warn('No se pudo leer progreso/perfil',e); }
}
async function syncToCloud(){
  try{
    const ref=await userDoc(); if(!ref) return;
    const payload={ videosDone: state.videosDone||{}, quizzes: state.quizzes||{}, play: state.play||{} };
    await ref.set(payload,{merge:true});
    const uid=auth.currentUser?.uid;
    if(uid && state.profile){ await db.collection('users').doc(uid).collection('profile').doc('main').set(state.profile,{merge:true}); }
  }catch(e){ console.warn('No se pudo guardar en la nube',e); }
}

/* =============================== Init =============================== */
document.getElementById('year').textContent=new Date().getFullYear();
function showLogin(){ $('#step-welcome').style.display='block'; $('#profile').style.display='none'; $('#progress').style.display='none'; $('#modules').style.display='none'; }
</script>
</body>
</html>
